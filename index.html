<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>학습 장소 현황판</title>
    
    <link rel="stylesheet" crossorigin href="./style.css">
    <script type="module" crossorigin src="./script.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
      /* [1. 기본 설정] */
      #snow-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9998; pointer-events: none; }
      .form, .notice, .aside-announcement, ul.notice-ul { display: none !important; }

      /* [2. 고급 기능 사이드바] */
      #advanced-features-container {
          margin-top: 15px; margin-bottom: 20px; padding: 10px;
          background: rgba(30, 32, 37, 0.6); border-radius: 12px;
          border: 1px solid #333; animation: fadeIn 0.8s ease;
      }
      .feature-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 5px 10px; color: #ffff; font-weight: 700; user-select: none; }
      .feature-list { display: none; flex-direction: column; gap: 8px; margin-top: 12px; padding: 0 5px; }
      .feature-list.active { display: flex; }
      .feature-btn { background: #2a2d35; border: 1px solid #444; color: #ffff; padding: 8px 12px; border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 8px; }
      .feature-btn:hover { background: #333; border-color: #666; }

      /* [3. 인라인 BGM 리스트] */
      #inline-bgm-container { display: none; margin-top: 10px; background: #15171c; border-radius: 8px; border: 1px solid #444; overflow: hidden; max-height: 200px; overflow-y: auto; }
      #inline-bgm-container.active { display: block; }
      .inline-bgm-item { display: flex; align-items: center; gap: 10px; padding: 8px; border-bottom: 1px solid #222; cursor: pointer; }
      .inline-bgm-item:hover { background: #252830; }
      .inline-bgm-cover { width: 30px; height: 30px; border-radius: 4px; object-fit: cover; }
      .inline-bgm-title { font-size: 0.75rem; font-weight: bold; color: #fff; }

      /* [4. 미니 & 확장 플레이어] */
      #mini-player {
          position: fixed; bottom: 30px; left: 30px; z-index: 10000;
          display: flex; align-items: center; gap: 12px;
          background: rgba(15, 17, 21, 0.9); padding: 8px;
          border-radius: 50px; border: 1px solid #444;
          box-shadow: 0 10px 30px rgba(0,0,0,0.8); backdrop-filter: blur(10px);
          transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
          width: auto; max-width: 220px; cursor: pointer; transform: translateY(150%);
      }
      #mini-player.active { transform: translateY(0); }
      #mini-player.expanded { border-radius: 20px; padding: 20px; flex-direction: column; max-width: 200px; bottom: 40px; left: 40px; }
      .vinyl-record { width: 40px; height: 40px; border-radius: 50%; background-size: cover; background-position: center; border: 2px solid #222; animation: spin 4s linear infinite; animation-play-state: paused; transition: all 0.4s; }
      #mini-player.expanded .vinyl-record { width: 120px; height: 120px; margin-bottom: 10px; }
      .vinyl-record.playing { animation-play-state: running; }
      .player-info { color: white; display: flex; flex-direction: column; transition: all 0.4s; }
      #mini-player.expanded .player-info { text-align: center; align-items: center; }
      .player-title { font-size: 0.75rem; font-weight: bold; max-width: 100px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      #mini-player.expanded .player-title { font-size: 1rem; max-width: 160px; white-space: normal; margin-bottom: 10px; }
      .player-ctrl-box { display: flex; gap: 15px; align-items: center; }
      .ctrl-btn { background: none; border: none; color: #ccc; cursor: pointer; font-size: 1rem; transition: 0.2s; }
      @keyframes spin { 100% { transform: rotate(360deg); } }

      /* [5. 시간표 모달 스타일] */
      .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 20000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
      .modal-window { background: #1e2025; border: 1px solid #333; border-radius: 16px; padding: 25px; box-shadow: 0 20px 50px rgba(0,0,0,0.6); display: flex; flex-direction: column; max-width: 600px; width: 90%; }
      .timetable-table { width: 100%; border-collapse: collapse; margin-top: 15px; color: #eee; text-align: center; font-size: 0.9rem; }
      .timetable-table th { background: #2a2d35; padding: 10px; border: 1px solid #444; color: #5ac4ff; }
      .timetable-table td { padding: 10px; border: 1px solid #333; background: #15171c; }
      .selector-group { display: flex; gap: 10px; margin-bottom: 15px; }
      .selector-group select { background: #2a2d35; color: white; border: 1px solid #444; padding: 5px 10px; border-radius: 6px; }

      /* [6. 시간 제한 경고] */
      #restriction-popup { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 30000; background: #ef4444; color: white; padding: 15px 25px; border-radius: 12px; display: none; box-shadow: 0 10px 40px rgba(239, 68, 68, 0.4); align-items: center; gap: 15px; animation: slideDown 0.4s ease; }
      .admin-input { width: 50px; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; font-size: 0.7rem; padding: 3px; border-radius: 4px; outline: none; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
  </head>
  <body>
    <canvas id="snow-canvas"></canvas>
    <div id="app"></div>

    <div id="timetableModal" class="modal-overlay" style="display: none;">
        <div class="modal-window">
            <h2 style="color:white; margin:0 0 15px 0;"><i class="fas fa-calendar-alt"></i> 학급 시간표</h2>
            <div class="selector-group">
                <select id="gradeSelector"></select>
                <select id="classSelector"></select>
            </div>
            <div id="timetableContainer" style="max-height: 400px; overflow-y: auto;">
                <p style="color:#888;">시간표를 불러오는 중...</p>
            </div>
            <button onclick="closeTimetable()" style="margin-top:20px; background:#333; color:white; border:none; padding:10px; border-radius:8px; cursor:pointer;">닫기</button>
        </div>
    </div>

    <div id="restriction-popup">
        <input type="password" id="admin-pw" class="admin-input" placeholder="admin" maxlength="4">
        <div style="flex:1">
            <b style="display:block">재생 불가(수업/자습)</b>
            <small id="restriction-msg">학습을 위해 BGM이 차단됩니다.</small>
        </div>
    </div>

    <div id="mini-player" onclick="toggleExpand(event)">
        <div id="mini-cover" class="vinyl-record"></div>
        <div class="player-info">
            <span id="mini-title" class="player-title">노래를 선택하세요</span>
            <div class="player-ctrl-box">
                <button class="ctrl-btn" onclick="handlePlayBtn(event)"><i id="play-icon" class="fas fa-play"></i></button>
                <button class="ctrl-btn" onclick="stopMusic(event)"><i class="fas fa-stop"></i></button>
            </div>
        </div>
        <audio id="bgm-audio"></audio>
    </div>

    <div id="custom-modal-overlay" class="modal-overlay" style="display: none;">
        <div class="modal-window" style="max-width: 400px;">
            <h3 style="color:#fff; text-align:center; margin-bottom:15px;">이동 사유 입력</h3>
            <input type="text" id="custom-reason-input" style="width:100%; padding:12px; background:#2a2d35; color:white; border:1px solid #444; border-radius:8px;" placeholder="사유 입력">
            <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:20px;">
                <button id="modal-btn-cancel" style="background:#333; color:#ccc; border:none; padding:8px 15px; border-radius:6px; cursor:pointer;">취소</button>
                <button id="modal-btn-save" style="background:#2563eb; color:white; border:none; padding:8px 15px; border-radius:6px; cursor:pointer;">확인</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // [설정] BGM 및 API 키
        // ==========================================
        const BGM_LIST = [
            { title: "Jane Doe (christmas)", desc: "캐롤버전", cover: "./asset/IMG_0319.jpg", src: "./asset/Jane Doe.mp3" },
            { title: "잔잔한 피아노", desc: "공부할 때 듣는 노래", cover: "https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?w=100", src: "./assets/piano.mp3" }
        ];

        const API_KEY = 'fb54814355634dc9b29c7bb7b7bd028c';
        const ADMIN_PASSWORD = "1224";
        let bypassUntil = 0;

        // -----------------------------------------------------------
        // 1. 시간표 기능 (나이스 API)
        // -----------------------------------------------------------
        async function fetchTimetable() {
            const container = document.getElementById('timetableContainer');
            const grade = document.getElementById('gradeSelector').value;
            const classNum = document.getElementById('classSelector').value;
            container.innerHTML = '<p style="color:#ffff;">좀느려요...API호출중..</p>';

            const today = new Date();
            const day = today.getDay();
            const diff = today.getDate() - day + (day === 0 ? -6 : 1);
            const monday = new Date(today.setDate(diff));

            const weekDays = [];
            for (let i = 0; i < 5; i++) {
                const d = new Date(monday);
                d.setDate(monday.getDate() + i);
                weekDays.push(d.getFullYear() + ('0' + (d.getMonth() + 1)).slice(-2) + ('0' + d.getDate()).slice(-2));
            }

            try {
                const requests = weekDays.map(date => 
                    fetch(`https://open.neis.go.kr/hub/hisTimetable?KEY=${API_KEY}&Type=json&ATPT_OFCDC_SC_CODE=J10&SD_SCHUL_CODE=7530560&GRADE=${grade}&CLASS_NM=${classNum}&ALL_TI_YMD=${date}`)
                    .then(res => res.json())
                );
                const results = await Promise.all(requests);
                const weeklyData = results.map(r => r.hisTimetable ? r.hisTimetable[1].row : []);
                
                renderTimetableUI(weeklyData);
                localStorage.setItem('last_grade', grade);
                localStorage.setItem('last_class', classNum);
            } catch (e) {
                container.innerHTML = '<p style="color:#ef4444;">API 호출에 실패했습니다.</p>';
            }
        }

        function renderTimetableUI(data) {
            const days = ['월', '화', '수', '목', '금'];
            let html = '<table class="timetable-table"><thead><tr><th>교시</th>' + days.map(d => `<th>${d}</th>`).join('') + '</tr></thead><tbody>';
            for (let p = 1; p <= 7; p++) {
                html += `<tr><td style="font-weight:bold">${p}</td>`;
                for (let i = 0; i < 5; i++) {
                    const subject = data[i].find(item => item.PERIO == p)?.ITRT_CNTNT || '-';
                    html += `<td>${subject}</td>`;
                }
                html += '</tr>';
            }
            html += '</tbody></table>';
            document.getElementById('timetableContainer').innerHTML = html;
        }

        function openTimetable() {
            document.getElementById('timetableModal').style.display = 'flex';
            const gs = document.getElementById('gradeSelector');
            const cs = document.getElementById('classSelector');
            if(gs.options.length === 0) {
                for(let i=1; i<=3; i++) gs.add(new Option(`${i}학년`, i));
                for(let i=1; i<=6; i++) cs.add(new Option(`${i}반`, i));
                gs.value = localStorage.getItem('last_grade') || '1';
                cs.value = localStorage.getItem('last_class') || '2';
                gs.onchange = fetchTimetable; cs.onchange = fetchTimetable;
            }
            fetchTimetable();
        }
        function closeTimetable() { document.getElementById('timetableModal').style.display = 'none'; }

        // -----------------------------------------------------------
        // 2. 시간 제한 & BGM 로직
        // -----------------------------------------------------------
        function checkTimeRestriction() {
            if (Date.now() < bypassUntil) return { restricted: false };
            const now = new Date();
            const time = now.getHours() * 100 + now.getMinutes();
            const ranges = [
                { s: 845, e: 1240, m: "오전 수업 시간" }, { s: 1346, e: 1630, m: "오후 수업 시간" },
                { s: 1709, e: 1830, m: "자습 시간" }, { s: 1946, e: 2110, m: "야자 1타임" }, { s: 2129, e: 2300, m: "야자 2타임" }
            ];
            for (const r of ranges) if (time >= r.s && time <= r.e) return { restricted: true, msg: r.m };
            return { restricted: false };
        }

        const audio = document.getElementById('bgm-audio');
        const miniPlayer = document.getElementById('mini-player');
        const miniCover = document.getElementById('mini-cover');
        const miniTitle = document.getElementById('mini-title');
        const playIcon = document.getElementById('play-icon');
        let currentBgmData = null;
        let isPlaying = false;

        function tryPlayMusic(bgm) {
            const check = checkTimeRestriction();
            if (check.restricted) return showRestriction(check.msg);
            currentBgmData = bgm; audio.src = bgm.src; audio.play(); isPlaying = true;
            updatePlayerUI();
        }

        function handlePlayBtn(e) {
            e.stopPropagation();
            if (!currentBgmData) return;
            const check = checkTimeRestriction();
            if (!isPlaying && check.restricted) return showRestriction(check.msg);
            if(isPlaying) { audio.pause(); miniCover.classList.remove('playing'); playIcon.className = 'fas fa-play'; }
            else { audio.play(); miniCover.classList.add('playing'); playIcon.className = 'fas fa-pause'; }
            isPlaying = !isPlaying;
        }

        function updatePlayerUI() {
            miniPlayer.classList.add('active');
            miniCover.style.backgroundImage = `url('${currentBgmData.cover}')`;
            miniCover.classList.add('playing');
            miniTitle.innerText = currentBgmData.title;
            playIcon.className = 'fas fa-pause';
        }

        function stopMusic(e) { e.stopPropagation(); audio.pause(); miniPlayer.classList.remove('active', 'expanded'); isPlaying = false; }
        function toggleExpand(e) { if (!e.target.closest('.ctrl-btn')) document.getElementById('mini-player').classList.toggle('expanded'); }

        function showRestriction(msg) {
            const p = document.getElementById('restriction-popup');
            document.getElementById('restriction-msg').innerText = `${msg}에는 재생할 수 없습니다.`;
            p.style.display = 'flex';
            setTimeout(() => { p.style.display = 'none'; }, 5000);
        }

        document.getElementById('admin-pw').oninput = function() {
            if (this.value === ADMIN_PASSWORD) {
                bypassUntil = Date.now() + 300000;
                document.getElementById('restriction-popup').style.background = "#22c55e";
                setTimeout(() => { document.getElementById('restriction-popup').style.display = 'none'; }, 1000);
            }
        };

        // -----------------------------------------------------------
        // 3. UI 렌더링 & 사이드바
        // -----------------------------------------------------------
        function renderFeatures() {
            const aside = document.querySelector('aside');
            if(!aside) return;
            aside.querySelector('.notice') && (aside.querySelector('.notice').style.display = 'none');
            if(!document.getElementById('advanced-features-container')) {
                const div = document.createElement('div');
                div.id = 'advanced-features-container';
                div.innerHTML = `
                    <div class="feature-header" onclick="this.nextElementSibling.classList.toggle('active')">
                        <span>더보기</span><i class="fas fa-chevron-right"></i>
                    </div>
                    <div class="feature-list">
                        <button class="feature-btn" onclick="openTimetable()"><i class="fas fa-calendar-alt" style="color:#4ade80"></i> 시간표</button>
                        <button class="feature-btn" onclick="alert('급식 기능 준비 중!')"><i class="fas fa-utensils" style="color:#fb923c"></i> 급식</button>
                        <button class="feature-btn" onclick="document.getElementById('inline-bgm-container').classList.toggle('active')"><i class="fas fa-music" style="color:#c084fc"></i> BGM</button>
                        <div id="inline-bgm-container"></div>
                    </div>
                `;
                const stats = aside.querySelector('div');
                stats ? aside.insertBefore(div, stats.nextSibling) : aside.appendChild(div);
                const bgmBox = document.getElementById('inline-bgm-container');
                BGM_LIST.forEach(bgm => {
                    const item = document.createElement('div');
                    item.className = 'inline-bgm-item';
                    item.innerHTML = `<img src="${bgm.cover}" class="inline-bgm-cover"><span class="inline-bgm-title">${bgm.title}</span>`;
                    item.onclick = (e) => { e.stopPropagation(); tryPlayMusic(bgm); };
                    bgmBox.appendChild(item);
                });
            }
        }
        setInterval(renderFeatures, 500);

        // -----------------------------------------------------------
        // 4. 눈 효과 (Snow)
        // -----------------------------------------------------------
        (function() {
            const canvas = document.getElementById('snow-canvas');
            const ctx = canvas.getContext('2d');
            let w = window.innerWidth, h = window.innerHeight;
            canvas.width = w; canvas.height = h;
            const flakes = []; let acc = 0;
            for(let i=0; i<100; i++) flakes.push({x:Math.random()*w, y:Math.random()*-h, r:Math.random()*2+1, s:Math.random()+0.5, o:Math.random()*0.5+0.3});
            function draw() {
                ctx.clearRect(0,0,w,h);
                if(acc>0){ const g=ctx.createLinearGradient(0,h,0,h-acc); g.addColorStop(0,'rgba(255,255,255,0.4)'); g.addColorStop(1,'rgba(0,0,0,0)'); ctx.fillStyle=g; ctx.fillRect(0,h-acc,w,acc); }
                ctx.fillStyle='rgba(255,255,255,0.8)'; ctx.beginPath();
                flakes.forEach(f=>{
                    ctx.globalAlpha=f.o; ctx.moveTo(f.x,f.y); ctx.arc(f.x,f.y,f.r,0,Math.PI*2);
                    f.y+=f.s; if(f.y>h){ if(acc<30 && Math.random()>0.99) acc+=0.05; f.y=-5; f.x=Math.random()*w; }
                }); ctx.fill(); requestAnimationFrame(draw);
            }
            window.onresize = () => { w=window.innerWidth; h=window.innerHeight; canvas.width=w; canvas.height=h; };
            draw();
        })();

        // -----------------------------------------------------------
        // 5. 기타 사유 팝업 (script.js 연동)
        // -----------------------------------------------------------
        window.openEtcModal = function(name, lane, callback) {
            const overlay = document.getElementById('custom-modal-overlay');
            const input = document.getElementById('custom-reason-input');
            overlay.style.display = 'flex'; input.value = ''; input.focus();
            document.getElementById('modal-btn-save').onclick = () => { overlay.style.display='none'; callback(input.value); };
            document.getElementById('modal-btn-cancel').onclick = () => overlay.style.display='none';
        };
    </script>
  </body>
</html>
