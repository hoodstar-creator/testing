<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>1í•™ë…„ 2ë°˜ í˜„í™©íŒ</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        @import url("https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable.min.css");
        body { font-family: "Pretendard Variable", sans-serif; background-color: #111827; color: white; overflow: hidden; }
        
        /* [1] ëˆˆ íš¨ê³¼ */
        #snow-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50; }
        
        /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ */
        ::-webkit-scrollbar { display: none; }
        
        /* [2] ì „ìì¹ íŒ ìŠ¤íƒ€ì¼ */
        .board-container { display: flex; height: 100vh; padding-top: 80px; }
        
        /* ì¢Œì„ ê·¸ë¦¬ë“œ (ì¢Œì¸¡ ë©”ì¸) */
        .board-main { flex: 1; padding: 20px; overflow-y: auto; }
        .board-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 12px; height: 100%; align-content: center; }
        
        .seat-card {
            background: #1f2937; border: 1px solid #374151; border-radius: 12px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            height: 130px; transition: all 0.3s ease; position: relative;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        /* ìƒíƒœë³„ ìƒ‰ìƒ */
        .status-room { border-color: #374151; }
        .status-etc { border-color: #fbbf24; background: rgba(251, 191, 36, 0.1); }
        .status-away { border-color: #ef4444; background: rgba(239, 68, 68, 0.1); }
        
        /* [3] ìš°ì¸¡ ì‚¬ì´ë“œë°” (ê³ ê¸‰ ê¸°ëŠ¥) */
        .board-sidebar { 
            width: 320px; padding: 20px; background: rgba(31, 41, 55, 0.5); 
            border-left: 1px solid #374151; backdrop-filter: blur(10px);
            display: flex; flex-direction: column; gap: 20px; z-index: 60;
        }
        
        .feature-btn {
            width: 100%; padding: 20px; border-radius: 12px; border: 1px solid #4b5563;
            background: #374151; color: white; font-weight: 600; font-size: 1.1rem;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: 0.2s; cursor: pointer;
        }
        .feature-btn:hover { background: #4b5563; transform: translateY(-2px); }
        
        /* [4] BGM í”Œë ˆì´ì–´ (ë¯¸ë‹ˆ LPíŒ) */
        .mini-player {
            position: fixed; bottom: 30px; left: 30px; z-index: 100;
            display: flex; align-items: center; gap: 15px;
            background: rgba(0, 0, 0, 0.8); padding: 10px 20px 10px 10px;
            border-radius: 50px; border: 1px solid #4b5563;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            transition: transform 0.3s;
        }
        .mini-player.hidden { transform: translateY(150%); }
        
        .vinyl-record {
            width: 50px; height: 50px; border-radius: 50%;
            background-size: cover; background-position: center;
            border: 2px solid #1f2937;
            animation: spin 4s linear infinite;
            animation-play-state: paused;
        }
        .vinyl-record.playing { animation-play-state: running; }
        
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        /* [5] ëª¨ë‹¬ íŒì—… */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8); z-index: 200;
            display: flex; align-items: center; justify-content: center;
        }
        .modal-window {
            background: #1f2937; width: 450px; max-height: 80vh;
            border-radius: 16px; padding: 24px; border: 1px solid #374151;
            display: flex; flex-direction: column;
        }
        .bgm-item {
            display: flex; align-items: center; gap: 15px; padding: 12px;
            border-bottom: 1px solid #374151; cursor: pointer; transition: 0.2s;
        }
        .bgm-item:hover { background: #374151; }
        .bgm-item img { width: 48px; height: 48px; border-radius: 6px; object-fit: cover; }

        /* [6] ëª¨ë°”ì¼ ë²„íŠ¼ */
        .mobile-btn { padding: 20px; border-radius: 16px; font-weight: bold; font-size: 1.1rem; transition: 0.2s; border: none; }
        .mobile-btn:active { transform: scale(0.95); }
    </style>
</head>
<body>
    <div id="app">
        <canvas id="snow-canvas"></canvas>

        <div v-if="isBoardMode" class="h-screen flex flex-col">
            <div class="fixed top-0 left-0 w-full p-4 text-center z-20 bg-gray-900/90 backdrop-blur border-b border-gray-800">
                <h1 class="text-3xl font-bold text-gray-100">1í•™ë…„ 2ë°˜ í•™ìŠµ ì¥ì†Œ í˜„í™©</h1>
                <div class="flex justify-center gap-6 mt-2 text-lg">
                    <span class="text-gray-400">ì´ì›: {{ totalStudents }}ëª…</span>
                    <span class="text-blue-400">í˜„ì›: {{ presentCount }}ëª…</span>
                    <span class="text-red-400">ì´ë™: {{ awayCount }}ëª…</span>
                </div>
            </div>

            <div class="board-container">
                <div class="board-main">
                    <div class="board-grid">
                        <div v-for="n in 32" :key="n" v-show="n !== 31" class="seat-card" :class="getSeatClass(n)">
                            <div class="absolute top-2 left-3 text-sm text-gray-500 font-mono">{{ n }}</div>
                            <div class="text-2xl font-bold mb-1">{{ getStudentName(n) || '-' }}</div>
                            <div v-if="getStudentStatus(n) !== 'êµì‹¤'" class="px-3 py-1 rounded-full text-sm font-bold animate-pulse" :class="getStatusColor(n)">
                                {{ getStudentStatus(n) }}
                            </div>
                            <div v-else class="text-sm text-gray-600">êµì‹¤</div>
                        </div>
                    </div>
                </div>

                <div class="board-sidebar">
                    <h2 class="text-xl font-bold text-blue-400 mb-2"><i class="fas fa-star mr-2"></i>ê³ ê¸‰ ê¸°ëŠ¥</h2>
                    
                    <button class="feature-btn" @click="alert('ğŸš§ ì‹œê°„í‘œ ê¸°ëŠ¥ì€ ê°œë°œ ì¤‘ì…ë‹ˆë‹¤!')">
                        <i class="fas fa-calendar-alt text-green-400"></i> ì‹œê°„í‘œ ë³´ê¸°
                    </button>
                    
                    <button class="feature-btn" @click="alert('ğŸš§ ê¸‰ì‹ ê¸°ëŠ¥ì€ ê°œë°œ ì¤‘ì…ë‹ˆë‹¤!')">
                        <i class="fas fa-utensils text-orange-400"></i> ê¸‰ì‹ ë³´ê¸°
                    </button>
                    
                    <button class="feature-btn" @click="openBgmModal">
                        <i class="fas fa-music text-purple-400"></i> BGM ë“£ê¸°
                    </button>
                </div>
            </div>

            <div class="mini-player" :class="{ 'hidden': !currentBgm }">
                <div class="vinyl-record" :class="{ 'playing': isPlaying }" :style="currentBgm ? `background-image: url(${currentBgm.cover})` : ''"></div>
                <div class="flex flex-col text-sm ml-2 mr-4">
                    <span class="font-bold text-white">{{ currentBgm?.title || 'ì¬ìƒ ì¤‘ ì•„ë‹˜' }}</span>
                    <span class="text-gray-400 text-xs">Playing...</span>
                </div>
                <button @click="toggleMusic" class="text-white hover:text-blue-400 text-xl"><i :class="isPlaying ? 'fas fa-pause' : 'fas fa-play'"></i></button>
                <button @click="stopMusic" class="text-gray-400 hover:text-red-400 text-xl ml-2"><i class="fas fa-stop"></i></button>
            </div>

            <div v-if="showBgmModal" class="modal-overlay" @click.self="showBgmModal = false">
                <div class="modal-window">
                    <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-3">
                        <h3 class="text-xl font-bold">ğŸµ BGM ëª©ë¡</h3>
                        <button @click="showBgmModal = false" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="overflow-y-auto max-h-[400px]">
                        <div v-for="(bgm, idx) in bgmList" :key="idx" class="bgm-item" @click="playMusic(bgm)">
                            <img :src="bgm.cover" alt="cover">
                            <div class="flex-1">
                                <div class="font-bold text-white">{{ bgm.title }}</div>
                                <div class="text-xs text-gray-400">{{ bgm.desc }}</div>
                            </div>
                            <i class="fas fa-play-circle text-2xl text-blue-500"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <audio ref="audioPlayer" loop></audio>
        </div>

        <div v-else class="flex flex-col items-center justify-center min-h-screen p-6 relative z-10">
            
            <div v-if="!user" class="w-full max-w-md text-center">
                <h1 class="text-4xl font-bold mb-2">ë””ë¯¸ê³  ì¸ì›ì ê²€</h1>
                <p class="text-gray-400 mb-10">1í•™ë…„ 2ë°˜ ì „ìš©</p>
                <button @click="googleLogin" class="w-full bg-white text-gray-900 font-bold py-4 px-6 rounded-xl flex items-center justify-center gap-3 hover:bg-gray-100 transition shadow-lg">
                    <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-6 h-6">
                    ë””ë¯¸ê³  ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
                </button>
                <p class="text-sm text-gray-600 mt-4">* @dimigo.hs.kr ê³„ì •ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
            </div>

            <div v-else class="w-full max-w-md">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-2xl font-bold">{{ myName }}</h2>
                        <p class="text-blue-400 font-mono">{{ mySeatNo }}ë²ˆ</p>
                    </div>
                    <button @click="logout" class="text-sm text-gray-500 underline">ë¡œê·¸ì•„ì›ƒ</button>
                </div>

                <div class="bg-gray-800 p-6 rounded-2xl text-center mb-6 border border-gray-700 shadow-xl">
                    <p class="text-gray-400 text-sm mb-2">í˜„ì¬ ë‚˜ì˜ ìƒíƒœ</p>
                    <p class="text-3xl font-bold text-white animate-pulse">{{ myStatus || 'êµì‹¤' }}</p>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <button @click="updateStatus('êµì‹¤')" class="mobile-btn bg-gray-700 text-white hover:bg-gray-600">ğŸ« êµì‹¤ ë³µê·€</button>
                    <button @click="updateStatus('í™”ì¥ì‹¤')" class="mobile-btn bg-blue-900/50 text-blue-200 border border-blue-800 hover:bg-blue-900">ğŸš½ í™”ì¥ì‹¤</button>
                    <button @click="updateStatus('ì‹ìˆ˜')" class="mobile-btn bg-blue-900/50 text-blue-200 border border-blue-800 hover:bg-blue-900">ğŸ’§ ì‹ìˆ˜</button>
                    <button @click="updateStatus('ë³´ê±´ì‹¤')" class="mobile-btn bg-red-900/50 text-red-200 border border-red-800 hover:bg-red-900">ğŸ’Š ë³´ê±´ì‹¤</button>
                    <button @click="updateStatus('ë™ì•„ë¦¬')" class="mobile-btn bg-purple-900/50 text-purple-200 border border-purple-800 hover:bg-purple-900">âš½ ë™ì•„ë¦¬</button>
                    <button @click="updateStatus('ë°©ê³¼í›„')" class="mobile-btn bg-purple-900/50 text-purple-200 border border-purple-800 hover:bg-purple-900">ğŸ“š ë°©ê³¼í›„</button>
                    <button @click="askEtc" class="mobile-btn col-span-2 bg-yellow-900/50 text-yellow-200 border border-yellow-800 hover:bg-yellow-900">ğŸ¸ ê¸°íƒ€ ì‚¬ìœ  ì…ë ¥</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { createApp, ref, computed, onMounted } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getDatabase, ref as dbRef, onValue, set } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        // ============================================================
        // [ì¤‘ìš”] Firebase í‚¤ ì„¤ì • (ì—¬ê¸°ì— ë³µì‚¬í•œ í‚¤ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”)
        // ============================================================
        const firebaseConfig = {
            apiKey: "AIzaSyD...", 
            authDomain: "xxxx.firebaseapp.com",
            databaseURL: "https://xxxx-default-rtdb.firebaseio.com",
            projectId: "xxxx",
            storageBucket: "xxxx.appspot.com",
            messagingSenderId: "123456",
            appId: "1:123456:web:xxxx"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const provider = new GoogleAuthProvider();
        provider.setCustomParameters({ hd: 'dimigo.hs.kr' });

        // BGM ë°ì´í„°
        const bgmList = [
            { title: "Cozy Winter", desc: "ë”°ëœ»í•˜ê³  í¸ì•ˆí•œ ëŠë‚Œ", cover: "https://images.unsplash.com/photo-1542317854-f9eb6d3e34b9?w=100", src: "https://incompetech.com/music/royalty-free/mp3-royaltyfree/Carefree.mp3" },
            { title: "Snowy Jazz", desc: "ëˆˆ ë‚´ë¦¬ëŠ” ë‚ ì˜ ì¬ì¦ˆ", cover: "https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?w=100", src: "https://incompetech.com/music/royalty-free/mp3-royaltyfree/Airport%20Lounge.mp3" },
            { title: "Study Lofi", desc: "ì§‘ì¤‘í•˜ê¸° ì¢‹ì€ ë¹„íŠ¸", cover: "https://images.unsplash.com/photo-1516280440614-6697288d5d38?w=100", src: "https://incompetech.com/music/royalty-free/mp3-royaltyfree/Lobby%20Time.mp3" }
        ];

        createApp({
            setup() {
                const isBoardMode = ref(new URLSearchParams(window.location.search).get('mode') === 'board');
                const user = ref(null);
                const students = ref({});
                const myName = ref('');
                const mySeatNo = ref(0);
                
                // BGM ê´€ë ¨ ìƒíƒœ
                const showBgmModal = ref(false);
                const currentBgm = ref(null);
                const isPlaying = ref(false);
                const audioPlayer = ref(null);

                // ë°ì´í„° ë¡œë“œ
                onMounted(() => {
                    onValue(dbRef(db, 'students'), (snapshot) => {
                        students.value = snapshot.val() || {};
                    });

                    onAuthStateChanged(auth, (currentUser) => {
                        if (currentUser) {
                            if (!currentUser.email.endsWith('@dimigo.hs.kr')) {
                                alert("ë””ë¯¸ê³  ê³„ì •ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                                logout(); return;
                            }
                            user.value = currentUser;
                            parseUserInfo(currentUser.displayName);
                        } else {
                            user.value = null;
                        }
                    });
                    startSnow();
                });

                const parseUserInfo = (displayName) => {
                    const match = displayName.match(/(\d{4})\s*(.*)/);
                    if (match) {
                        const studentId = match[1]; 
                        myName.value = match[2] || displayName; 
                        let seat = parseInt(studentId) - 1200;
                        if (seat > 0 && seat <= 32 && seat !== 31) mySeatNo.value = seat;
                        else { alert("ìœ íš¨í•˜ì§€ ì•Šì€ í•™ë²ˆì…ë‹ˆë‹¤."); logout(); }
                    } else {
                        const inputId = prompt("í•™ë²ˆ 4ìë¦¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” (ì˜ˆ: 1224)");
                        if(inputId) parseUserInfo(inputId + " " + displayName);
                    }
                };

                const googleLogin = () => { signInWithPopup(auth, provider).catch(e => alert(e.message)); };
                const logout = () => { signOut(auth); user.value = null; };
                const updateStatus = (status) => {
                    if (!mySeatNo.value) return;
                    set(dbRef(db, 'students/' + mySeatNo.value), {
                        name: myName.value, status: status, timestamp: Date.now()
                    });
                };
                const askEtc = () => {
                    const reason = prompt("ê¸°íƒ€ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
                    if (reason) updateStatus(`ê¸°íƒ€(${reason})`);
                };

                // BGM í•¨ìˆ˜ë“¤
                const openBgmModal = () => showBgmModal.value = true;
                const playMusic = (bgm) => {
                    currentBgm.value = bgm;
                    showBgmModal.value = false;
                    setTimeout(() => {
                        if(audioPlayer.value) {
                            audioPlayer.value.src = bgm.src;
                            audioPlayer.value.play();
                            isPlaying.value = true;
                        }
                    }, 100);
                };
                const toggleMusic = () => {
                    if(!audioPlayer.value) return;
                    if(isPlaying.value) audioPlayer.value.pause();
                    else audioPlayer.value.play();
                    isPlaying.value = !isPlaying.value;
                };
                const stopMusic = () => {
                    if(audioPlayer.value) { audioPlayer.value.pause(); audioPlayer.value.currentTime = 0; }
                    isPlaying.value = false; currentBgm.value = null;
                };

                // ì¹ íŒìš© í—¬í¼
                const getStudentName = (n) => students.value[n]?.name || '';
                const getStudentStatus = (n) => students.value[n]?.status || 'êµì‹¤';
                const getSeatClass = (n) => getStudentStatus(n) === 'êµì‹¤' ? 'status-room' : 'status-away';
                const getStatusColor = (n) => {
                    const s = getStudentStatus(n);
                    if(s==='êµì‹¤') return '';
                    if(s.includes('ê¸°íƒ€')) return 'text-yellow-400 bg-yellow-900/30';
                    return 'text-red-400 bg-red-900/30';
                };

                const totalStudents = 31;
                const presentCount = computed(() => {
                    let count = 0;
                    for(let i=1; i<=32; i++) {
                        if(i===31) continue;
                        if((students.value[i]?.status || 'êµì‹¤') === 'êµì‹¤') count++;
                    }
                    return count;
                });
                const awayCount = computed(() => totalStudents - presentCount.value);

                return {
                    isBoardMode, user, myName, mySeatNo, myStatus: computed(() => students.value[mySeatNo.value]?.status),
                    googleLogin, logout, updateStatus, askEtc,
                    getStudentName, getStudentStatus, getSeatClass, getStatusColor,
                    totalStudents, presentCount, awayCount,
                    bgmList, showBgmModal, currentBgm, isPlaying, audioPlayer,
                    openBgmModal, playMusic, toggleMusic, stopMusic
                };
            }
        }).mount('#app');

        function startSnow() {
            const canvas = document.getElementById('snow-canvas');
            const ctx = canvas.getContext('2d');
            let width = window.innerWidth, height = window.innerHeight;
            canvas.width = width; canvas.height = height;
            const flakes = []; let accumulation = 0;
            for(let i=0; i<120; i++) flakes.push({x:Math.random()*width, y:Math.random()*-height, r:Math.random()*2+1, s:Math.random()*1+0.5});
            
            function draw() {
                ctx.clearRect(0,0,width,height);
                if(accumulation > 0) {
                    const g = ctx.createLinearGradient(0, height, 0, height - accumulation);
                    g.addColorStop(0, 'rgba(255,255,255,0.4)'); g.addColorStop(1, 'rgba(0,0,0,0)');
                    ctx.fillStyle = g; ctx.fillRect(0, height - accumulation, width, accumulation);
                }
                ctx.fillStyle = 'rgba(255,255,255,0.7)'; ctx.beginPath();
                flakes.forEach(f => {
                    ctx.moveTo(f.x, f.y); ctx.arc(f.x, f.y, f.r, 0, Math.PI*2);
                    f.y += f.s;
                    if(f.y > height) {
                        if(accumulation < 40 && Math.random() > 0.99) accumulation += 0.05;
                        f.y = -5; f.x = Math.random() * width;
                    }
                });
                ctx.fill(); requestAnimationFrame(draw);
            }
            window.addEventListener('resize', () => { width=window.innerWidth; height=window.innerHeight; canvas.width=width; canvas.height=height; });
            draw();
        }
    </script>
</body>
</html>
