<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>í•™ìŠµ ì¥ì†Œ í˜„í™©íŒ</title>
    
    <link rel="stylesheet" crossorigin href="./style.css">
    <script type="module" crossorigin src="./script.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
      /* [1. ê¸°ë³¸ ì„¤ì •] */
      #snow-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9998; pointer-events: none; }
      .form, .notice, .aside-announcement, ul.notice-ul { display: none !important; }

      /* [2. ê³ ê¸‰ ê¸°ëŠ¥ ì‚¬ì´ë“œë°”] */
      #advanced-features-container {
          margin-top: 15px; margin-bottom: 20px; padding: 10px;
          background: rgba(30, 32, 37, 0.6); border-radius: 12px;
          border: 1px solid #333; animation: fadeIn 0.8s ease;
      }
      .feature-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 5px 10px; color: #5ac4ff; font-weight: 700; user-select: none; }
      .feature-list { display: none; flex-direction: column; gap: 8px; margin-top: 12px; padding: 0 5px; }
      .feature-list.active { display: flex; }
      .feature-btn { background: #2a2d35; border: 1px solid #444; color: #ffff; padding: 8px 12px; border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 8px; }
      .feature-btn:hover { background: #333; border-color: #ffff; }

      /* [3. ì¸ë¼ì¸ BGM ë¦¬ìŠ¤íŠ¸] */
      #inline-bgm-container { display: none; margin-top: 10px; background: #15171c; border-radius: 8px; border: 1px solid #444; overflow: hidden; max-height: 200px; overflow-y: auto; }
      #inline-bgm-container.active { display: block; }
      .inline-bgm-item { display: flex; align-items: center; gap: 10px; padding: 8px; border-bottom: 1px solid #222; cursor: pointer; }
      .inline-bgm-item:hover { background: #252830; }
      .inline-bgm-cover { width: 30px; height: 30px; border-radius: 4px; object-fit: cover; }
      .inline-bgm-title { font-size: 0.75rem; font-weight: bold; color: #fff; }

      /* [4. ë¯¸ë‹ˆ & í™•ì¥ í”Œë ˆì´ì–´ ìŠ¤íƒ€ì¼] */
      #mini-player {
          position: fixed; bottom: 30px; left: 30px; z-index: 10000;
          display: flex; align-items: center; gap: 12px;
          background: rgba(15, 17, 21, 0.9); padding: 8px;
          border-radius: 50px; border: 1px solid #444;
          box-shadow: 0 10px 30px rgba(0,0,0,0.8); backdrop-filter: blur(10px);
          transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
          width: auto; max-width: 220px; cursor: pointer;
          transform: translateY(150%);
      }
      #mini-player.active { transform: translateY(0); }
      
      /* í™•ì¥ë˜ì—ˆì„ ë•Œì˜ ìŠ¤íƒ€ì¼ */
      #mini-player.expanded {
          border-radius: 20px; padding: 20px;
          flex-direction: column; max-width: 200px; /* ê°€ë¡œë¥¼ ì¢ê²Œ ìœ ì§€í•˜ì—¬ ìì„ ì˜ì—­ ë³´í˜¸ */
          bottom: 40px; left: 40px;
      }

      .vinyl-record {
          width: 40px; height: 40px; border-radius: 50%;
          background-size: cover; background-position: center;
          border: 2px solid #222; animation: spin 4s linear infinite; animation-play-state: paused;
          transition: all 0.4s;
      }
      #mini-player.expanded .vinyl-record { width: 120px; height: 120px; margin-bottom: 10px; }
      .vinyl-record.playing { animation-play-state: running; }
      
      .player-info { color: white; display: flex; flex-direction: column; transition: all 0.4s; }
      #mini-player.expanded .player-info { text-align: center; align-items: center; }
      .player-title { font-size: 0.75rem; font-weight: bold; max-width: 100px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      #mini-player.expanded .player-title { font-size: 1rem; max-width: 160px; white-space: normal; margin-bottom: 10px; }

      .player-ctrl-box { display: flex; gap: 15px; align-items: center; }
      .ctrl-btn { background: none; border: none; color: #ccc; cursor: pointer; font-size: 1rem; transition: 0.2s; }
      .ctrl-btn:hover { color: #5ac4ff; }

      @keyframes spin { 100% { transform: rotate(360deg); } }

      /* [5. ì‹œê°„ ì œí•œ ê²½ê³  íŒì—… ìŠ¤íƒ€ì¼] */
      #restriction-popup {
          position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
          z-index: 10001; background: #ef4444; color: white;
          padding: 15px 25px; border-radius: 12px; display: none;
          box-shadow: 0 10px 40px rgba(239, 68, 68, 0.4);
          align-items: center; gap: 15px; animation: slideDown 0.4s ease;
      }
      @keyframes slideDown { from { top: -100px; } to { top: 20px; } }
      
      .admin-input {
          width: 50px; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.3);
          color: white; font-size: 0.7rem; padding: 3px; border-radius: 4px; outline: none;
      }
      .admin-input::placeholder { color: rgba(255,255,255,0.5); }

      /* ê¸°ì¡´ íŒì—… ë””ìì¸ */
      .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; gap: 40px; backdrop-filter: blur(5px); }
      .window-reason, .window-project { background: #1e2025; border: 1px solid #333; border-radius: 12px; padding: 25px; display: flex; flex-direction: column; max-height: 80vh; }
      .window-reason { width: 380px; } .window-project { width: 350px; height: 500px; }
      .table-container { flex-grow: 1; overflow-y: auto; border: 1px solid #333; border-radius: 8px; background: #15171c; }
      .project-table { width: 100%; border-collapse: collapse; text-align: center; font-size: 0.85rem; color: #aaa; }
      .project-table th { background: #252830; color: #ccc; padding: 10px; border-bottom: 1px solid #444; position: sticky; top: 0; }
      .table-select-btn { background: #2563eb; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
  </head>
  <body>
    <canvas id="snow-canvas"></canvas>
    <div id="app"></div>

    <div id="restriction-popup">
        <input type="password" id="admin-pw" class="admin-input" placeholder="PASS" maxlength="4">
        <div style="flex:1">
            <b style="display:block">í˜„ì¬ ìŒì•… ì¬ìƒ ë¶ˆê°€ ì‹œê°„ì…ë‹ˆë‹¤.</b>
            <small id="restriction-msg">í•™ìŠµì„ ìœ„í•´ BGMì´ ì°¨ë‹¨ë©ë‹ˆë‹¤.</small>
        </div>
        <i class="fas fa-clock"></i>
    </div>

    <div id="mini-player" onclick="toggleExpand(event)">
        <div id="mini-cover" class="vinyl-record"></div>
        <div class="player-info">
            <span id="mini-title" class="player-title">ë…¸ë˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</span>
            <div class="player-ctrl-box">
                <button class="ctrl-btn" onclick="handlePlayBtn(event)"><i id="play-icon" class="fas fa-play"></i></button>
                <button class="ctrl-btn" onclick="stopMusic(event)"><i class="fas fa-stop"></i></button>
            </div>
        </div>
        <audio id="bgm-audio"></audio>
    </div>

    <div id="custom-modal-overlay" class="modal-overlay" style="display: none;">
        <div class="window-reason">
            <h3 style="color:#fff; text-align:center; margin-bottom:15px;">ê¸°íƒ€ ì´ë™ ì‚¬ìœ </h3>
            <input type="text" id="custom-reason-input" class="modal-input" placeholder="ì‚¬ìœ  ì§ì ‘ ì…ë ¥">
            <div id="recent-reasons-container" style="display: none;"><p style="color:#888; font-size:0.75rem; margin:15px 0 8px;">ìµœê·¼ ì‚¬ìœ </p><div id="recent-reasons-list"></div></div>
            <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:auto;">
                <button id="modal-btn-cancel" style="background:#333; color:#ccc; border:none; padding:8px 15px; border-radius:6px; cursor:pointer;">ì·¨ì†Œ</button>
                <button id="modal-btn-save" style="background:#2563eb; color:white; border:none; padding:8px 15px; border-radius:6px; cursor:pointer;">í™•ì¸</button>
            </div>
        </div>
        <div class="window-project">
            <h3 style="color:#fff; text-align:center; margin-bottom:15px;">í”„ë¡œì íŠ¸ì‹¤ ëª©ë¡</h3>
            <div class="table-container"><table class="project-table"><thead><tr><th>ìœ„ì¹˜</th><th>ëª…ì¹­</th></tr></thead><tbody id="project-table-body"></tbody></table></div>
        </div>
    </div>

    <script>
        // [ì‚¬ìš©ì ì„¤ì • BGM ëª©ë¡]
        const BGM_LIST = [
            { title: "Jane Doe (christmas)", desc: "ìºë¡¤ë²„ì „", cover: "./asset/IMG_0319.jpg", src: "./asset/Jane Doe.mp3" },
            { title: "ì”ì”í•œ í”¼ì•„ë…¸", desc: "ê³µë¶€í•  ë•Œ ë“£ëŠ” ë…¸ë˜", cover: "https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?w=100", src: "./assets/piano.mp3" }
        ];

        // [ê´€ë¦¬ì íŒ¨ìŠ¤ì›Œë“œ]
        const ADMIN_PASSWORD = "1224"; 
        let bypassUntil = 0; // íŒ¨ìŠ¤ì›Œë“œ í†µê³¼ ì‹œ ì¢…ë£Œ ì‹œê°„ ì €ì¥

        // -----------------------------------------------------------
        // 1. ì‹œê°„ ì œí•œ ì²´í¬ ë¡œì§
        // -----------------------------------------------------------
        function checkTimeRestriction() {
            if (Date.now() < bypassUntil) return { restricted: false }; // ê´€ë¦¬ì ìš°íšŒ ì¤‘

            const now = new Date();
            const time = now.getHours() * 100 + now.getMinutes(); // ì˜ˆ: 08:45 -> 845

            const ranges = [
                { start: 845,  end: 1240, msg: "ì˜¤ì „ ìˆ˜ì—… ì‹œê°„ì…ë‹ˆë‹¤." },
                { start: 1346, end: 1630, msg: "ì˜¤í›„ ìˆ˜ì—… ì‹œê°„ì…ë‹ˆë‹¤." },
                { start: 1709, end: 1830, msg: "ë°©ê³¼í›„ ììŠµì‹œê°„ì…ë‹ˆë‹¤." },
                { start: 1946, end: 2110, msg: "ì•¼ì 1íƒ€ì„ì…ë‹ˆë‹¤." },
                { start: 2129, end: 2300, msg: "ì•¼ì 2íƒ€ì„ì…ë‹ˆë‹¤." }
            ];

            for (const range of ranges) {
                if (time >= range.start && time <= range.end) return { restricted: true, msg: range.msg };
            }
            return { restricted: false };
        }

        // -----------------------------------------------------------
        // 2. ê³ ê¸‰ ê¸°ëŠ¥ ë° í”Œë ˆì´ì–´ í™•ì¥ ë¡œì§
        // -----------------------------------------------------------
        let isFeaturesExpanded = false;
        let isBgmListVisible = false;

        function toggleFeatures() {
            isFeaturesExpanded = !isFeaturesExpanded;
            const list = document.querySelector('.feature-list');
            const arrow = document.getElementById('feature-arrow');
            if(isFeaturesExpanded) { list.classList.add('active'); arrow.className = 'fas fa-chevron-down'; }
            else { list.classList.remove('active'); arrow.className = 'fas fa-chevron-right'; }
        }

        function toggleBgmPanel() {
            isBgmListVisible = !isBgmListVisible;
            document.getElementById('inline-bgm-container').classList.toggle('active', isBgmListVisible);
        }

        function toggleExpand(e) {
            // ë²„íŠ¼ í´ë¦­ ì‹œì—ëŠ” í™•ì¥ë˜ì§€ ì•Šê²Œ ë°©ì–´
            if (e.target.closest('.ctrl-btn')) return;
            document.getElementById('mini-player').classList.toggle('expanded');
        }

        function renderAdvancedFeatures() {
            const aside = document.querySelector('aside');
            if(!aside) return;
            aside.querySelector('.notice') && (aside.querySelector('.notice').style.display = 'none');
            
            if(!document.getElementById('advanced-features-container')) {
                const div = document.createElement('div');
                div.id = 'advanced-features-container';
                div.innerHTML = `
                    <div class="feature-header" onclick="toggleFeatures()">
                        <span>ë”ë³´ê¸°</span>
                        <i id="feature-arrow" class="fas fa-chevron-right"></i>
                    </div>
                    <div class="feature-list">
                        <button class="feature-btn" onclick="alert('ğŸš§ ê°œë°œ ì¤‘ì…ë‹ˆë‹¤!')"><i class="fas fa-calendar-alt" style="color:#4ade80"></i> ì‹œê°„í‘œ</button>
                        <button class="feature-btn" onclick="alert('ğŸš§ ê°œë°œ ì¤‘ì…ë‹ˆë‹¤!')"><i class="fas fa-utensils" style="color:#fb923c"></i> ê¸‰ì‹</button>
                        <button class="feature-btn" onclick="toggleBgmPanel()"><i class="fas fa-music" style="color:#c084fc"></i> BGM</button>
                        <div id="inline-bgm-container"></div>
                    </div>
                `;
                const stats = aside.querySelector('div');
                stats ? aside.insertBefore(div, stats.nextSibling) : aside.appendChild(div);

                const bgmBox = document.getElementById('inline-bgm-container');
                BGM_LIST.forEach(bgm => {
                    const item = document.createElement('div');
                    item.className = 'inline-bgm-item';
                    item.innerHTML = `<img src="${bgm.cover}" class="inline-bgm-cover"><div style="flex:1; overflow:hidden;"><div class="inline-bgm-title">${bgm.title}</div></div>`;
                    item.onclick = (e) => { e.stopPropagation(); tryPlayMusic(bgm); };
                    bgmBox.appendChild(item);
                });
            }
        }
        setInterval(renderAdvancedFeatures, 500);

        // -----------------------------------------------------------
        // 3. ì˜¤ë””ì˜¤ í•µì‹¬ ë¡œì§ (ì œí•œ ê¸°ëŠ¥ í†µí•©)
        // -----------------------------------------------------------
        const audio = document.getElementById('bgm-audio');
        const miniPlayer = document.getElementById('mini-player');
        const miniCover = document.getElementById('mini-cover');
        const miniTitle = document.getElementById('mini-title');
        const playIcon = document.getElementById('play-icon');
        const popup = document.getElementById('restriction-popup');
        let currentBgmData = null;
        let isPlaying = false;

        function tryPlayMusic(bgm) {
            const check = checkTimeRestriction();
            if (check.restricted) {
                showRestriction(check.msg);
                return;
            }
            
            currentBgmData = bgm;
            audio.src = bgm.src;
            audio.play();
            isPlaying = true;
            updatePlayerUI();
        }

        function handlePlayBtn(e) {
            e.stopPropagation();
            if (!currentBgmData) return;
            const check = checkTimeRestriction();
            if (!isPlaying && check.restricted) {
                showRestriction(check.msg);
                return;
            }
            togglePlay();
        }

        function updatePlayerUI() {
            miniPlayer.classList.add('active');
            miniCover.style.backgroundImage = `url('${currentBgmData.cover}')`;
            miniCover.classList.add('playing');
            miniTitle.innerText = currentBgmData.title;
            playIcon.className = 'fas fa-pause';
        }

        function togglePlay() {
            if(isPlaying) { audio.pause(); miniCover.classList.remove('playing'); playIcon.className = 'fas fa-play'; }
            else { audio.play(); miniCover.classList.add('playing'); playIcon.className = 'fas fa-pause'; }
            isPlaying = !isPlaying;
        }

        function stopMusic(e) {
            e.stopPropagation();
            audio.pause(); audio.currentTime = 0;
            miniPlayer.classList.remove('active', 'expanded');
            isPlaying = false;
        }

        // -----------------------------------------------------------
        // 4. íŒì—… ë° ê´€ë¦¬ì íŒ¨ìŠ¤ì›Œë“œ ë¡œì§
        // -----------------------------------------------------------
        let popupTimer;
        function showRestriction(msg) {
            document.getElementById('restriction-msg').innerText = msg;
            popup.style.display = 'flex';
            const pwInput = document.getElementById('admin-pw');
            pwInput.value = '';
            
            clearTimeout(popupTimer);
            popupTimer = setTimeout(() => { popup.style.display = 'none'; }, 5000);
        }

        document.getElementById('admin-pw').addEventListener('input', function(e) {
            if (this.value === ADMIN_PASSWORD) {
                bypassUntil = Date.now() + (5 * 60 * 1000); // 5ë¶„ ë¶€ì—¬
                popup.style.background = "#22c55e"; // ì´ˆë¡ìƒ‰ ë³€ê²½
                document.getElementById('restriction-msg').innerText = "ê´€ë¦¬ì ìŠ¹ì¸: 5ë¶„ê°„ í•´ì œ";
                setTimeout(() => { popup.style.display = 'none'; }, 1000);
                if (currentBgmData) { togglePlay(); }
            }
        });

        // -----------------------------------------------------------
        // 5. ëˆˆ íš¨ê³¼ & í”„ë¡œì íŠ¸ì‹¤ (ìƒëµ ì—†ì´ í†µí•©)
        // -----------------------------------------------------------
        (function() {
            const canvas = document.getElementById('snow-canvas');
            const ctx = canvas.getContext('2d');
            let width = window.innerWidth, height = window.innerHeight;
            canvas.width = width; canvas.height = height;
            const flakes = []; let accumulation = 0;
            for(let i=0;i<100;i++) flakes.push({x:Math.random()*width,y:Math.random()*-height,r:Math.random()*2+1,s:Math.random()+0.5,o:Math.random()*0.5+0.3});
            function draw() {
                ctx.clearRect(0,0,width,height);
                if(accumulation>0){ const g=ctx.createLinearGradient(0,height,0,height-accumulation); g.addColorStop(0,'rgba(255,255,255,0.4)'); g.addColorStop(1,'rgba(0,0,0,0)'); ctx.fillStyle=g; ctx.fillRect(0,height-accumulation,width,accumulation); }
                ctx.fillStyle='rgba(255,255,255,0.8)'; ctx.beginPath();
                flakes.forEach(f=>{
                    ctx.globalAlpha=f.o; ctx.moveTo(f.x,f.y); ctx.arc(f.x,f.y,f.r,0,Math.PI*2);
                    f.y+=f.s; if(f.y>height){ if(accumulation<30 && Math.random()>0.99) accumulation+=0.05; f.y=-5; f.x=Math.random()*width; }
                }); ctx.fill(); requestAnimationFrame(draw);
            }
            window.addEventListener('resize',()=>{width=window.innerWidth;height=window.innerHeight;canvas.width=width;canvas.height=height;}); draw();
        })();

        const PROJECT_ROOM_DATA = [
            { loc: "ë³¸ê´€3ì¸µ", name: "301í˜¸" }, { loc: "ë³¸ê´€3ì¸µ", name: "302í˜¸" }, { loc: "ë³¸ê´€3ì¸µ", name: "303í˜¸" }, { loc: "ë³¸ê´€3ì¸µ", name: "304í˜¸" }, { loc: "ë³¸ê´€3ì¸µ", name: "305í˜¸" }, { loc: "ë³¸ê´€3ì¸µ", name: "306í˜¸" }, { loc: "ë³¸ê´€3ì¸µ", name: "307í˜¸" },
            { loc: "ë³¸ê´€2ì¸µ", name: "201í˜¸" }, { loc: "ë³¸ê´€2ì¸µ", name: "202í˜¸" }, { loc: "ë³¸ê´€2ì¸µ", name: "203í˜¸" }, { loc: "ë³¸ê´€2ì¸µ", name: "íšŒê³„ì‹¤ë¬´ì‹¤" }, { loc: "ë³¸ê´€2ì¸µ", name: "ê´‘ê³ ì½˜í…ì¸ ì‹¤" },
            { loc: "ë³¸ê´€1ì¸µ", name: "ë¹„ì¦ˆì¿¨ì‹¤" }, { loc: "ë³¸ê´€1ì¸µ", name: "ë³´ê±´ì‹¤" },
            { loc: "ì‹ ê´€1ì¸µ", name: "ì„¸ë¯¸ë‚˜ì‹¤" }, { loc: "ì‹ ê´€1ì¸µ", name: "ì‚¬ë¬¼ì¸í„°ë„·ì‹¤" }, { loc: "ì‹ ê´€1ì¸µ", name: "ì‹œì²­ê°ì‹¤" }, { loc: "ì‹ ê´€1ì¸µ", name: "íœ´ë¨¸ë…¸ì´ë“œì‹¤" }, { loc: "ì‹ ê´€1ì¸µ", name: "ITí”„ë¡œì íŠ¸ì‹¤" },
            { loc: "ì‹ ê´€2ì¸µ", name: "ë©€í‹°ë¯¸ë””ì–´ì‹¤" }, { loc: "ì‹ ê´€2ì¸µ", name: "í¬ë¦¬ì—ì´í„°ì‹¤" }, { loc: "ì‹ ê´€2ì¸µ", name: "ìŒì•…ì‹¤" },
            { loc: "ì‹ ê´€3ì¸µ", name: "3Dì‹¤" }, { loc: "ì‹ ê´€3ì¸µ", name: "ë¹…ë°ì´í„°ì‹¤" },
            { loc: "ê¸°ìˆ™ì‚¬", name: "í•™ë´‰ê´€/ìš°ì •í•™ì‚¬" }, { loc: "ê¸°ìˆ™ì‚¬", name: "ë¯¸ìˆ ì‹¤" },
        ];

        window.openEtcModal = function(studentName, targetLane, callback) {
            const overlay = document.getElementById('custom-modal-overlay');
            const input = document.getElementById('custom-reason-input');
            const tableBody = document.getElementById('project-table-body');
            input.value = ''; overlay.style.display = 'flex'; input.focus();
            tableBody.innerHTML = '';
            PROJECT_ROOM_DATA.forEach(d => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td style="font-weight:bold">${d.loc}</td><td><button class="table-select-btn">${d.name}</button></td>`;
                tr.querySelector('button').onclick = () => { input.value = `${d.loc} ${d.name}`; input.focus(); };
                tableBody.appendChild(tr);
            });
            document.getElementById('modal-btn-save').onclick = () => { overlay.style.display = 'none'; callback(input.value.trim()); };
            document.getElementById('modal-btn-cancel').onclick = () => overlay.style.display = 'none';
        };
    </script>
  </body>
</html>
