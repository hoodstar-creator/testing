<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>í•™ìŠµ ì¥ì†Œ í˜„í™©íŒ</title>
    
    <link rel="stylesheet" crossorigin href="./style.css">
    <script type="module" crossorigin src="./script.js"></script>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <style>
      /* [1] PC í™”ë©´ ìŠ¤íƒ€ì¼ */
      #snow-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; pointer-events: none; }
      .form, .notice, .aside-announcement, ul.notice-ul:not(#my-custom-list) { display: none !important; }

      /* PC ì™¼ìª½ í•˜ë‹¨ ì—°ê²° ì½”ë“œ */
      #connection-display {
          position: fixed; bottom: 20px; left: 20px; 
          background: rgba(0,0,0,0.85); color: white; padding: 15px 20px; 
          border-radius: 12px; z-index: 10000; border: 1px solid #444;
          box-shadow: 0 4px 15px rgba(0,0,0,0.5); font-family: monospace;
          backdrop-filter: blur(5px);
      }
      #room-id-text { font-size: 2rem; font-weight: bold; color: #5ac4ff; letter-spacing: 3px; text-align: center; margin: 5px 0; }
      #pc-status-msg { font-size: 0.85rem; color: #00ff88; text-align: center; }

      /* [2] ëª¨ë°”ì¼ ë¦¬ëª¨ì»¨ ìŠ¤íƒ€ì¼ */
      body.mobile-mode { background: #f1f5f9; color: #1e293b; font-family: -apple-system, sans-serif; height: 100vh; overflow: hidden; margin: 0; }
      body.mobile-mode #app, body.mobile-mode #snow-canvas, body.mobile-mode #connection-display { display: none !important; }

      .mobile-container { max-width: 450px; margin: 0 auto; height: 100%; padding: 20px; display: flex; flex-direction: column; justify-content: center; box-sizing: border-box; }
      .hidden { display: none !important; }
      .fade-in { animation: fadeIn 0.4s ease; }

      .m-card { background: white; border-radius: 16px; padding: 24px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); width: 100%; box-sizing: border-box; }
      .m-title { font-size: 1.4rem; font-weight: 800; margin-bottom: 20px; color: #0f172a; text-align: center; letter-spacing: -0.5px; }
      
      .m-input { width: 100%; padding: 16px; border: 2px solid #e2e8f0; border-radius: 12px; margin-bottom: 12px; font-size: 1.2rem; text-align: center; box-sizing: border-box; transition: 0.2s; background: #f8fafc; color: #333; }
      .m-input:focus { border-color: #2563eb; background: #fff; outline: none; }
      
      .m-btn { width: 100%; padding: 16px; background: #2563eb; color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 1.1rem; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3); }
      .m-btn:active { transform: scale(0.97); }

      /* ì»¨íŠ¸ë¡¤ëŸ¬ í™”ë©´ */
      .status-box { background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 12px; padding: 15px; text-align: center; margin-bottom: 20px; }
      .status-label { font-size: 0.85rem; color: #64748b; margin-bottom: 4px; }
      .status-value { font-size: 1.3rem; font-weight: 800; color: #1e40af; }

      .loc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
      .loc-btn { 
          padding: 18px 10px; border: 1px solid #e2e8f0; background: white; 
          border-radius: 12px; font-weight: 600; cursor: pointer; color: #333;
          font-size: 1rem; display: flex; flex-direction: column; align-items: center; gap: 6px;
          box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: 0.1s;
      }
      .loc-btn:active { background: #f8fafc; transform: scale(0.96); border-color: #cbd5e1; }
      
      /* ì‚¬ìœ  ë±ƒì§€ (PC ìì„ì— ë¶™ìŒ) */
      .reason-badge {
          background: #ff4757; color: white; font-size: 0.7rem; padding: 2px 6px;
          border-radius: 4px; margin-top: 4px; font-weight: bold; display: block;
          white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%;
          animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }

      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }
    </style>
  </head>
  <body>
    <canvas id="snow-canvas"></canvas>
    <div id="app"></div>

    <div id="connection-display" style="display: none;">
        <h3>ğŸ”— ë¦¬ëª¨ì»¨ ì½”ë“œ</h3>
        <div id="room-id-text">...</div>
        <div id="pc-status-msg">ì—°ê²° ëŒ€ê¸° ì¤‘...</div>
    </div>

    <div id="screen-connect" class="mobile-container hidden">
        <div class="m-card fade-in">
            <h1 class="m-title">ë¦¬ëª¨ì»¨ ì—°ê²°</h1>
            <input type="number" id="input-room-code" class="m-input" placeholder="PC ì½”ë“œ 4ìë¦¬" inputmode="numeric">
            <button id="btn-connect-pc" class="m-btn">ì—°ê²°í•˜ê¸°</button>
        </div>
    </div>

    <div id="screen-login" class="mobile-container hidden">
        <div class="m-card fade-in">
            <h1 class="m-title">í•™ìƒ ë¡œê·¸ì¸</h1>
            <input type="tel" id="input-student-id" class="m-input" placeholder="í•™ë²ˆ (ì˜ˆ: 1201)" maxlength="4">
            <button id="btn-login" class="m-btn">ì…ì¥í•˜ê¸°</button>
        </div>
    </div>

    <div id="screen-dashboard" class="mobile-container hidden">
        <div class="m-card fade-in">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding-bottom:15px; border-bottom:1px solid #f1f5f9;">
                <div>
                    <span style="font-weight:800; font-size:1.3rem; color:#0f172a;" id="user-name-display">ì´ë¦„</span>
                    <span style="color:#64748b; font-size:0.9rem; margin-left:5px;" id="user-id-display"></span>
                </div>
                <button id="btn-logout" style="background:none; border:none; color:#94a3b8; text-decoration:underline; cursor:pointer; font-size:0.9rem;">ë‚˜ê°€ê¸°</button>
            </div>

            <div class="status-box">
                <div class="status-label">í˜„ì¬ ìƒíƒœ</div>
                <div id="current-status-text" class="status-value">êµì‹¤</div>
            </div>

            <div class="loc-grid">
                <button class="loc-btn" onclick="sendMove('room')">ğŸ« êµì‹¤</button>
                <button class="loc-btn" onclick="sendMove('afterschool')">ğŸ“š ë°©ê³¼í›„</button>
                <button class="loc-btn" onclick="sendMove('club')">âš½ ë™ì•„ë¦¬</button>
                <button class="loc-btn" onclick="sendMove('early')">ğŸƒ ì¡°ê¸°/ê²°ì„</button>
                <button class="loc-btn" onclick="sendMove('restroom')">ğŸš½ í™”ì¥ì‹¤/ì •ìˆ˜ê¸°</button>
                <button class="loc-btn" onclick="sendMove('etc')">ğŸ¸ ê¸°íƒ€</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // [ì„¤ì •] í•™ìƒ ëª…ë‹¨ (1201 ~ 1232)
        // ==========================================
        const STUDENT_DATA = [
            { id: '1201', name: 'êµ¬ë¯¼ì°¬' }, { id: '1202', name: 'ê¶Œì¬í˜„' }, { id: '1203', name: 'ê¹€ë¯¼ì±„' },
            { id: '1204', name: 'ê¹€ë³´ê²½' }, { id: '1205', name: 'ê¹€ì±„ê²½' }, { id: '1206', name: 'ë‚˜ê¸°ì°¬' },
            { id: '1207', name: 'ë°•ê·¼ìš°' }, { id: '1208', name: 'ë°•ì„œìœ¤' }, { id: '1209', name: 'ë°•ì„œí˜„' },
            { id: '1210', name: 'ë°•ì†Œìœ¨' }, { id: '1211', name: 'ë°•ì‹œí•˜' }, { id: '1212', name: 'ë°•ì¬ìœ¤' },
            { id: '1213', name: 'ë°•ì´ˆì—°' }, { id: '1214', name: 'ì–‘ì„¸ë¦°' }, { id: '1215', name: 'ì—„ë¡œì´' },
            { id: '1216', name: 'ìœ ìŠ¹í›„' }, { id: '1217', name: 'ì´ê·œì›' }, { id: '1218', name: 'ì´ë‚˜ê²½' },
            { id: '1219', name: 'ì´ì˜ˆì¤€' }, { id: '1220', name: 'ì´ì§€ì›' }, { id: '1221', name: 'ì •ì´í˜„' },
            { id: '1222', name: 'ì •íƒœê²¸' }, { id: '1223', name: 'ì¡°ë¯¼ì„œ' }, { id: '1224', name: 'ì¡°ìœ¨í¬' },
            { id: '1225', name: 'ì§€ì•„ë¦¼' }, { id: '1226', name: 'ìµœì˜ˆì§„' }, { id: '1227', name: 'ìµœìœ í˜' },
            { id: '1228', name: 'í•˜ì‹œì€' }, { id: '1229', name: 'í•œì§„í™˜' }, { id: '1230', name: 'í—ˆìœ ì •' },
            { id: '1232', name: 'ê¹€ë²”ì¤€' }
        ];

        // P2P í†µì‹  ì„¤ì • (êµ¬ê¸€ STUN ì„œë²„ ì‚¬ìš©)
        const peerConfig = {
            config: { 'iceServers': [ { urls: 'stun:stun.l.google.com:19302' } ] }
        };

        const urlParams = new URLSearchParams(window.location.search);
        const isMobile = urlParams.get('mode') === 'mobile';
        let peer = null;
        let conn = null;
        let myName = "";
        let myId = "";

        // ----------------------------------------------------------------
        // [A] ëª¨ë°”ì¼ ë¦¬ëª¨ì»¨ ë¡œì§
        // ----------------------------------------------------------------
        if (isMobile) {
            document.body.classList.add('mobile-mode');
            showScreen('screen-connect');

            // 1. PC ì—°ê²°
            document.getElementById('btn-connect-pc').onclick = () => {
                const code = document.getElementById('input-room-code').value.trim();
                if (code.length < 3) return alert("ì½”ë“œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");

                document.getElementById('btn-connect-pc').innerText = "ì—°ê²° ì¤‘...";
                peer = new Peer(peerConfig);
                
                peer.on('open', () => {
                    conn = peer.connect(`dimiboard-${code}`);
                    conn.on('open', () => { showScreen('screen-login'); });
                    conn.on('error', () => { alert("ì—°ê²° ì‹¤íŒ¨! ì½”ë“œë¥¼ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”."); document.getElementById('btn-connect-pc').innerText = "ì—°ê²°í•˜ê¸°"; });
                    conn.on('close', () => { alert("ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤."); location.reload(); });
                });
            };

            // 2. ë¡œê·¸ì¸
            document.getElementById('btn-login').onclick = () => {
                const inputId = document.getElementById('input-student-id').value.trim();
                const student = STUDENT_DATA.find(s => s.id === inputId);

                if (student) {
                    myName = student.name;
                    myId = student.id;
                    document.getElementById('user-name-display').innerText = myName;
                    document.getElementById('user-id-display').innerText = myId;
                    showScreen('screen-dashboard');
                } else {
                    alert("ëª…ë‹¨ì— ì—†ëŠ” í•™ë²ˆì…ë‹ˆë‹¤.");
                }
            };

            // 3. ì´ë™ ëª…ë ¹ ì „ì†¡
            window.sendMove = function(locationType) {
                if (!conn || !conn.open) return alert("PCì™€ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.");
                
                let reason = "";
                let displayLoc = "";

                if(locationType === 'room') displayLoc = "êµì‹¤";
                else if(locationType === 'afterschool') displayLoc = "ë°©ê³¼í›„";
                else if(locationType === 'club') displayLoc = "ë™ì•„ë¦¬";
                else if(locationType === 'early') displayLoc = "ì¡°ê¸°ì…ì‹¤/ê²°ì„";
                else if(locationType === 'restroom') displayLoc = "í™”ì¥ì‹¤/ì •ìˆ˜ê¸°";
                else if(locationType === 'etc') {
                    reason = prompt("ê¸°íƒ€ ì‚¬ìœ  ì…ë ¥");
                    if (!reason) return;
                    displayLoc = `ê¸°íƒ€ (${reason})`;
                }

                document.getElementById('current-status-text').innerText = displayLoc;
                
                // ë°ì´í„° ì „ì†¡
                conn.send({ type: 'move', name: myName, id: myId, target: locationType, reason: reason });
            };

            document.getElementById('btn-logout').onclick = () => {
                showScreen('screen-login');
                document.getElementById('input-student-id').value = '';
            };

            function showScreen(id) {
                document.querySelectorAll('.mobile-container').forEach(el => el.classList.add('hidden'));
                document.getElementById(id).classList.remove('hidden');
            }
        } 
        
        // ----------------------------------------------------------------
        // [B] PC í˜„í™©íŒ ë¡œì§
        // ----------------------------------------------------------------
        else {
            const roomCode = Math.floor(1000 + Math.random() * 9000);
            peer = new Peer(`dimiboard-${roomCode}`, peerConfig);

            peer.on('open', (id) => {
                document.getElementById('connection-display').style.display = 'block';
                document.getElementById('room-id-text').innerText = roomCode;
            });

            peer.on('connection', (connection) => {
                document.getElementById('pc-status-msg').innerText = "ğŸŸ¢ í°ê³¼ ì—°ê²°ë¨!";
                connection.on('data', (data) => {
                    if (data.type === 'move') {
                        let targetLane = 'etc'; // ê¸°ë³¸ê°’ (ì—†ëŠ” ë ˆì¸ì€ ì—¬ê¸°ë¡œ ë³´ëƒ„)
                        let reasonText = "";

                        // [ì¥ì†Œ ë§¤í•‘ ë¡œì§]
                        if (data.target === 'room') {
                            targetLane = 'room'; // êµì‹¤ì€ ì‹¤ì œ ë ˆì¸ ìˆìŒ
                        } else if (data.target === 'restroom') {
                            targetLane = 'toilet'; // í™”ì¥ì‹¤ì€ ë³´í†µ toilet ë ˆì¸ ì‚¬ìš©
                        } else {
                            // ë°©ê³¼í›„, ë™ì•„ë¦¬, ì¡°ê¸°ì…ì‹¤ ë“±ì€ 'etc'ë¡œ ë³´ë‚´ê³  ë¼ë²¨ ë¶™ì„
                            targetLane = 'etc';
                            if (data.target === 'afterschool') reasonText = "ë°©ê³¼í›„";
                            else if (data.target === 'club') reasonText = "ë™ì•„ë¦¬";
                            else if (data.target === 'early') reasonText = "ì¡°ê¸°/ê²°ì„";
                            else if (data.target === 'etc') reasonText = data.reason;
                        }

                        // ìì„ ì´ë™ ì‹¤í–‰
                        moveMagnetSmart(data.name, data.id, targetLane, reasonText);
                    }
                });
                connection.on('close', () => { document.getElementById('pc-status-msg').innerText = "ğŸ”´ ì—°ê²° ëŠê¹€"; });
            });

            // [ë˜‘ë˜‘í•œ ìì„ ì´ë™ í•¨ìˆ˜] 1201 -> êµ¬ë¯¼ì°¬ ë˜ëŠ” 1ë²ˆ ì°¾ê¸°
            function moveMagnetSmart(studentName, studentId, targetLane, reason) {
                const chips = document.querySelectorAll('.chip');
                let targetChip = null;

                // 1. ì´ë¦„ìœ¼ë¡œ ì°¾ê¸° ("êµ¬ë¯¼ì°¬")
                chips.forEach(chip => {
                    if (chip.innerText.includes(studentName)) targetChip = chip;
                });

                // 2. ì´ë¦„ìœ¼ë¡œ ëª» ì°¾ìœ¼ë©´ ë²ˆí˜¸ë¡œ ì°¾ê¸° (1201 -> "1")
                if (!targetChip && studentId) {
                    const seatNumber = parseInt(studentId) - 1200; // 1201 -> 1
                    chips.forEach(chip => {
                        // ì¹© í…ìŠ¤íŠ¸ê°€ ì •í™•íˆ ìˆ«ìë§Œ ìˆê±°ë‚˜, "1 " ì²˜ëŸ¼ ë˜ì–´ìˆì„ ìˆ˜ ìˆìŒ
                        if (chip.innerText.trim() === String(seatNumber)) targetChip = chip;
                    });
                }

                if (targetChip) {
                    // ëª©ì ì§€ ì°¾ê¸° (script.jsì˜ data-lane í™œìš©)
                    let destContainer = document.querySelector(`div[data-lane="${targetLane}"]`);
                    // .lane ë‚´ë¶€ì˜ ì‹¤ì œ ì»¨í…Œì´ë„ˆ(ë³´í†µ ë§ˆì§€ë§‰ div) ì¡ê¸°
                    const realDest = destContainer ? (destContainer.querySelector('div:last-child') || destContainer) : null;

                    if (realDest) {
                        realDest.appendChild(targetChip);
                        
                        // ì‚¬ìœ  ë±ƒì§€ ë‹¬ê¸°/ë–¼ê¸°
                        let badge = targetChip.querySelector('.reason-badge');
                        if (reason) {
                            if (!badge) {
                                badge = document.createElement('div');
                                badge.className = 'reason-badge';
                                targetChip.appendChild(badge);
                            }
                            badge.innerText = reason;
                        } else {
                            if (badge) badge.remove();
                        }
                    }
                }
            }

            // [ê¸°íƒ€] ëˆˆ íš¨ê³¼ ë° ì¼ì •í‘œ (ê¸°ì¡´ ìœ ì§€)
            (function() {
                const canvas = document.getElementById('snow-canvas');
                const ctx = canvas.getContext('2d');
                let width = window.innerWidth, height = window.innerHeight;
                canvas.width = width; canvas.height = height;
                const flakes = [];
                for(let i=0;i<100;i++) flakes.push({x:Math.random()*width,y:Math.random()*-height,r:Math.random()*2+1,s:Math.random()+0.5,o:Math.random()*0.5+0.3});
                function draw() {
                    ctx.clearRect(0,0,width,height); ctx.fillStyle='rgba(255,255,255,0.8)'; ctx.beginPath();
                    flakes.forEach(f=>{ ctx.globalAlpha=f.o; ctx.moveTo(f.x,f.y); ctx.arc(f.x,f.y,f.r,0,Math.PI*2); f.y+=f.s; if(f.y>height){f.y=-5;f.x=Math.random()*width;} });
                    ctx.fill(); requestAnimationFrame(draw);
                }
                window.addEventListener('resize',()=>{width=window.innerWidth;height=window.innerHeight;canvas.width=width;canvas.height=height;}); draw();
            })();

            const MY_TITLE="1ì°¨ ì§€í•„í‰ê°€"; const D_DAY_DATE="2024-12-16"; 
            const MY_SCHEDULES=[{subject:'ìˆ˜í•™',content:'ì‚¼ê°í•¨ìˆ˜ ~ ìˆ˜ì—´',color:'c-red'},{subject:'ì˜ì–´',content:'ìˆ˜ëŠ¥íŠ¹ê°• 3ê°•, 4ê°•',color:'c-blue'},{subject:'êµ­ì–´',content:'ë¬¸í•™ ì‘í’ˆ ë¶„ì„',color:'c-green'},{subject:'ì •ë³´',content:'íŒŒì´ì¬ ìˆ˜í–‰í‰ê°€',color:'c-yellow'}];
            function calculateDDay(t){const d=new Date(t);const n=new Date();d.setHours(0,0,0,0);n.setHours(0,0,0,0);const x=Math.ceil((d-n)/864e5);return x===0?"D-Day":x>0?"D-"+x:"D+"+Math.abs(x);}
            function renderMyBoard(){
                const aside=document.querySelector('aside'); if(!aside)return;
                const ori=aside.querySelector('.notice'); if(ori)ori.style.display='none';
                if(!document.getElementById('my-dashboard-container')){
                    const c=document.createElement('div'); c.id='my-dashboard-container';
                    const u=document.createElement('ul'); u.id='my-custom-list'; u.className='notice-ul';
                    const s=aside.querySelector('div'); if(s){aside.appendChild(c);aside.appendChild(u);}
                }
                const c=document.getElementById('my-dashboard-container');
                const h=`<span class="my-title">${MY_TITLE}</span><span class="my-dday-badge">${calculateDDay(D_DAY_DATE)}</span>`;
                if(c.innerHTML!==h)c.innerHTML=h;
                const u=document.getElementById('my-custom-list');
                const l=MY_SCHEDULES.map(i=>`<li class="${i.color}"><span class="type-tag">${i.subject}</span><span>${i.content}</span></li>`).join('');
                if(u.innerHTML!==l)u.innerHTML=l;
            }
            setInterval(renderMyBoard,100);
        }
    </script>
  </body>
</html>
