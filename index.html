<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>í•™ìŠµ ì¥ì†Œ í˜„í™©íŒ</title>
    
    <link rel="stylesheet" crossorigin href="./style.css">
    <script type="module" crossorigin src="./script.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
      /* [1. ëˆˆ ë‚´ë¦¬ëŠ” íš¨ê³¼] */
      #snow-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; pointer-events: none; }

      /* [2. í™”ë©´ ì •ë¦¬ - ë¶ˆí•„ìš”í•œ ìš”ì†Œ ìˆ¨ê¹€] */
      .form { display: none !important; }
      .notice, .aside-announcement, ul.notice-ul { display: none !important; }

      /* [3. ê³ ê¸‰ ê¸°ëŠ¥ ì„¹ì…˜ (ì¼ì •í‘œ ìë¦¬)] */
      #advanced-features-container {
          text-align: center; margin-top: 20px; margin-bottom: 20px;
          animation: fadeIn 0.8s ease; position: relative; z-index: 1;
      }
      .feature-title {
          font-weight: 700; font-size: 1.4rem; color: #5ac4ff;
          margin-bottom: 15px; display: block;
      }
      .feature-grid {
          display: grid; grid-template-columns: 1fr; gap: 10px; padding: 0 10px;
      }
      .feature-btn {
          background: #2a2d35; border: 1px solid #444; color: #e8ecf3;
          padding: 15px; border-radius: 10px; font-size: 1rem; font-weight: 600;
          cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px;
      }
      .feature-btn:hover { background: #333; border-color: #666; transform: translateY(-2px); }

      /* [4. BGM í”Œë ˆì´ì–´ íŒì—… & ë¯¸ë‹ˆ í”Œë ˆì´ì–´] */
      .bgm-list-item {
          display: flex; align-items: center; gap: 15px; padding: 12px;
          border-bottom: 1px solid #333; cursor: pointer; transition: 0.2s;
      }
      .bgm-list-item:hover { background: #252830; }
      .bgm-cover { width: 50px; height: 50px; border-radius: 6px; object-fit: cover; }
      .bgm-info { flex-grow: 1; text-align: left; }
      .bgm-title { font-weight: bold; color: #fff; font-size: 1rem; }
      .bgm-desc { color: #888; font-size: 0.8rem; }

      #mini-player {
          position: fixed; bottom: 30px; left: 30px; z-index: 99999;
          display: flex; align-items: center; gap: 15px;
          background: rgba(0,0,0,0.8); padding: 10px 20px 10px 10px;
          border-radius: 50px; border: 1px solid #444;
          box-shadow: 0 5px 20px rgba(0,0,0,0.6); backdrop-filter: blur(5px);
          transition: transform 0.3s; transform: translateY(150%);
      }
      #mini-player.active { transform: translateY(0); }
      
      .vinyl-record {
          width: 50px; height: 50px; border-radius: 50%;
          background-size: cover; background-position: center;
          border: 2px solid #222; animation: spin 4s linear infinite; animation-play-state: paused;
      }
      .vinyl-record.playing { animation-play-state: running; }
      .player-info { color: white; display: flex; flex-direction: column; }
      .player-title { font-size: 0.9rem; font-weight: bold; }
      .ctrl-btn { background: none; border: none; color: #ccc; cursor: pointer; font-size: 1.1rem; }
      .ctrl-btn:hover { color: white; }
      @keyframes spin { 100% { transform: rotate(360deg); } }

      /* [5. íŒì—…ì°½ (ë¶„ë¦¬í˜•)] */
      .modal-overlay {
          position: fixed; top: 0; left: 0; width: 100%; height: 100%;
          background: rgba(0, 0, 0, 0.8); z-index: 10000;
          display: flex; align-items: center; justify-content: center;
          gap: 40px; backdrop-filter: blur(5px); animation: fadeIn 0.2s ease;
          padding: 20px; box-sizing: border-box;
      }
      .window-reason, .window-project, .window-bgm {
          background: #1e2025; border: 1px solid #333; border-radius: 12px;
          padding: 25px; box-shadow: 0 20px 50px rgba(0,0,0,0.6);
          display: flex; flex-direction: column; max-height: 80vh;
      }
      .window-reason { width: 400px; z-index: 2; }
      .window-project { width: 350px; height: 500px; z-index: 1; }
      .window-bgm { width: 400px; height: 500px; z-index: 3; }

      @media (max-width: 850px) {
          .modal-overlay { flex-direction: column; overflow-y: auto; }
          .window-reason, .window-project { width: 100%; max-width: 500px; height: auto; }
          .window-project { height: 300px; }
      }

      /* ì œëª© ë° ì…ë ¥ì°½ ë“± */
      .window-title { color: #fff; margin: 0 0 20px 0; font-size: 1.3rem; font-weight: 700; padding-bottom: 15px; border-bottom: 1px solid #333; text-align: center; }
      .section-title { color: #ffffff; font-size: 0.95rem; font-weight: 600; margin-bottom: 10px; }
      .sub-label { color: #888; font-size: 0.8rem; margin-bottom: 8px; margin-top: 15px; }
      .modal-input { width: 100%; padding: 14px; border-radius: 8px; border: 1px solid #444; background: #2a2d35; color: white; font-size: 1.1rem; outline: none; box-sizing: border-box; }
      .modal-input:focus { border-color: #ffffff; background: #252830; }
      
      /* ì¹© & ë²„íŠ¼ */
      .chip-container { display: flex; flex-wrap: wrap; gap: 8px; }
      .recent-reason-btn { background: #2a2d35; border: 1px solid #444; color: #ccc; padding: 8px 12px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; transition: 0.2s; }
      .recent-reason-btn:hover { background: #333; border-color: #666; color: white; }
      .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: auto; padding-top: 20px; }
      .modal-btn { padding: 10px 24px; border-radius: 8px; border: none; cursor: pointer; font-weight: 700; font-size: 1rem; }
      .modal-btn.cancel { background: #333; color: #ccc; } 
      .modal-btn.save { background: #2563eb; color: white; }

      /* í‘œ ìŠ¤íƒ€ì¼ */
      .table-container { flex-grow: 1; overflow-y: auto; border: 1px solid #333; border-radius: 8px; background: #15171c; }
      .project-table { width: 100%; border-collapse: collapse; text-align: center; font-size: 0.9rem; }
      .project-table th { background: #252830; color: #ccc; padding: 12px; border-bottom: 1px solid #444; position: sticky; top: 0; z-index: 10; }
      .project-table td { border-bottom: 1px solid #333; padding: 8px; color: #aaa; vertical-align: middle; }
      .project-table tr:hover { background: #2a2d35; }
      .table-select-btn { background: #2563eb; color: white; border: none; padding: 6px 0; border-radius: 4px; cursor: pointer; font-size: 0.9rem; width: 90%; font-weight: 500; transition: 0.2s; }
      .table-select-btn:hover { background: #1d4ed8; transform: scale(1.02); }

      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
  </head>
  <body>
    <canvas id="snow-canvas"></canvas>
    
    <div id="app"></div>

    <div id="mini-player">
        <div id="mini-cover" class="vinyl-record"></div>
        <div class="player-info">
            <span id="mini-title" class="player-title">ì¬ìƒ ì¤‘ì¸ ê³¡ ì—†ìŒ</span>
            <div class="player-controls">
                <button class="ctrl-btn" onclick="togglePlay()"><i id="play-icon" class="fas fa-play"></i></button>
                <button class="ctrl-btn" onclick="stopMusic()"><i class="fas fa-stop"></i></button>
            </div>
        </div>
        <audio id="bgm-audio"></audio>
    </div>

    <div id="custom-modal-overlay" class="modal-overlay" style="display: none;">
        <div class="window-reason">
            <h3 class="window-title">ê¸°íƒ€ ì´ë™ ì‚¬ìœ </h3>
            <p class="section-title">ì…ë ¥</p>
            <div class="input-wrapper"><input type="text" id="custom-reason-input" class="modal-input" placeholder="ì‚¬ìœ  ì…ë ¥" autocomplete="off"></div>
            <div id="recent-reasons-container" style="display: none;"><p class="sub-label">ìµœê·¼/ê³ ì •</p><div id="recent-reasons-list" class="chip-container"></div></div>
            <div class="modal-buttons"><button id="modal-btn-cancel" class="modal-btn cancel">ì·¨ì†Œ</button><button id="modal-btn-save" class="modal-btn save">í™•ì¸</button></div>
        </div>
        <div class="window-project">
            <h3 class="window-title">í”„ë¡œì íŠ¸ì‹¤ ëª©ë¡</h3>
            <div class="table-container">
                <table class="project-table"><thead><tr><th width="35%">ìœ„ì¹˜</th><th width="65%">ëª…ì¹­</th></tr></thead><tbody id="project-table-body"></tbody></table>
            </div>
        </div>
    </div>

    <div id="bgm-modal-overlay" class="modal-overlay" style="display: none;">
        <div class="window-bgm">
            <h3 class="window-title">ğŸµ BGM ì„ íƒ</h3>
            <div class="table-container" id="bgm-list-container">
                </div>
            <div class="modal-buttons">
                <button onclick="closeBgmModal()" class="modal-btn cancel" style="width:100%">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // [ì„¤ì • 1] í”„ë¡œì íŠ¸ì‹¤ ëª©ë¡
        // ==========================================
        const PROJECT_ROOM_DATA = [
            { loc: "ë³¸ê´€3ì¸µ", name: "301í˜¸" }, { loc: "", name: "302í˜¸" }, { loc: "", name: "303í˜¸" }, { loc: "", name: "304í˜¸" }, { loc: "", name: "305í˜¸" }, { loc: "", name: "306í˜¸" }, { loc: "", name: "307í˜¸" },
            { loc: "ë³¸ê´€2ì¸µ", name: "201í˜¸" }, { loc: "", name: "202í˜¸" }, { loc: "", name: "203í˜¸" }, { loc: "", name: "íšŒê³„ì‹¤ë¬´" }, { loc: "", name: "ê´‘ê³ ì½˜í…ì¸ " },
            { loc: "ë³¸ê´€1ì¸µ", name: "ë¹„ì¦ˆì¿¨ì‹¤" }, { loc: "", name: "ë³´ê±´ì‹¤" },
            { loc: "ì‹ ê´€1ì¸µ", name: "ì„¸ë¯¸ë‚˜ì‹¤" }, { loc: "", name: "IoTì‹¤" }, { loc: "", name: "ì‹œì²­ê°ì‹¤" }, { loc: "", name: "íœ´ë¨¸ë…¸ì´ë“œ" }, { loc: "", name: "ITí”„ë¡œì íŠ¸" },
            { loc: "ì‹ ê´€2ì¸µ", name: "ë©€í‹°ë¯¸ë””ì–´" }, { loc: "", name: "í¬ë¦¬ì—ì´í„°" }, { loc: "", name: "ìŒì•…ì‹¤" },
            { loc: "ì‹ ê´€3ì¸µ", name: "3Dì‹¤" }, { loc: "", name: "ë¹…ë°ì´í„°" },
            { loc: "ê¸°ìˆ™ì‚¬", name: "í•™ë´‰ê´€/ìš°ì •" }, { loc: "", name: "ë¯¸ìˆ ì‹¤" },
        ];

// [ì„¤ì • 2] BGM ëª©ë¡ (ì—¬ê¸°ë§Œ ìˆ˜ì •í•˜ë©´ ë©ë‹ˆë‹¤!)
        const BGM_LIST = [
            { 
                title: "ë‚´ê°€ ì¢‹ì•„í•˜ëŠ” ë…¸ë˜",      // ë…¸ë˜ ì œëª©
                desc: "ì‹ ë‚˜ëŠ” ì¼€ì´íŒ",           // ë…¸ë˜ ì„¤ëª… (ì‘ê²Œ ë‚˜ì˜´)
                cover: "./assets/cover.jpg",   // ì•¨ë²” ì»¤ë²„ ì´ë¯¸ì§€ ê²½ë¡œ (ë˜ëŠ” ì¸í„°ë„· ì£¼ì†Œ)
                src: "./assets/music.mp3"      // ìŒì•… íŒŒì¼ ê²½ë¡œ (ë˜ëŠ” ì¸í„°ë„· ì£¼ì†Œ)
            },
            { 
                title: "ì”ì”í•œ í”¼ì•„ë…¸", 
                desc: "ê³µë¶€í•  ë•Œ ë“£ëŠ” ë…¸ë˜", 
                cover: "https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?w=100", // ì´ë¯¸ì§€ëŠ” ì¸í„°ë„· ì£¼ì†Œ ì¨ë„ ë¨
                src: "./assets/piano.mp3" 
            },
            // í•„ìš”í•œ ë§Œí¼ { ... } ë©ì–´ë¦¬ë¥¼ ë³µì‚¬í•´ì„œ ì¶”ê°€í•˜ì„¸ìš”
        ];

        // [ì„¤ì • 3] ì‚¬ìœ  ê´€ë ¨
        const RECENT_REASONS_KEY = 'my_recent_reasons'; 
        const FIXED_REASONS = ['ì¡°ê¸°ì…ì‹¤', 'ì™¸ì¶œ'];
        const BLACKLIST_KEYWORDS = ['ë„í‹°','ê³µë£¡'];

        function getRecentReasons() { const json = localStorage.getItem(RECENT_REASONS_KEY); return json ? JSON.parse(json) : []; }
        function addRecentReason(reason) {
            for (const k of BLACKLIST_KEYWORDS) if (reason.includes(k)) return;
            if (FIXED_REASONS.includes(reason)) return;
            let list = getRecentReasons();
            list = list.filter(r => r !== reason); list.unshift(reason);
            if (list.length > 5) list.pop();
            localStorage.setItem(RECENT_REASONS_KEY, JSON.stringify(list));
        }

        // ==========================================
        // [1] ê³ ê¸‰ ê¸°ëŠ¥ ë©”ë‰´ ë Œë”ë§ (ì¼ì •í‘œ ëŒ€ì‹ )
        // ==========================================
        function renderFeatures() {
            const aside = document.querySelector('aside');
            if(!aside) return;
            const ori = aside.querySelector('.notice'); if(ori) ori.style.display='none';
            
            if(!document.getElementById('advanced-features-container')) {
                const div = document.createElement('div');
                div.id = 'advanced-features-container';
                div.innerHTML = `
                    <span class="feature-title">.</span>
                    <div class="feature-grid">
                        <button class="feature-btn" onclick="alert('ğŸš§ ì‹œê°„í‘œ ê¸°ëŠ¥ì€ ê°œë°œ ì¤‘ì…ë‹ˆë‹¤!')"><i class="fas fa-calendar-alt" style="color:#4ade80"></i> ì‹œê°„í‘œ</button>
                        <button class="feature-btn" onclick="alert('ğŸš§ ê¸‰ì‹ ê¸°ëŠ¥ì€ ê°œë°œ ì¤‘ì…ë‹ˆë‹¤!')"><i class="fas fa-utensils" style="color:#fb923c"></i> ê¸‰ì‹</button>
                        <button class="feature-btn" onclick="openBgmModal()"><i class="fas fa-music" style="color:#c084fc"></i> BGM ë“£ê¸°</button>
                    </div>
                `;
                const stats = aside.querySelector('div');
                if(stats) aside.insertBefore(div, stats.nextSibling);
                else aside.appendChild(div);
            }
        }
        setInterval(renderFeatures, 500);

        // ==========================================
        // [2] BGM í”Œë ˆì´ì–´ ë¡œì§
        // ==========================================
        const audio = document.getElementById('bgm-audio');
        const miniPlayer = document.getElementById('mini-player');
        const miniCover = document.getElementById('mini-cover');
        const miniTitle = document.getElementById('mini-title');
        const playIcon = document.getElementById('play-icon');
        let isPlaying = false;

        window.openBgmModal = function() {
            const modal = document.getElementById('bgm-modal-overlay');
            const listContainer = document.getElementById('bgm-list-container');
            listContainer.innerHTML = '';
            
            BGM_LIST.forEach(bgm => {
                const item = document.createElement('div');
                item.className = 'bgm-list-item';
                item.innerHTML = `
                    <img src="${bgm.cover}" class="bgm-cover">
                    <div class="bgm-info">
                        <div class="bgm-title">${bgm.title}</div>
                        <div class="bgm-desc">${bgm.desc}</div>
                    </div>
                    <i class="fas fa-play-circle" style="color:#5ac4ff; font-size:1.5rem;"></i>
                `;
                item.onclick = () => playMusic(bgm);
                listContainer.appendChild(item);
            });
            modal.style.display = 'flex';
        };

        window.closeBgmModal = function() { document.getElementById('bgm-modal-overlay').style.display = 'none'; };

        window.playMusic = function(bgm) {
            audio.src = bgm.src;
            audio.play();
            isPlaying = true;
            
            miniPlayer.classList.add('active');
            miniCover.style.backgroundImage = `url('${bgm.cover}')`;
            miniCover.classList.add('playing');
            miniTitle.innerText = bgm.title;
            playIcon.className = 'fas fa-pause';
            
            closeBgmModal();
        };

        window.togglePlay = function() {
            if(isPlaying) { audio.pause(); miniCover.classList.remove('playing'); playIcon.className = 'fas fa-play'; }
            else { audio.play(); miniCover.classList.add('playing'); playIcon.className = 'fas fa-pause'; }
            isPlaying = !isPlaying;
        };

        window.stopMusic = function() {
            audio.pause(); audio.currentTime = 0;
            miniPlayer.classList.remove('active');
            isPlaying = false;
        };

        // ==========================================
        // [3] ì‚¬ìœ  ì…ë ¥ íŒì—… ë¡œì§ (ê¸°ì¡´ ìœ ì§€)
        // ==========================================
        window.openEtcModal = function(studentName, targetLane, callback) {
            const overlay = document.getElementById('custom-modal-overlay');
            const input = document.getElementById('custom-reason-input');
            const btnSave = document.getElementById('modal-btn-save');
            const btnCancel = document.getElementById('modal-btn-cancel');
            const recentContainer = document.getElementById('recent-reasons-container');
            const recentList = document.getElementById('recent-reasons-list');
            const tableBody = document.getElementById('project-table-body');

            input.value = ''; overlay.style.display = 'flex'; input.focus();

            const savedReasons = getRecentReasons();
            const allReasons = [...savedReasons, ...FIXED_REASONS];
            recentList.innerHTML = '';
            if (allReasons.length > 0) {
                recentContainer.style.display = 'block';
                allReasons.forEach(txt => {
                    const btn = document.createElement('button'); btn.className = 'recent-reason-btn';
                    if (FIXED_REASONS.includes(txt)) { btn.style.borderColor = '#5ac4ff'; btn.style.color = '#5ac4ff'; }
                    btn.innerText = txt; btn.onclick = () => { input.value = txt; input.focus(); };
                    recentList.appendChild(btn);
                });
            } else recentContainer.style.display = 'none';

            tableBody.innerHTML = '';
            PROJECT_ROOM_DATA.forEach(d => {
                const tr = document.createElement('tr');
                const tdLoc = document.createElement('td'); tdLoc.innerText = d.loc; tdLoc.style.fontWeight="bold";
                const tdName = document.createElement('td');
                const btn = document.createElement('button'); btn.className = 'table-select-btn'; btn.innerText = d.name;
                btn.onclick = () => { input.value = `${d.loc} ${d.name}`; input.focus(); };
                tdName.appendChild(btn); tr.appendChild(tdLoc); tr.appendChild(tdName);
                tableBody.appendChild(tr);
            });

            const onSave = () => {
                const r = input.value.trim();
                if(!r) { alert("ì‚¬ìœ  ì…ë ¥!"); input.focus(); return; }
                addRecentReason(r); overlay.style.display = 'none'; callback(r); cleanup();
            };
            const onCancel = () => { overlay.style.display = 'none'; cleanup(); };
            const cleanup = () => {
                btnSave.removeEventListener('click', onSave);
                btnCancel.removeEventListener('click', onCancel);
                input.removeEventListener('keydown', onEnter);
            };
            const onEnter = (e) => { if(e.key === 'Enter') onSave(); };
            btnSave.addEventListener('click', onSave); btnCancel.addEventListener('click', onCancel); input.addEventListener('keydown', onEnter);
        };

        // ==========================================
        // [4] ëˆˆ ë‚´ë¦¬ëŠ” íš¨ê³¼
        // ==========================================
        (function() {
            const canvas = document.getElementById('snow-canvas');
            const ctx = canvas.getContext('2d');
            let width = window.innerWidth, height = window.innerHeight;
            canvas.width = width; canvas.height = height;
            const flakes = []; let accumulation = 0;
            for(let i=0;i<120;i++) flakes.push({x:Math.random()*width,y:Math.random()*-height,r:Math.random()*2+1,s:Math.random()+0.5,o:Math.random()*0.5+0.3});
            
            function draw() {
                ctx.clearRect(0,0,width,height);
                if(accumulation > 0) {
                    const g = ctx.createLinearGradient(0, height, 0, height - accumulation);
                    g.addColorStop(0, 'rgba(255,255,255,0.4)'); g.addColorStop(1, 'rgba(0,0,0,0)');
                    ctx.fillStyle = g; ctx.fillRect(0, height - accumulation, width, accumulation);
                }
                ctx.fillStyle = 'rgba(255,255,255,0.7)'; ctx.beginPath();
                flakes.forEach(f => {
                    ctx.globalAlpha = f.o; ctx.moveTo(f.x, f.y); ctx.arc(f.x, f.y, f.r, 0, Math.PI*2);
                    f.y += f.s;
                    if(f.y > height) {
                        if(accumulation < 40 && Math.random() > 0.99) accumulation += 0.05;
                        f.y = -5; f.x = Math.random() * width;
                    }
                });
                ctx.fill(); requestAnimationFrame(draw);
            }
            window.addEventListener('resize', () => { width=window.innerWidth; height=window.innerHeight; canvas.width=width; canvas.height=height; });
            draw();
        })();
    </script>
  </body>
</html>
