<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>1í•™ë…„ 2ë°˜ í˜„í™©íŒ</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        @import url("https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable.min.css");
        body { font-family: "Pretendard Variable", sans-serif; background-color: #111827; color: white; overflow: hidden; }
        
        /* ëˆˆ ë‚´ë¦¬ëŠ” íš¨ê³¼ */
        #snow-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50; }
        
        /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ */
        ::-webkit-scrollbar { display: none; }
        
        /* ì¹ íŒ ëª¨ë“œ ê·¸ë¦¬ë“œ */
        .board-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 12px; padding: 20px; height: 100vh; align-content: center; }
        
        /* ì¹´ë“œ ë””ìì¸ */
        .seat-card {
            background: #1f2937; border: 1px solid #374151; border-radius: 12px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            height: 140px; transition: all 0.3s ease; position: relative;
        }
        .seat-card.empty { opacity: 0.5; }
        
        /* ìƒíƒœë³„ ìƒ‰ìƒ */
        .status-room { border-color: #374151; }
        .status-etc { border-color: #fbbf24; background: rgba(251, 191, 36, 0.1); }
        .status-away { border-color: #ef4444; background: rgba(239, 68, 68, 0.1); }
        
        /* ëª¨ë°”ì¼ ë²„íŠ¼ */
        .mobile-btn { padding: 20px; border-radius: 16px; font-weight: bold; font-size: 1.1rem; transition: 0.2s; border: none; }
        .mobile-btn:active { transform: scale(0.95); }
    </style>
</head>
<body>
    <div id="app">
        <canvas id="snow-canvas"></canvas>

        <div v-if="isBoardMode" class="board-container">
            <div class="fixed top-0 left-0 w-full p-4 text-center z-10 bg-gray-900/80 backdrop-blur">
                <h1 class="text-3xl font-bold text-gray-100">1í•™ë…„ 2ë°˜ í•™ìŠµ ì¥ì†Œ í˜„í™©</h1>
                <div class="flex justify-center gap-6 mt-2 text-lg">
                    <span class="text-gray-400">ì´ì›: {{ totalStudents }}ëª…</span>
                    <span class="text-blue-400">í˜„ì›: {{ presentCount }}ëª…</span>
                    <span class="text-red-400">ì´ë™: {{ awayCount }}ëª…</span>
                </div>
            </div>

            <div class="board-grid">
                <div v-for="n in 32" :key="n" v-show="n !== 31" class="seat-card" :class="getSeatClass(n)">
                    <div class="absolute top-2 left-3 text-sm text-gray-500 font-mono">{{ n }}</div>
                    
                    <div class="text-2xl font-bold mb-1">{{ getStudentName(n) || '-' }}</div>
                    
                    <div v-if="getStudentStatus(n) !== 'êµì‹¤'" class="px-3 py-1 rounded-full text-sm font-bold animate-pulse" 
                         :class="getStatusColor(n)">
                        {{ getStudentStatus(n) }}
                    </div>
                    <div v-else class="text-sm text-gray-600">êµì‹¤</div>
                </div>
            </div>
        </div>

        <div v-else class="flex flex-col items-center justify-center min-h-screen p-6 relative z-10">
            
            <div v-if="!user" class="w-full max-w-md text-center">
                <h1 class="text-4xl font-bold mb-2">ë””ë¯¸ê³  ì¸ì›ì ê²€</h1>
                <p class="text-gray-400 mb-10">1í•™ë…„ 2ë°˜ ì „ìš©</p>
                
                <button @click="googleLogin" class="w-full bg-white text-gray-900 font-bold py-4 px-6 rounded-xl flex items-center justify-center gap-3 hover:bg-gray-100 transition">
                    <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-6 h-6">
                    ë””ë¯¸ê³  ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
                </button>
                <p class="text-sm text-gray-600 mt-4">* @dimigo.hs.kr ê³„ì •ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
            </div>

            <div v-else class="w-full max-w-md">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-2xl font-bold">{{ myName }}</h2>
                        <p class="text-blue-400 font-mono">{{ mySeatNo }}ë²ˆ</p>
                    </div>
                    <button @click="logout" class="text-sm text-gray-500 underline">ë¡œê·¸ì•„ì›ƒ</button>
                </div>

                <div class="bg-gray-800 p-6 rounded-2xl text-center mb-6 border border-gray-700">
                    <p class="text-gray-400 text-sm mb-2">í˜„ì¬ ìƒíƒœ</p>
                    <p class="text-3xl font-bold text-white">{{ myStatus || 'êµì‹¤' }}</p>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <button @click="updateStatus('êµì‹¤')" class="mobile-btn bg-gray-700 text-white hover:bg-gray-600">
                        ğŸ« êµì‹¤ ë³µê·€
                    </button>
                    <button @click="updateStatus('í™”ì¥ì‹¤')" class="mobile-btn bg-blue-900/50 text-blue-200 border border-blue-800 hover:bg-blue-900">
                        ğŸš½ í™”ì¥ì‹¤
                    </button>
                    <button @click="updateStatus('ì‹ìˆ˜')" class="mobile-btn bg-blue-900/50 text-blue-200 border border-blue-800 hover:bg-blue-900">
                        ğŸ’§ ì‹ìˆ˜
                    </button>
                    <button @click="updateStatus('ë³´ê±´ì‹¤')" class="mobile-btn bg-red-900/50 text-red-200 border border-red-800 hover:bg-red-900">
                        ğŸ’Š ë³´ê±´ì‹¤
                    </button>
                    <button @click="updateStatus('ë™ì•„ë¦¬')" class="mobile-btn bg-purple-900/50 text-purple-200 border border-purple-800 hover:bg-purple-900">
                        âš½ ë™ì•„ë¦¬
                    </button>
                    <button @click="updateStatus('ë°©ê³¼í›„')" class="mobile-btn bg-purple-900/50 text-purple-200 border border-purple-800 hover:bg-purple-900">
                        ğŸ“š ë°©ê³¼í›„
                    </button>
                    <button @click="askEtc" class="mobile-btn col-span-2 bg-yellow-900/50 text-yellow-200 border border-yellow-800 hover:bg-yellow-900">
                        ğŸ¸ ê¸°íƒ€ ì‚¬ìœ  ì…ë ¥
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { createApp, ref, computed, onMounted } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getDatabase, ref as dbRef, onValue, set } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        // ============================================================
        // [ì„¤ì •] Firebase í‚¤ (ë³¸ì¸ í‚¤ë¡œ êµì²´ í•„ìˆ˜!)
        // ============================================================
        const firebaseConfig = {
            apiKey: "AIzaSyD...", 
            authDomain: "xxxx.firebaseapp.com",
            databaseURL: "https://xxxx-default-rtdb.firebaseio.com",
            projectId: "xxxx",
            storageBucket: "xxxx.appspot.com",
            messagingSenderId: "123456",
            appId: "1:123456:web:xxxx"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const provider = new GoogleAuthProvider();
        
        // ë””ë¯¸ê³  ê³„ì •ë§Œ í—ˆìš©
        provider.setCustomParameters({ hd: 'dimigo.hs.kr' });

        createApp({
            setup() {
                const isBoardMode = ref(new URLSearchParams(window.location.search).get('mode') === 'board');
                const user = ref(null);
                const students = ref({}); // DB ì „ì²´ ë°ì´í„°
                
                // ë‚´ ì •ë³´
                const myName = ref('');
                const mySeatNo = ref(0);
                
                // ë°ì´í„° ë¡œë“œ
                onMounted(() => {
                    // DB ì‹¤ì‹œê°„ ê°ì§€
                    onValue(dbRef(db, 'students'), (snapshot) => {
                        students.value = snapshot.val() || {};
                    });

                    // ë¡œê·¸ì¸ ìƒíƒœ ê°ì§€
                    onAuthStateChanged(auth, (currentUser) => {
                        if (currentUser) {
                            // ì´ë©”ì¼ ë„ë©”ì¸ ì²´í¬ (ë³´ì•ˆ)
                            if (!currentUser.email.endsWith('@dimigo.hs.kr')) {
                                alert("ë””ë¯¸ê³  ê³„ì •ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                                logout();
                                return;
                            }
                            user.value = currentUser;
                            parseUserInfo(currentUser.displayName);
                        } else {
                            user.value = null;
                        }
                    });

                    // ëˆˆ íš¨ê³¼ ì‹¤í–‰
                    startSnow();
                });

                // ì‚¬ìš©ì ì •ë³´ íŒŒì‹± (ì˜ˆ: "1224 ì¡°ìœ¨í¬" -> 24ë²ˆ, ì¡°ìœ¨í¬)
                const parseUserInfo = (displayName) => {
                    // êµ¬ê¸€ ì´ë¦„ì—ì„œ ìˆ«ì 4ìë¦¬ ì¶”ì¶œ
                    const match = displayName.match(/(\d{4})\s*(.*)/);
                    if (match) {
                        const studentId = match[1]; // "1224"
                        myName.value = match[2] || displayName; // "ì¡°ìœ¨í¬"
                        
                        // 1224 -> 24 ê³„ì‚°
                        let seat = parseInt(studentId) - 1200;
                        if (seat > 0 && seat <= 32 && seat !== 31) {
                            mySeatNo.value = seat;
                        } else {
                            alert("ìœ íš¨í•˜ì§€ ì•Šì€ í•™ë²ˆì…ë‹ˆë‹¤. (1201~1232)");
                            logout();
                        }
                    } else {
                        // í•™ë²ˆ íŒŒì‹± ì‹¤íŒ¨ ì‹œ ìˆ˜ë™ ì…ë ¥ (ê°„ë‹¨íˆ ì²˜ë¦¬)
                        const inputId = prompt("í•™ë²ˆ 4ìë¦¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” (ì˜ˆ: 1224)");
                        if(inputId) parseUserInfo(inputId + " " + displayName);
                    }
                };

                // ë¡œê·¸ì¸
                const googleLogin = () => {
                    signInWithPopup(auth, provider).catch((error) => alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + error.message));
                };

                // ë¡œê·¸ì•„ì›ƒ
                const logout = () => {
                    signOut(auth);
                    user.value = null;
                };

                // ìƒíƒœ ì—…ë°ì´íŠ¸ (DB ì „ì†¡)
                const updateStatus = (status) => {
                    if (!mySeatNo.value) return;
                    set(dbRef(db, 'students/' + mySeatNo.value), {
                        name: myName.value,
                        status: status,
                        timestamp: Date.now()
                    });
                };

                // ê¸°íƒ€ ì‚¬ìœ  ì…ë ¥
                const askEtc = () => {
                    const reason = prompt("ê¸°íƒ€ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
                    if (reason) updateStatus(`ê¸°íƒ€(${reason})`);
                };

                // [PC] ì¢Œì„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const getStudentName = (n) => students.value[n]?.name || '';
                const getStudentStatus = (n) => students.value[n]?.status || 'êµì‹¤';
                
                // [PC] ì¢Œì„ ìŠ¤íƒ€ì¼
                const getSeatClass = (n) => {
                    const status = getStudentStatus(n);
                    return status === 'êµì‹¤' ? 'status-room' : 'status-away';
                };
                const getStatusColor = (n) => {
                    const status = getStudentStatus(n);
                    if (status === 'êµì‹¤') return '';
                    if (status.includes('ê¸°íƒ€')) return 'text-yellow-400 bg-yellow-900/30';
                    return 'text-red-400 bg-red-900/30';
                };

                // [PC] í†µê³„
                const totalStudents = 31; // 31ë²ˆ ì œì™¸ ì´ 31ëª…
                const presentCount = computed(() => {
                    let count = 0;
                    for (let i = 1; i <= 32; i++) {
                        if (i === 31) continue;
                        const s = students.value[i]?.status || 'êµì‹¤';
                        if (s === 'êµì‹¤') count++;
                    }
                    return count;
                });
                const awayCount = computed(() => totalStudents - presentCount.value);

                return {
                    isBoardMode, user, myName, mySeatNo, myStatus: computed(() => students.value[mySeatNo.value]?.status),
                    googleLogin, logout, updateStatus, askEtc,
                    getStudentName, getStudentStatus, getSeatClass, getStatusColor,
                    totalStudents, presentCount, awayCount
                };
            }
        }).mount('#app');

        // ëˆˆ ë‚´ë¦¬ëŠ” íš¨ê³¼ (ë°”ë‹ë¼ JS)
        function startSnow() {
            const canvas = document.getElementById('snow-canvas');
            const ctx = canvas.getContext('2d');
            let width = window.innerWidth;
            let height = window.innerHeight;
            canvas.width = width; canvas.height = height;
            const flakes = [];
            for(let i=0; i<100; i++) flakes.push({x: Math.random()*width, y: Math.random()*-height, r: Math.random()*2+1, s: Math.random()*1+0.5});
            function draw() {
                ctx.clearRect(0,0,width,height);
                ctx.fillStyle = 'rgba(255,255,255,0.6)';
                ctx.beginPath();
                flakes.forEach(f => {
                    ctx.moveTo(f.x, f.y); ctx.arc(f.x, f.y, f.r, 0, Math.PI*2);
                    f.y += f.s;
                    if(f.y > height) { f.y = -5; f.x = Math.random() * width; }
                });
                ctx.fill(); requestAnimationFrame(draw);
            }
            window.addEventListener('resize', () => { width=window.innerWidth; height=window.innerHeight; canvas.width=width; canvas.height=height; });
            draw();
        }
    </script>
</body>
</html>
