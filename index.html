<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>í•™ìŠµ ì¥ì†Œ í˜„í™©íŒ</title>
    
    <link rel="stylesheet" crossorigin href="./index-D-SKl4xE.css">
    <script type="module" crossorigin src="./script.js"></script>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <style>
      /* [1] ê³µí†µ ë° PC í™”ë©´ ìŠ¤íƒ€ì¼ */
      #snow-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; pointer-events: none; }
      .form, .notice, .aside-announcement, ul.notice-ul:not(#my-custom-list) { display: none !important; }

      /* PC ì™¼ìª½ í•˜ë‹¨ ì—°ê²° ì½”ë“œ í‘œì‹œ */
      #connection-display {
          position: fixed; bottom: 20px; left: 20px; 
          background: rgba(0,0,0,0.8); color: white; padding: 15px 20px; 
          border-radius: 12px; z-index: 10000; border: 1px solid #333;
          box-shadow: 0 4px 15px rgba(0,0,0,0.5); font-family: monospace;
      }
      #connection-display h3 { margin: 0 0 5px 0; font-size: 0.9rem; color: #aaa; }
      #room-id-text { font-size: 1.8rem; font-weight: bold; color: #5ac4ff; letter-spacing: 2px; }
      #pc-status-msg { font-size: 0.8rem; color: #00ff88; margin-top: 5px; }

      /* [2] ëª¨ë°”ì¼ ë¦¬ëª¨ì»¨ ì „ìš© ìŠ¤íƒ€ì¼ */
      body.mobile-mode { background: #f0f2f5; color: #333; font-family: -apple-system, sans-serif; height: 100vh; overflow: hidden; margin: 0; }
      body.mobile-mode #app, body.mobile-mode #snow-canvas, body.mobile-mode #connection-display { display: none !important; }

      .mobile-container { max-width: 450px; margin: 0 auto; height: 100%; padding: 20px; display: flex; flex-direction: column; justify-content: center; box-sizing: border-box; }
      .hidden { display: none !important; }
      .fade-in { animation: fadeIn 0.5s ease; }

      /* ì¹´ë“œ ë° ì…ë ¥ì°½ */
      .m-card { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 16px; width: 100%; box-sizing: border-box; }
      .m-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 20px; color: #111; text-align: center; }
      .m-input { width: 100%; padding: 14px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; font-size: 1.1rem; box-sizing: border-box; text-align: center; }
      .m-btn { width: 100%; padding: 15px; background: #000; color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; transition: 0.2s; }
      .m-btn:active { transform: scale(0.98); }

      /* ìƒíƒœ í‘œì‹œ ë° ë²„íŠ¼ ê·¸ë¦¬ë“œ */
      .status-box { text-align: center; padding: 15px; background: #eef2ff; border-radius: 8px; margin-bottom: 20px; border: 1px solid #c7d2fe; }
      .status-text { font-size: 1.2rem; font-weight: 700; color: #3730a3; }
      
      .loc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
      .loc-btn { 
          padding: 20px 10px; border: 1px solid #e2e8f0; background: white; 
          border-radius: 12px; font-weight: 600; cursor: pointer; color: #333;
          font-size: 1rem; display: flex; flex-direction: column; align-items: center; gap: 5px;
          box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      }
      .loc-btn:active { background: #f1f5f9; transform: scale(0.98); }
      .loc-btn.active { background: #333; color: white; border-color: #333; }

      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
  </head>
  <body>
    <canvas id="snow-canvas"></canvas>
    
    <div id="app"></div>

    <div id="connection-display" style="display: none;">
        <h3>ğŸ”— ë¦¬ëª¨ì»¨ ì ‘ì† ì½”ë“œ</h3>
        <div id="room-id-text">...</div>
        <div id="pc-status-msg">ëŒ€ê¸° ì¤‘...</div>
    </div>

    <div id="screen-connect" class="mobile-container hidden">
        <div class="m-card fade-in">
            <h1 class="m-title">ğŸ”— ë¦¬ëª¨ì»¨ ì—°ê²°</h1>
            <input type="number" id="input-room-code" class="m-input" placeholder="PC í™”ë©´ì˜ ì½”ë“œ 4ìë¦¬">
            <button id="btn-connect-pc" class="m-btn">ì—°ê²°í•˜ê¸°</button>
        </div>
    </div>

    <div id="screen-login" class="mobile-container hidden">
        <div class="m-card fade-in">
            <h1 class="m-title">í•™ìƒ ë¡œê·¸ì¸</h1>
            <input type="tel" id="input-student-id" class="m-input" placeholder="í•™ë²ˆ (ì˜ˆ: 1201)" maxlength="4">
            <button id="btn-login" class="m-btn">ì…ì¥í•˜ê¸°</button>
        </div>
    </div>

    <div id="screen-dashboard" class="mobile-container hidden">
        <div class="m-card fade-in">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <span style="font-weight:bold; font-size:1.2rem;" id="user-name-display">ì´ë¦„</span>
                <button id="btn-logout" style="background:none; border:none; color:#666; text-decoration:underline; cursor:pointer;">ë‚˜ê°€ê¸°</button>
            </div>

            <div class="status-box">
                <div style="font-size:0.8rem; color:#666; margin-bottom:5px;">í˜„ì¬ ìƒíƒœ</div>
                <span id="current-status-text" class="status-text">êµì‹¤</span>
            </div>

            <div class="loc-grid">
                <button class="loc-btn" onclick="sendMove('room')">ğŸ« êµì‹¤</button>
                <button class="loc-btn" onclick="sendMove('afterschool')">ğŸ“š ë°©ê³¼í›„</button>
                <button class="loc-btn" onclick="sendMove('club')">âš½ ë™ì•„ë¦¬</button>
                <button class="loc-btn" onclick="sendMove('early')">ğŸƒ ì¡°ê¸°ì…ì‹¤/ê²°ì„</button>
                <button class="loc-btn" onclick="sendMove('restroom')">ğŸš½ í™”ì¥ì‹¤/ì •ìˆ˜ê¸°</button>
                <button class="loc-btn" onclick="sendMove('etc')">ğŸ¸ ê¸°íƒ€</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // [1] í•™ìƒ ëª…ë‹¨ (1201 ~ 1232)
        // ==========================================
        const STUDENT_DATA = [
            { id: '1201', name: 'êµ¬ë¯¼ì°¬' }, { id: '1202', name: 'ê¶Œì¬í˜„' }, { id: '1203', name: 'ê¹€ë¯¼ì±„' },
            { id: '1204', name: 'ê¹€ë³´ê²½' }, { id: '1205', name: 'ê¹€ì±„ê²½' }, { id: '1206', name: 'ë‚˜ê¸°ì°¬' },
            { id: '1207', name: 'ë°•ê·¼ìš°' }, { id: '1208', name: 'ë°•ì„œìœ¤' }, { id: '1209', name: 'ë°•ì„œí˜„' },
            { id: '1210', name: 'ë°•ì†Œìœ¨' }, { id: '1211', name: 'ë°•ì‹œí•˜' }, { id: '1212', name: 'ë°•ì¬ìœ¤' },
            { id: '1213', name: 'ë°•ì´ˆì—°' }, { id: '1214', name: 'ì–‘ì„¸ë¦°' }, { id: '1215', name: 'ì—„ë¡œì´' },
            { id: '1216', name: 'ìœ ìŠ¹í›„' }, { id: '1217', name: 'ì´ê·œì›' }, { id: '1218', name: 'ì´ë‚˜ê²½' },
            { id: '1219', name: 'ì´ì˜ˆì¤€' }, { id: '1220', name: 'ì´ì§€ì›' }, { id: '1221', name: 'ì •ì´í˜„' },
            { id: '1222', name: 'ì •íƒœê²¸' }, { id: '1223', name: 'ì¡°ë¯¼ì„œ' }, { id: '1224', name: 'ì¡°ìœ¨í¬' },
            { id: '1225', name: 'ì§€ì•„ë¦¼' }, { id: '1226', name: 'ìµœì˜ˆì§„' }, { id: '1227', name: 'ìµœìœ í˜' },
            { id: '1228', name: 'í•˜ì‹œì€' }, { id: '1229', name: 'í•œì§„í™˜' }, { id: '1230', name: 'í—ˆìœ ì •' },
            { id: '1232', name: 'ê¹€ë²”ì¤€' }
        ];

        // ==========================================
        // [2] í†µì‹  ì„¤ì • (PeerJS + STUN Server)
        // ==========================================
        const peerConfig = {
            debug: 2,
            config: {
                'iceServers': [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:global.stun.twilio.com:3478' }
                ]
            }
        };

        const urlParams = new URLSearchParams(window.location.search);
        const isMobile = urlParams.get('mode') === 'mobile';
        let peer = null;
        let conn = null;
        let myName = "";

        // ----------------------------------------------------------------
        // [A] ëª¨ë°”ì¼ ë¦¬ëª¨ì»¨ ë¡œì§
        // ----------------------------------------------------------------
        if (isMobile) {
            document.body.classList.add('mobile-mode');
            showScreen('screen-connect');

            // ì—°ê²° ë²„íŠ¼ í´ë¦­
            document.getElementById('btn-connect-pc').onclick = () => {
                const code = document.getElementById('input-room-code').value.trim();
                if (code.length < 3) return alert("ì½”ë“œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");

                // PeerJS ì´ˆê¸°í™”
                peer = new Peer(peerConfig);
                
                peer.on('open', () => {
                    document.getElementById('btn-connect-pc').innerText = "ì—°ê²° ì¤‘...";
                    conn = peer.connect(`dimiboard-${code}`);

                    conn.on('open', () => {
                        showScreen('screen-login'); // ì„±ê³µ ì‹œ ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ
                    });

                    conn.on('error', (err) => {
                        alert("ì—°ê²° ì‹¤íŒ¨! ì½”ë“œë¥¼ ë‹¤ì‹œ í™•ì¸í•˜ê±°ë‚˜ PCë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.");
                        document.getElementById('btn-connect-pc').innerText = "ì—°ê²°í•˜ê¸°";
                    });
                    
                    conn.on('close', () => {
                        alert("ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.");
                        location.reload();
                    });
                });
                
                peer.on('error', (err) => {
                    alert("í†µì‹  ì˜¤ë¥˜: " + err.type);
                    document.getElementById('btn-connect-pc').innerText = "ì—°ê²°í•˜ê¸°";
                });
            };

            // ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­
            document.getElementById('btn-login').onclick = () => {
                const inputId = document.getElementById('input-student-id').value.trim();
                const student = STUDENT_DATA.find(s => s.id === inputId);

                if (student) {
                    myName = student.name;
                    document.getElementById('user-name-display').innerText = `${student.name} (${student.id})`;
                    showScreen('screen-dashboard');
                } else {
                    alert("ëª…ë‹¨ì— ì—†ëŠ” í•™ë²ˆì…ë‹ˆë‹¤.");
                }
            };

            // ì´ë™ ëª…ë ¹ ì „ì†¡
            window.sendMove = function(locationType) {
                if (!conn || !conn.open) return alert("PCì™€ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.");
                
                let reason = "";
                let displayLoc = "";

                // ë²„íŠ¼ë³„ í…ìŠ¤íŠ¸ ë§¤í•‘
                if(locationType === 'room') displayLoc = "êµì‹¤";
                else if(locationType === 'afterschool') displayLoc = "ë°©ê³¼í›„";
                else if(locationType === 'club') displayLoc = "ë™ì•„ë¦¬";
                else if(locationType === 'early') displayLoc = "ì¡°ê¸°ì…ì‹¤/ê²°ì„";
                else if(locationType === 'restroom') displayLoc = "í™”ì¥ì‹¤/ì •ìˆ˜ê¸°";
                else if(locationType === 'etc') {
                    reason = prompt("ê¸°íƒ€ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ìƒë‹´)");
                    if (!reason) return; // ì·¨ì†Œ
                    displayLoc = `ê¸°íƒ€ (${reason})`;
                }

                document.getElementById('current-status-text').innerText = displayLoc;

                // PCë¡œ ë°ì´í„° ì „ì†¡
                conn.send({
                    type: 'move',
                    name: myName,
                    target: locationType,
                    reason: reason
                });
            };

            document.getElementById('btn-logout').onclick = () => {
                showScreen('screen-login');
                document.getElementById('input-student-id').value = '';
            };

            function showScreen(id) {
                document.querySelectorAll('.mobile-container').forEach(el => el.classList.add('hidden'));
                document.getElementById(id).classList.remove('hidden');
            }
        } 
        
        // ----------------------------------------------------------------
        // [B] PC í˜„í™©íŒ ë¡œì§
        // ----------------------------------------------------------------
        else {
            // ëœë¤ ì½”ë“œ ìƒì„±
            const roomCode = Math.floor(1000 + Math.random() * 9000);
            
            // PeerJS ì´ˆê¸°í™” (ê³ ì • ID ì‚¬ìš©)
            peer = new Peer(`dimiboard-${roomCode}`, peerConfig);

            peer.on('open', (id) => {
                document.getElementById('connection-display').style.display = 'block';
                document.getElementById('room-id-text').innerText = roomCode;
            });

            peer.on('connection', (connection) => {
                document.getElementById('pc-status-msg').innerText = "ğŸŸ¢ í°ê³¼ ì—°ê²°ë¨!";
                
                connection.on('data', (data) => {
                    if (data.type === 'move') {
                        // â˜… ì—¬ê¸°ì„œ ìì„ì„ ì´ë™ì‹œí‚µë‹ˆë‹¤ â˜…
                        // ìš”ì²­í•˜ì‹  ëª©ë¡: ['room', 'afterschool', 'club', 'early', 'restroom', 'etc']
                        // PCì˜ ê¸°ì¡´ script.jsê°€ ì´ ë ˆì¸ë“¤ì„ ì§€ì›í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ
                        // ê¸°ì¡´ì— ì¡´ì¬í•˜ëŠ” ë ˆì¸ìœ¼ë¡œ ë§¤í•‘í•˜ê±°ë‚˜, 'etc'ë¡œ ë³´ë‚´ë˜ ì‚¬ìœ ì— í‘œì‹œí•©ë‹ˆë‹¤.
                        
                        let targetLane = data.target;
                        let reasonText = data.reason;

                        // [ë§¤í•‘ ë¡œì§] PCì— í•´ë‹¹ ë ˆì¸ì´ ì—†ìœ¼ë©´ 'etc'ë‚˜ 'toilet' ë“±ìœ¼ë¡œ ìš°íšŒ
                        // 1. ë°©ê³¼í›„/ë™ì•„ë¦¬/ì¡°ê¸°ì…ì‹¤ -> script.jsì— ë ˆì¸ì´ ì—†ìœ¼ë©´ 'etc'ë¡œ ë³´ë‚´ê³  ì‚¬ìœ ì— ì ìŒ
                        if (['afterschool', 'club', 'early'].includes(targetLane)) {
                            // ë§Œì•½ 'afterschool' ë ˆì¸ì´ PCì— ì—†ë‹¤ë©´:
                            if (!document.querySelector(`div[data-lane="${targetLane}"]`)) {
                                targetLane = 'etc'; 
                                let label = (data.target === 'afterschool') ? 'ë°©ê³¼í›„' : 
                                            (data.target === 'club') ? 'ë™ì•„ë¦¬' : 'ì¡°ê¸°ì…ì‹¤/ê²°ì„';
                                reasonText = label; 
                            }
                        }
                        // 2. í™”ì¥ì‹¤/ì •ìˆ˜ê¸° -> 'toilet' ë˜ëŠ” 'water' (ë³´í†µ toilet ì‚¬ìš©)
                        if (targetLane === 'restroom') targetLane = 'toilet';

                        moveMagnetByName(data.name, targetLane, reasonText);
                    }
                });
                
                connection.on('close', () => {
                    document.getElementById('pc-status-msg').innerText = "ğŸ”´ ì—°ê²° ëŠê¹€";
                });
            });

            // ìì„ ì´ë™ í•¨ìˆ˜
            function moveMagnetByName(studentName, targetLane, reason) {
                const chips = document.querySelectorAll('.chip');
                let targetChip = null;

                chips.forEach(chip => {
                    if (chip.innerText.includes(studentName)) targetChip = chip;
                });

                if (targetChip) {
                    // ëª©ì ì§€ ì°¾ê¸°
                    const targetContainer = document.querySelector(`div[data-lane="${targetLane}"]`);
                    // .lane ë‚´ë¶€ì˜ ì»¨í…Œì´ë„ˆ(ë³´í†µ ë‘ë²ˆì§¸ div) ì°¾ê¸°
                    const dest = targetContainer ? (targetContainer.querySelector('div:last-child') || targetContainer) : null;

                    if (dest) {
                        dest.appendChild(targetChip);
                        
                        // ì‚¬ìœ  íƒœê·¸ í‘œì‹œ/ì œê±°
                        let reasonTag = targetChip.querySelector('.reason-badge');
                        if (reason) {
                            if (!reasonTag) {
                                reasonTag = document.createElement('div');
                                reasonTag.className = 'reason-badge';
                                reasonTag.style.cssText = "font-size:0.7rem; color:#ff6b6b; margin-top:2px;";
                                targetChip.appendChild(reasonTag);
                            }
                            reasonTag.innerText = reason;
                        } else {
                            if (reasonTag) reasonTag.remove();
                        }
                    }
                }
            }

            // [ê¸°íƒ€] ëˆˆ ë‚´ë¦¬ëŠ” íš¨ê³¼ ë“± ê¸°ì¡´ ë¡œì§
            (function() {
                const canvas = document.getElementById('snow-canvas');
                const ctx = canvas.getContext('2d');
                let width = window.innerWidth, height = window.innerHeight;
                canvas.width = width; canvas.height = height;
                const flakes = [];
                for(let i=0; i<100; i++) flakes.push({x:Math.random()*width,y:Math.random()*-height,r:Math.random()*2+1,s:Math.random()+0.5,o:Math.random()*0.5+0.3});
                function draw() {
                    ctx.clearRect(0,0,width,height);
                    ctx.fillStyle='rgba(255,255,255,0.8)'; ctx.beginPath();
                    flakes.forEach(f=>{
                        ctx.globalAlpha=f.o; ctx.moveTo(f.x,f.y); ctx.arc(f.x,f.y,f.r,0,Math.PI*2);
                        f.y+=f.s; if(f.y>height){f.y=-5;f.x=Math.random()*width;}
                    }); ctx.fill(); requestAnimationFrame(draw);
                }
                window.addEventListener('resize',()=>{width=window.innerWidth;height=window.innerHeight;canvas.width=width;canvas.height=height;}); draw();
            })();

            // ì¼ì •í‘œ ë Œë”ë§
            const MY_TITLE="1ì°¨ ì§€í•„í‰ê°€"; const D_DAY_DATE="2024-12-16"; 
            const MY_SCHEDULES=[{subject:'ìˆ˜í•™',content:'ì‚¼ê°í•¨ìˆ˜ ~ ìˆ˜ì—´',color:'c-red'},{subject:'ì˜ì–´',content:'ìˆ˜ëŠ¥íŠ¹ê°• 3ê°•, 4ê°•',color:'c-blue'},{subject:'êµ­ì–´',content:'ë¬¸í•™ ì‘í’ˆ ë¶„ì„',color:'c-green'},{subject:'ì •ë³´',content:'íŒŒì´ì¬ ìˆ˜í–‰í‰ê°€',color:'c-yellow'}];
            function calculateDDay(t){const d=new Date(t);const n=new Date();d.setHours(0,0,0,0);n.setHours(0,0,0,0);const x=Math.ceil((d-n)/864e5);return x===0?"D-Day":x>0?"D-"+x:"D+"+Math.abs(x);}
            function renderMyBoard(){
                const aside=document.querySelector('aside'); if(!aside)return;
                const ori=aside.querySelector('.notice'); if(ori)ori.style.display='none';
                if(!document.getElementById('my-dashboard-container')){
                    const c=document.createElement('div'); c.id='my-dashboard-container';
                    const u=document.createElement('ul'); u.id='my-custom-list'; u.className='notice-ul';
                    const s=aside.querySelector('div'); if(s){aside.appendChild(c);aside.appendChild(u);}
                }
                const c=document.getElementById('my-dashboard-container');
                const h=`<span class="my-title">${MY_TITLE}</span><span class="my-dday-badge">${calculateDDay(D_DAY_DATE)}</span>`;
                if(c.innerHTML!==h)c.innerHTML=h;
                const u=document.getElementById('my-custom-list');
                const l=MY_SCHEDULES.map(i=>`<li class="${i.color}"><span class="type-tag">${i.subject}</span><span>${i.content}</span></li>`).join('');
                if(u.innerHTML!==l)u.innerHTML=l;
            }
            setInterval(renderMyBoard,100);
        }
    </script>
  </body>
</html>
