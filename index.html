<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>í•™ìŠµ ì¥ì†Œ í˜„í™©íŒ</title>
    
    <link rel="stylesheet" crossorigin href="./style.css">
    <script type="module" crossorigin src="./script.js"></script>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <style>
      /* [1] ê³µí†µ ë° PC í™”ë©´ ìŠ¤íƒ€ì¼ */
      #snow-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; pointer-events: none; }
      
      /* ë¶ˆí•„ìš”í•œ ìš”ì†Œ ìˆ¨ê¹€ */
      .form, .notice, .aside-announcement, ul.notice-ul:not(#my-custom-list) { display: none !important; }

      /* PC ì™¼ìª½ í•˜ë‹¨ ì—°ê²° ì½”ë“œ í‘œì‹œ */
      #connection-display {
          position: fixed; bottom: 20px; left: 20px; 
          background: rgba(0,0,0,0.8); color: white; padding: 15px 20px; 
          border-radius: 12px; z-index: 10000; border: 1px solid #333;
          box-shadow: 0 4px 15px rgba(0,0,0,0.5); font-family: monospace;
      }
      #connection-display h3 { margin: 0 0 5px 0; font-size: 0.9rem; color: #aaa; }
      #room-id-text { font-size: 1.8rem; font-weight: bold; color: #5ac4ff; letter-spacing: 2px; }

      /* [2] ëª¨ë°”ì¼ ë¦¬ëª¨ì»¨ ì „ìš© ìŠ¤íƒ€ì¼ (React ë””ìì¸ ì¬í˜„) */
      body.mobile-mode { background: #f0f2f5; color: #333; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; height: 100vh; overflow: hidden; margin: 0; }
      body.mobile-mode #app, body.mobile-mode #snow-canvas, body.mobile-mode #connection-display { display: none !important; }

      .mobile-container { max-width: 450px; margin: 0 auto; height: 100%; padding: 20px; display: flex; flex-direction: column; justify-content: center; box-sizing: border-box; }
      
      /* ì¹´ë“œ ë””ìì¸ */
      .m-card { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 16px; width: 100%; box-sizing: border-box; }
      .m-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 8px; color: #111; }
      .m-desc { color: #666; font-size: 0.9rem; margin-bottom: 20px; }
      
      /* ì…ë ¥ì°½ */
      .m-label { display: block; font-size: 0.9rem; font-weight: 500; margin-bottom: 6px; color: #333; }
      .m-input { width: 100%; padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 6px; margin-bottom: 16px; font-size: 1rem; box-sizing: border-box; }
      .m-input:focus { outline: none; border-color: #000; ring: 2px solid #ddd; }

      /* ë²„íŠ¼ */
      .m-btn { width: 100%; padding: 12px; background: #000; color: white; border: none; border-radius: 6px; font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: 0.2s; }
      .m-btn:disabled { background: #ccc; cursor: not-allowed; }
      .m-btn:active { transform: scale(0.98); }
      .m-btn.outline { background: white; border: 1px solid #e2e8f0; color: #0f172a; margin-top: 8px; }

      /* ìƒíƒœ í‘œì‹œ */
      .status-box { text-align: center; padding: 15px; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 20px; background: #f8fafc; }
      .status-text { font-size: 1.1rem; font-weight: 600; color: #0f172a; }
      
      /* ë²„íŠ¼ ê·¸ë¦¬ë“œ */
      .loc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
      .loc-btn { padding: 16px; border: 1px solid #e2e8f0; background: white; border-radius: 8px; font-weight: 500; cursor: pointer; transition: 0.2s; color: #333; }
      .loc-btn.active { background: #000; color: white; border-color: #000; }
      
      /* í™”ë©´ ì „í™˜ ì• ë‹ˆë©”ì´ì…˜ */
      .hidden { display: none !important; }
      .fade-in { animation: fadeIn 0.5s ease; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
  </head>
  <body>
    <canvas id="snow-canvas"></canvas>
    
    <div id="app"></div>

    <div id="connection-display" style="display: none;">
        <h3>ğŸ”— ë¦¬ëª¨ì»¨ ì ‘ì† ì½”ë“œ</h3>
        <div id="room-id-text">...</div>
    </div>

    <div id="screen-connect" class="mobile-container hidden">
        <div class="m-card fade-in">
            <h1 class="m-title">ë¦¬ëª¨ì»¨ ì—°ê²°</h1>
            <p class="m-desc">PC í™”ë©´ ì¢Œì¸¡ í•˜ë‹¨ì˜ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
            
            <label class="m-label">ì ‘ì† ì½”ë“œ (4ìë¦¬)</label>
            <input type="number" id="input-room-code" class="m-input" placeholder="ì˜ˆ: 1234">
            
            <button id="btn-connect-pc" class="m-btn">ì—°ê²°í•˜ê¸°</button>
        </div>
    </div>

    <div id="screen-login" class="mobile-container hidden">
        <div class="m-card fade-in">
            <h1 class="m-title">ë¡œê·¸ì¸</h1>
            <p class="m-desc">ë³¸ì¸ì˜ í•™ë²ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
            
            <label class="m-label">í•™ë²ˆ</label>
            <input type="text" id="input-student-id" class="m-input" placeholder="ì˜ˆ: 1201">
            
            <button id="btn-login" class="m-btn">ë¡œê·¸ì¸</button>
        </div>
        <p style="text-align:center; color:#999; font-size:0.8rem;">made by ì¡°ìœ¨í¬/ì œë¯¸ë‚˜ì´</p>
    </div>

    <div id="screen-dashboard" class="mobile-container hidden">
        <div class="m-card fade-in" style="margin-bottom: 10px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <div>
                    <h2 class="m-title" style="font-size:1.2rem; margin:0;" id="user-name-display">í™ê¸¸ë™</h2>
                    <span style="font-size:0.85rem; color:#666;" id="user-id-display">1234</span>
                </div>
                <button id="btn-logout" style="background:none; border:none; color:#666; font-size:0.85rem; cursor:pointer; text-decoration:underline;">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>

        <div class="m-card fade-in">
            <h3 class="m-label" style="font-size:1rem;">í˜„ì¬ ìƒíƒœ</h3>
            <div class="status-box">
                <span id="current-status-text" class="status-text">êµì‹¤</span>
            </div>

            <h3 class="m-label" style="font-size:1rem;">ìœ„ì¹˜ ì´ë™</h3>
            <div class="loc-grid">
                <button class="loc-btn" onclick="sendMove('room')">ğŸ« êµì‹¤</button>
                <button class="loc-btn" onclick="sendMove('toilet')">ğŸš½ í™”ì¥ì‹¤</button>
                <button class="loc-btn" onclick="sendMove('water')">ğŸ’§ ì‹ìˆ˜</button>
                <button class="loc-btn" onclick="sendMove('health')">ğŸ’Š ë³´ê±´ì‹¤</button>
                <button class="loc-btn" onclick="sendMove('mood')">âœ¨ ê¸°ë¶„ì „í™˜</button>
                <button class="loc-btn" onclick="sendMove('etc')">ğŸ¸ ê¸°íƒ€</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // [ì„¤ì •] í•™ìƒ ëª…ë‹¨ ë°ì´í„° (1201 ~ 1232)
        // ==========================================
        const STUDENT_DATA = [
            { id: '1201', name: 'êµ¬ë¯¼ì°¬' }, { id: '1202', name: 'ê¶Œì¬í˜„' }, { id: '1203', name: 'ê¹€ë¯¼ì±„' },
            { id: '1204', name: 'ê¹€ë³´ê²½' }, { id: '1205', name: 'ê¹€ì±„ê²½' }, { id: '1206', name: 'ë‚˜ê¸°ì°¬' },
            { id: '1207', name: 'ë°•ê·¼ìš°' }, { id: '1208', name: 'ë°•ì„œìœ¤' }, { id: '1209', name: 'ë°•ì„œí˜„' },
            { id: '1210', name: 'ë°•ì†Œìœ¨' }, { id: '1211', name: 'ë°•ì‹œí•˜' }, { id: '1212', name: 'ë°•ì¬ìœ¤' },
            { id: '1213', name: 'ë°•ì´ˆì—°' }, { id: '1214', name: 'ì–‘ì„¸ë¦°' }, { id: '1215', name: 'ì—„ë¡œì´' },
            { id: '1216', name: 'ìœ ìŠ¹í›„' }, { id: '1217', name: 'ì´ê·œì›' }, { id: '1218', name: 'ì´ë‚˜ê²½' },
            { id: '1219', name: 'ì´ì˜ˆì¤€' }, { id: '1220', name: 'ì´ì§€ì›' }, { id: '1221', name: 'ì •ì´í˜„' },
            { id: '1222', name: 'ì •íƒœê²¸' }, { id: '1223', name: 'ì¡°ë¯¼ì„œ' }, { id: '1224', name: 'ì¡°ìœ¨í¬' },
            { id: '1225', name: 'ì§€ì•„ë¦¼' }, { id: '1226', name: 'ìµœì˜ˆì§„' }, { id: '1227', name: 'ìµœìœ í˜' },
            { id: '1228', name: 'í•˜ì‹œì€' }, { id: '1229', name: 'í•œì§„í™˜' }, { id: '1230', name: 'í—ˆìœ ì •' },
            { id: '1232', name: 'ê¹€ë²”ì¤€' }
        ];

        // ==========================================
        // [ë¡œì§] PeerJS ë° í™”ë©´ ì œì–´
        // ==========================================
        
        // URL íŒŒë¼ë¯¸í„° í™•ì¸ (?mode=mobile)
        const urlParams = new URLSearchParams(window.location.search);
        const isMobile = urlParams.get('mode') === 'mobile';

        let peer = null;
        let conn = null;
        let myName = "";
        let myId = "";

        // ----------------------------------------------------------------
        // [A] ëª¨ë°”ì¼ ë¦¬ëª¨ì»¨ ë¡œì§
        // ----------------------------------------------------------------
        if (isMobile) {
            document.body.classList.add('mobile-mode');
            showScreen('screen-connect');

            // 1. PC ì—°ê²°í•˜ê¸°
            document.getElementById('btn-connect-pc').onclick = () => {
                const code = document.getElementById('input-room-code').value.trim();
                if (code.length !== 4) return alert("4ìë¦¬ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");

                // PeerJS ì´ˆê¸°í™” (ì„œë²„ ì—†ì´ ì—°ê²°)
                peer = new Peer();
                
                peer.on('open', () => {
                    // PCì—ê²Œ ì—°ê²° ìš”ì²­
                    conn = peer.connect(`dimiboard-${code}`);

                    conn.on('open', () => {
                        // ì—°ê²° ì„±ê³µ
                        showScreen('screen-login');
                    });

                    conn.on('error', () => {
                        alert("ì—°ê²° ì‹¤íŒ¨! ì½”ë“œë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.");
                    });
                    
                    // ì—°ê²° ëŠê¹€ ì²˜ë¦¬
                    conn.on('close', () => {
                        alert("PCì™€ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.");
                        location.reload();
                    });
                });
            };

            // 2. ë¡œê·¸ì¸ ì²˜ë¦¬
            document.getElementById('btn-login').onclick = () => {
                const inputId = document.getElementById('input-student-id').value.trim();
                const student = STUDENT_DATA.find(s => s.id === inputId);

                if (student) {
                    myName = student.name;
                    myId = student.id;
                    
                    // í™”ë©´ ê°±ì‹ 
                    document.getElementById('user-name-display').innerText = myName;
                    document.getElementById('user-id-display').innerText = myId;
                    showScreen('screen-dashboard');
                } else {
                    alert("ëª…ë‹¨ì— ì—†ëŠ” í•™ë²ˆì…ë‹ˆë‹¤.");
                }
            };

            // 3. ì´ë™ ëª…ë ¹ ì „ì†¡
            window.sendMove = function(locationType) {
                if (!conn) return alert("ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.");
                
                let reason = "";
                // ê¸°íƒ€ ì„ íƒ ì‹œ ì‚¬ìœ  ì…ë ¥ (ê°„ë‹¨í•˜ê²Œ prompt ì‚¬ìš©, ì›í•˜ë©´ ëª¨ë‹¬ë¡œ ë³€ê²½ ê°€ëŠ¥)
                if (locationType === 'etc') {
                    reason = prompt("ê¸°íƒ€ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ìƒë‹´, ì‹¬ë¶€ë¦„)");
                    if (!reason) return; // ì·¨ì†Œí•˜ë©´ ì „ì†¡ ì•ˆí•¨
                }

                // UI ì—…ë°ì´íŠ¸
                document.getElementById('current-status-text').innerText = 
                    locationType === 'room' ? 'êµì‹¤' : 
                    locationType === 'etc' ? `ê¸°íƒ€ (${reason})` : locationType;

                // ë²„íŠ¼ ìŠ¤íƒ€ì¼ í™œì„±í™” (ì‹œê°ì  íš¨ê³¼)
                document.querySelectorAll('.loc-btn').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');

                // ë°ì´í„° ì „ì†¡
                conn.send({
                    type: 'move',
                    name: myName,
                    id: myId,
                    target: locationType,
                    reason: reason
                });
            };

            // ë¡œê·¸ì•„ì›ƒ
            document.getElementById('btn-logout').onclick = () => {
                showScreen('screen-login');
                document.getElementById('input-student-id').value = '';
            };

            function showScreen(screenId) {
                document.querySelectorAll('.mobile-container').forEach(el => el.classList.add('hidden'));
                document.getElementById(screenId).classList.remove('hidden');
            }
        } 
        
        // ----------------------------------------------------------------
        // [B] PC í˜„í™©íŒ ë¡œì§
        // ----------------------------------------------------------------
        else {
            // 1. ëœë¤ ë°© ì½”ë“œ ìƒì„± (1000~9999)
            const roomCode = Math.floor(1000 + Math.random() * 9000);
            
            // PeerJS ì´ˆê¸°í™” (ê³ ì • ID ì‚¬ìš©)
            peer = new Peer(`dimiboard-${roomCode}`);

            peer.on('open', (id) => {
                document.getElementById('connection-display').style.display = 'block';
                document.getElementById('room-id-text').innerText = roomCode;
                console.log("My Peer ID is: " + id);
            });

            // í°ì—ì„œ ì—°ê²°ì´ ë“¤ì–´ì˜¤ë©´
            peer.on('connection', (connection) => {
                connection.on('data', (data) => {
                    if (data.type === 'move') {
                        console.log("ì´ë™ ìš”ì²­:", data);
                        // ì‹¤ì œ ìì„ ì´ë™ í•¨ìˆ˜ í˜¸ì¶œ
                        moveMagnetByName(data.name, data.target, data.reason);
                    }
                });
            });

            // [í•µì‹¬] ìì„ ì´ë™ í•¨ìˆ˜
            function moveMagnetByName(studentName, targetLane, reason) {
                const chips = document.querySelectorAll('.chip');
                let targetChip = null;

                // ì´ë¦„ìœ¼ë¡œ ì¹© ì°¾ê¸°
                chips.forEach(chip => {
                    if (chip.innerText.includes(studentName)) {
                        targetChip = chip;
                    }
                });

                if (targetChip) {
                    // ëª©ì ì§€ ì°¾ê¸° (ê¸°ì¡´ script.js êµ¬ì¡° í™œìš©)
                    // data-lane ì†ì„±ì„ ê°€ì§„ div ì°¾ê¸°
                    let targetContainer = document.querySelector(`div[data-lane="${targetLane}"]`);
                    
                    // ë§Œì•½ data-laneì´ ì—†ìœ¼ë©´ í´ë˜ìŠ¤ë¡œ ì°¾ê¸° ì‹œë„ (ì˜ˆ: toilet ë“±)
                    if (!targetContainer) {
                        // script.js ë¡œì§ì— ë§ì¶° ë ˆì¸ ë§¤í•‘ì´ í•„ìš”í•  ìˆ˜ ìˆìŒ.
                        // ì—¬ê¸°ì„œëŠ” data-lane ì†ì„±ì´ ìˆë‹¤ê³  ê°€ì •í•˜ê³  ì§„í–‰.
                        // ë§Œì•½ ì—†ë‹¤ë©´ script.jsì˜ êµ¬ì¡°ë¥¼ í™•ì¸í•´ì•¼ í•¨.
                    }

                    // ë³´í†µ lane ì•ˆì˜ ë‚´ìš©ë¬¼ divê°€ ë”°ë¡œ ìˆìŒ. (ë§ˆì§€ë§‰ ìì‹ ìš”ì†Œ ë“±)
                    const dest = targetContainer ? (targetContainer.querySelector('div:last-child') || targetContainer) : null;

                    if (dest) {
                        dest.appendChild(targetChip);
                        
                        // ì‚¬ìœ (reason) ì²˜ë¦¬
                        let reasonBadge = targetChip.querySelector('.reason-badge');
                        if (targetLane === 'etc' && reason) {
                            if (!reasonBadge) {
                                reasonBadge = document.createElement('div');
                                reasonBadge.className = 'reason-badge';
                                reasonBadge.style.fontSize = '0.6rem';
                                reasonBadge.style.color = '#ff6b6b';
                                reasonBadge.style.marginTop = '2px';
                                targetChip.appendChild(reasonBadge);
                            }
                            reasonBadge.innerText = reason;
                        } else {
                            if (reasonBadge) reasonBadge.remove();
                        }
                    }
                }
            }

            // -----------------------------------------------
            // ëˆˆ ë‚´ë¦¬ëŠ” íš¨ê³¼ (PCë§Œ ì ìš©)
            // -----------------------------------------------
            (function() {
                const canvas = document.getElementById('snow-canvas');
                const ctx = canvas.getContext('2d');
                let width = window.innerWidth;
                let height = window.innerHeight;
                canvas.width = width; canvas.height = height;
                const flakes = [];
                for(let i=0; i<100; i++) flakes.push({x: Math.random()*width, y: Math.random()*-height, r: Math.random()*2+1, s: Math.random()*1+0.5, o: Math.random()*0.5+0.3});
                
                function draw() {
                    ctx.clearRect(0, 0, width, height);
                    ctx.fillStyle = 'rgba(255,255,255,0.8)';
                    ctx.beginPath();
                    flakes.forEach(f => {
                        ctx.globalAlpha = f.o; ctx.moveTo(f.x, f.y); ctx.arc(f.x, f.y, f.r, 0, Math.PI*2);
                        f.y += f.s;
                        if(f.y > height) { f.y = -5; f.x = Math.random() * width; }
                    });
                    ctx.fill();
                    requestAnimationFrame(draw);
                }
                window.addEventListener('resize', () => { width = window.innerWidth; height = window.innerHeight; canvas.width = width; canvas.height = height; });
                draw();
            })();
            
            // ê¸°ì¡´ ì¼ì •í‘œ ë Œë”ë§ (ê·¸ëŒ€ë¡œ ìœ ì§€)
            // ... (ì•„ê¹Œ ë§Œë“  renderMyBoard ë“±ì˜ í•¨ìˆ˜ëŠ” script.jsì— ìˆê±°ë‚˜ ì—¬ê¸°ì— ì¶”ê°€)
            const MY_TITLE = "1ì°¨ ì§€í•„í‰ê°€"; 
            const D_DAY_DATE = "2024-12-16"; 
            const MY_SCHEDULES = [
                { subject: 'ìˆ˜í•™', content: 'ì‚¼ê°í•¨ìˆ˜ ~ ìˆ˜ì—´ (êµê³¼ì„œ p.50~100)', color: 'c-red' },
                { subject: 'ì˜ì–´', content: 'ìˆ˜ëŠ¥íŠ¹ê°• 3ê°•, 4ê°• ì „ì²´', color: 'c-blue' },
                { subject: 'êµ­ì–´', content: 'ë¬¸í•™ ì‘í’ˆ ë¶„ì„ í”„ë¦°íŠ¸ë¬¼', color: 'c-green' },
                { subject: 'ì •ë³´', content: 'íŒŒì´ì¬ ìˆ˜í–‰í‰ê°€ ì œì¶œ ë§ˆê°', color: 'c-yellow' },
            ];

            function calculateDDay(targetDate) {
                const target = new Date(targetDate);
                const today = new Date();
                target.setHours(0,0,0,0); today.setHours(0,0,0,0);
                const diff = target - today;
                const dayDiff = Math.ceil(diff / (1000 * 60 * 60 * 24));
                if (dayDiff === 0) return "D-Day";
                if (dayDiff > 0) return "D-" + dayDiff;
                return "D+" + Math.abs(dayDiff);
            }

            function renderMyBoard() {
                const aside = document.querySelector('aside');
                if (!aside) return; 
                const originalNotice = aside.querySelector('.notice');
                if (originalNotice) originalNotice.style.display = 'none';

                if (!document.getElementById('my-dashboard-container')) {
                    const container = document.createElement('div');
                    container.id = 'my-dashboard-container';
                    const ul = document.createElement('ul');
                    ul.id = 'my-custom-list';
                    ul.className = 'notice-ul';
                    const statsDiv = aside.querySelector('div'); 
                    if (statsDiv) { aside.appendChild(container); aside.appendChild(ul); }
                    else { aside.appendChild(container); aside.appendChild(ul); }
                }

                const container = document.getElementById('my-dashboard-container');
                const newHeaderHTML = `
                    <span class="my-title" style="font-weight:700; font-size:1.8rem; color:#e8ecf3; display:block; margin-bottom:10px;">${MY_TITLE}</span>
                    <span class="my-dday-badge" style="font-size:1.5rem; font-weight:800; color:#ff6b6b; background:rgba(255,107,107,0.15); padding:5px 15px; border-radius:50px;">${calculateDDay(D_DAY_DATE)}</span>
                `;
                if (container.innerHTML !== newHeaderHTML) container.innerHTML = newHeaderHTML;

                const ul = document.getElementById('my-custom-list');
                const newListHTML = MY_SCHEDULES.map(item => `
                    <li class="${item.color}">
                        <span class="type-tag">${item.subject}</span>
                        <span>${item.content}</span>
                    </li>
                `).join('');
                if (ul.innerHTML !== newListHTML) ul.innerHTML = newListHTML;
            }
            setInterval(renderMyBoard, 100);
        }
    </script>
  </body>
</html>
