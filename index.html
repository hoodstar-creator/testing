<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>í•™ìŠµ ì¥ì†Œ í˜„í™©íŒ</title>
    
    <link rel="stylesheet" crossorigin href="./index-D-SKl4xE.css">
    <script type="module" crossorigin src="./script.js"></script>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <style>
      /* [1. ëˆˆ ë‚´ë¦¬ëŠ” íš¨ê³¼] */
      #snow-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; pointer-events: none; }

      /* [2. í™”ë©´ ì •ë¦¬] */
      .form, .notice, .aside-announcement, ul.notice-ul:not(#my-custom-list) { display: none !important; }

      /* [3. ì»¤ìŠ¤í…€ ì¼ì •í‘œ] */
      #my-dashboard-container { text-align: center; margin-top: 15px; margin-bottom: 20px; animation: fadeIn 0.8s ease; position: relative; z-index: 1; }
      .my-title { font-weight: 700; font-size: 1.8rem; color: var(--text); display: block; margin-bottom: 10px; }
      .my-dday-badge { font-size: 1.5rem; font-weight: 800; color: #ff6b6b; background: rgba(255, 107, 107, 0.15); padding: 5px 15px; border-radius: 50px; display: inline-block; margin-bottom: 15px; }
      #my-custom-list { display: flex !important; flex-direction: column; gap: 10px; z-index: 1; position: relative; }

      /* [4. íŒì—…ì°½ ë””ìì¸ (ë¶„ë¦¬í˜•)] */
      .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 10000; display: flex; align-items: center; justify-content: center; gap: 40px; backdrop-filter: blur(8px); }
      .window-reason, .window-project { background: #181a1f; border: 1px solid #333; border-radius: 16px; padding: 25px; display: flex; flex-direction: column; }
      .window-reason { width: 420px; z-index: 2; }
      .window-project { width: 380px; height: 550px; z-index: 1; }
      @media (max-width: 900px) { .modal-overlay { flex-direction: column; overflow-y: auto; } .window-reason, .window-project { width: 100%; max-width: 500px; height: auto; } .window-project { height: 350px; } }
      .window-title { color: #fff; margin: 0 0 20px 0; font-size: 1.4rem; font-weight: 700; padding-bottom: 15px; border-bottom: 1px solid #333; text-align: center; }
      .modal-input { width: 100%; padding: 16px; border-radius: 10px; border: 1px solid #444; background: #22252b; color: white; font-size: 1.1rem; outline: none; box-sizing: border-box; }
      .chip-container { display: flex; flex-wrap: wrap; gap: 8px; }
      .recent-reason-btn { background: #2a2d35; border: 1px solid #444; color: #ccc; padding: 8px 14px; border-radius: 20px; font-size: 0.9rem; cursor: pointer; }
      .table-container { flex-grow: 1; overflow-y: auto; border: 1px solid #333; border-radius: 10px; background: #131519; }
      .project-table { width: 100%; border-collapse: collapse; text-align: center; font-size: 0.95rem; }
      .project-table th { background: #22252b; color: #ccc; padding: 14px; border-bottom: 1px solid #444; position: sticky; top: 0; z-index: 10; }
      .project-table td { border-bottom: 1px solid #2a2d35; padding: 10px; color: #aaa; }
      .table-select-btn { background: #2563eb; color: white; border: none; padding: 8px 0; border-radius: 6px; cursor: pointer; width: 90%; }
      .modal-buttons { display: flex; justify-content: flex-end; gap: 12px; margin-top: auto; padding-top: 25px; }
      .modal-btn { padding: 12px 30px; border-radius: 10px; border: none; cursor: pointer; font-weight: 700; font-size: 1rem; }
      .modal-btn.cancel { background: #2a2d35; color: #ccc; border: 1px solid #444; }
      .modal-btn.save { background: #2563eb; color: white; }

      /* [5. â˜…ëª¨ë°”ì¼ ë¦¬ëª¨ì»¨ ì „ìš© ë””ìì¸â˜…] */
      body.mobile-mode { background: #121212; color: white; font-family: sans-serif; height: 100vh; overflow: hidden; }
      body.mobile-mode #app, body.mobile-mode #snow-canvas { display: none !important; } /* ëª¨ë°”ì¼ì—ì„œëŠ” PCí™”ë©´ ìˆ¨ê¹€ */
      
      .mobile-wrapper { display: none; height: 100%; flex-direction: column; padding: 20px; box-sizing: border-box; justify-content: center; max-width: 500px; margin: 0 auto; }
      .mobile-title { text-align: center; font-size: 1.5rem; margin-bottom: 30px; color: #fff; }
      .input-group { margin-bottom: 15px; }
      .input-group input { width: 100%; padding: 15px; border-radius: 12px; border: 1px solid #333; background: #1e1e1e; color: white; font-size: 1.2rem; box-sizing: border-box; }
      .big-btn { width: 100%; padding: 16px; border-radius: 12px; border: none; font-size: 1.2rem; font-weight: bold; cursor: pointer; margin-bottom: 10px; background: #2563eb; color: white; transition: 0.2s; }
      .big-btn:active { transform: scale(0.96); }
      .control-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; flex-grow: 1; }
      .grid-btn { background: #333; border: none; border-radius: 12px; color: white; font-size: 1rem; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; }
      .grid-btn:active { background: #555; }
      .status-badge { text-align: center; margin-bottom: 20px; padding: 10px; background: #222; border-radius: 8px; color: #aaa; font-size: 0.9rem; }
      
      /* ì—°ê²° ID í‘œì‹œ (PCí™”ë©´ ì¢Œì¸¡ í•˜ë‹¨) */
      #connection-code-display {
          position: fixed; bottom: 20px; left: 20px; 
          background: rgba(0,0,0,0.7); color: #fff; 
          padding: 15px; border-radius: 10px; z-index: 99999;
          font-family: monospace; border: 1px solid #444;
      }
      #connection-code-display h4 { margin: 0 0 5px 0; color: #5ac4ff; font-size: 0.9rem; }
      #my-peer-id { font-size: 1.5rem; font-weight: bold; letter-spacing: 2px; }
    </style>
  </head>
  <body>
    <canvas id="snow-canvas"></canvas>
    <div id="app"></div>

    <div id="connection-code-display" style="display: none;">
        <h4>ğŸ“± ë¦¬ëª¨ì»¨ ì—°ê²° ì½”ë“œ</h4>
        <div id="my-peer-id">ì—°ê²° ì¤‘...</div>
    </div>

    <div id="mobile-login" class="mobile-wrapper">
        <h2 class="mobile-title">ğŸ”— ë¦¬ëª¨ì»¨ ì—°ê²°</h2>
        <div class="input-group">
            <input type="text" id="conn-id-input" placeholder="PC í™”ë©´ì˜ ì½”ë“œ ì…ë ¥ (ì˜ˆ: 1234)" style="text-align:center; letter-spacing: 2px;">
        </div>
        <div class="input-group">
            <input type="tel" id="user-phone-input" placeholder="ë‚´ ì „í™”ë²ˆí˜¸ ë’·ìë¦¬" style="text-align:center;" maxlength="4">
        </div>
        <button id="connect-btn" class="big-btn">ì—°ê²°í•˜ê¸°</button>
    </div>

    <div id="mobile-control" class="mobile-wrapper">
        <h2 class="mobile-title"><span id="mobile-username">í•™ìƒ</span>ë‹˜</h2>
        <div class="status-badge" id="conn-status">ğŸŸ¢ ì—°ê²°ë¨</div>
        
        <div class="control-grid">
            <button class="grid-btn" onclick="sendMove('room')">ğŸ«<br>êµì‹¤ ë³µê·€</button>
            <button class="grid-btn" onclick="sendMove('toilet')">ğŸš½<br>í™”ì¥ì‹¤</button>
            <button class="grid-btn" onclick="sendMove('water')">ğŸ’§<br>ì‹ìˆ˜</button>
            <button class="grid-btn" onclick="sendMove('health')">ğŸ’Š<br>ë³´ê±´ì‹¤</button>
            <button class="grid-btn" onclick="sendMove('mood')">âœ¨<br>ê¸°ë¶„ì „í™˜</button>
            <button class="grid-btn" onclick="sendMove('tutor')">ğŸ§‘â€ğŸ«<br>êµë¬´ì‹¤</button>
        </div>
        
        <div style="margin-top: 15px;">
            <input type="text" id="mobile-etc-reason" placeholder="ê¸°íƒ€ ì‚¬ìœ  ì…ë ¥" style="width:100%; padding:12px; border-radius:8px; border:none; margin-bottom:10px;">
            <button class="big-btn" onclick="sendMove('etc')" style="background:#444;">ê¸°íƒ€ ì´ë™</button>
        </div>
    </div>

    <div id="custom-modal-overlay" class="modal-overlay" style="display: none;">
        <div class="window-reason">
            <h3 class="window-title">ê¸°íƒ€ ì´ë™ ì‚¬ìœ </h3>
            <p class="section-title">ğŸ“ ì§ì ‘ ì…ë ¥ / ìµœê·¼ ì‚¬ìœ </p>
            <div class="input-wrapper"><input type="text" id="custom-reason-input" class="modal-input" placeholder="ì‚¬ìœ  ì…ë ¥" autocomplete="off"></div>
            <div id="recent-reasons-container" style="display: none;"><div id="recent-reasons-list" class="chip-container"></div></div>
            <div class="modal-buttons"><button id="modal-btn-cancel" class="modal-btn cancel">ì·¨ì†Œ</button><button id="modal-btn-save" class="modal-btn save">í™•ì¸</button></div>
        </div>
        <div class="window-project">
            <h3 class="window-title">ğŸ¢ í”„ë¡œì íŠ¸ì‹¤ ëª©ë¡</h3>
            <div class="table-container">
                <table class="project-table"><thead><tr><th width="35%">ìœ„ì¹˜</th><th width="65%">ëª…ì¹­</th></tr></thead><tbody id="project-table-body"></tbody></table>
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        // [ì„¤ì •] í•™ìƒ ëª…ë¶€ (ë²ˆí˜¸ 4ìë¦¬ : ì´ë¦„)
        // ============================================================
        const USER_DB = {
            "1234": "í™ê¸¸ë™",
            "5678": "ê¹€ì² ìˆ˜",
            "0000": "ì´ì˜í¬",
            "1111": "ë„í‹°"
        };
        // ============================================================

        // URL í™•ì¸: ëª¨ë°”ì¼ ëª¨ë“œì¸ì§€ PC ëª¨ë“œì¸ì§€
        const urlParams = new URLSearchParams(window.location.search);
        const isMobile = urlParams.get('mode') === 'mobile';

        // P2P í†µì‹ ìš© ë³€ìˆ˜
        let peer = null;
        let conn = null;

        // [A] ëª¨ë°”ì¼ ë¦¬ëª¨ì»¨ ë¡œì§
        if (isMobile) {
            document.body.classList.add('mobile-mode');
            document.getElementById('mobile-login').style.display = 'flex';

            // 1. PeerJS ì´ˆê¸°í™”
            peer = new Peer(); 

            // 2. ì—°ê²° ë²„íŠ¼ í´ë¦­ ì‹œ
            document.getElementById('connect-btn').onclick = () => {
                const targetId = document.getElementById('conn-id-input').value.trim();
                const userPhone = document.getElementById('user-phone-input').value.trim();
                
                if (!targetId || !userPhone) return alert("ì½”ë“œì™€ ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                const userName = USER_DB[userPhone];
                if (!userName) return alert("ë“±ë¡ë˜ì§€ ì•Šì€ ë²ˆí˜¸ì…ë‹ˆë‹¤.");

                // PCë¡œ ì—°ê²° ì‹œë„
                conn = peer.connect("dimiboard-" + targetId);

                conn.on('open', () => {
                    document.getElementById('mobile-login').style.display = 'none';
                    document.getElementById('mobile-control').style.display = 'flex';
                    document.getElementById('mobile-username').innerText = userName;
                    // ì—°ê²° ì„±ê³µ ì‹œ ë‚´ ì´ë¦„ ì „ì†¡ (ì¸ì‚¬)
                    conn.send({ type: 'login', name: userName });
                });

                conn.on('error', (err) => alert("ì—°ê²° ì‹¤íŒ¨: ì½”ë“œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."));
            };

            // 3. ì´ë™ ëª…ë ¹ ì „ì†¡
            window.sendMove = function(target) {
                if (!conn) return alert("ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.");
                const userName = document.getElementById('mobile-username').innerText;
                let reason = "";
                
                if (target === 'etc') {
                    reason = document.getElementById('mobile-etc-reason').value;
                    if (!reason) return alert("ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                }

                conn.send({
                    type: 'move',
                    name: userName,
                    target: target,
                    reason: reason
                });
                alert("ì „ì†¡ ì™„ë£Œ!");
            };

        } 
        // [B] PC í˜„í™©íŒ ë¡œì§
        else {
            // 1. ëœë¤ ì ‘ì† ì½”ë“œ ìƒì„± (1000 ~ 9999)
            const roomCode = Math.floor(1000 + Math.random() * 9000);
            
            // 2. PeerJS ì´ˆê¸°í™” (IDë¥¼ ê³ ì •: dimiboard-ìˆ«ì)
            peer = new Peer("dimiboard-" + roomCode);

            peer.on('open', (id) => {
                // í™”ë©´ ì¢Œì¸¡ í•˜ë‹¨ì— ì½”ë“œ í‘œì‹œ
                document.getElementById('connection-code-display').style.display = 'block';
                document.getElementById('my-peer-id').innerText = roomCode;
            });

            // 3. í°ì—ì„œ ì—°ê²°ì´ ì™”ì„ ë•Œ
            peer.on('connection', (connection) => {
                connection.on('data', (data) => {
                    if (data.type === 'move') {
                        // ìì„ ì´ë™ ì‹¤í–‰!
                        moveMagnetByName(data.name, data.target, data.reason);
                    }
                });
            });

            // ìì„ ì´ë™ í•¨ìˆ˜ (ê¸°ì¡´ ë¡œì§ í™œìš©)
            function moveMagnetByName(name, targetLane, reason) {
                const chips = document.querySelectorAll('.chip');
                let targetChip = null;
                chips.forEach(chip => { if (chip.innerText.includes(name)) targetChip = chip; });

                if (targetChip) {
                    const targetContainer = document.querySelector(`div[data-lane="${targetLane}"]`);
                    // ë³´í†µ .lane ì•ˆì˜ ë‘ë²ˆì§¸ div(ë‚´ìš©ë¬¼) í˜¹ì€ .lane ìì²´
                    const dest = targetContainer ? (targetContainer.querySelector('div:last-child') || targetContainer) : null;
                    
                    if (dest) {
                        dest.appendChild(targetChip);
                        
                        // ê¸°íƒ€ ì‚¬ìœ  ì²˜ë¦¬ (ì‹œê°ì )
                        let reasonSpan = targetChip.querySelector('.reason-tag');
                        if (targetLane === 'etc' && reason) {
                            if (!reasonSpan) {
                                reasonSpan = document.createElement('span');
                                reasonSpan.className = 'reason-tag';
                                reasonSpan.style.fontSize = '0.7rem'; 
                                reasonSpan.style.color = '#aaa'; 
                                reasonSpan.style.display = 'block';
                                targetChip.appendChild(reasonSpan);
                            }
                            reasonSpan.innerText = reason;
                        } else {
                            if (reasonSpan) reasonSpan.remove();
                        }
                    }
                }
            }
        }

        // ============================================================
        // ê¸°ì¡´ ê¸°ëŠ¥ë“¤ (ëˆˆ, ì¼ì •í‘œ, íŒì—… ë“±)
        // ============================================================
        (function() { // ëˆˆ ë‚´ë¦¬ëŠ” íš¨ê³¼
            if(isMobile) return; // ëª¨ë°”ì¼ì€ ëˆˆ ì•ˆ ë‚´ë¦¼ (ì„±ëŠ¥ ìµœì í™”)
            const canvas = document.getElementById('snow-canvas');
            const ctx = canvas.getContext('2d');
            let width = window.innerWidth, height = window.innerHeight;
            canvas.width = width; canvas.height = height;
            const flakes = []; const maxFlakes = 100; let accumulationHeight = 0;
            function Flake() { this.x=Math.random()*width; this.y=Math.random()*-height; this.r=Math.random()*2+1; this.s=Math.random()*1+0.5; this.o=Math.random()*0.5+0.3; }
            for(let i=0;i<maxFlakes;i++) flakes.push(new Flake());
            function draw() {
                ctx.clearRect(0,0,width,height);
                if(accumulationHeight>0){ const g=ctx.createLinearGradient(0,height,0,height-accumulationHeight); g.addColorStop(0,'rgba(255,255,255,0.3)'); g.addColorStop(1,'rgba(255,255,255,0)'); ctx.fillStyle=g; ctx.fillRect(0,height-accumulationHeight,width,accumulationHeight); }
                ctx.fillStyle='rgba(255,255,255,0.8)'; ctx.beginPath();
                flakes.forEach(f=>{ ctx.globalAlpha=f.o; ctx.moveTo(f.x,f.y); ctx.arc(f.x,f.y,f.r,0,Math.PI*2); f.y+=f.s; if(f.y>height){ if(accumulationHeight<30&&Math.random()>0.98)accumulationHeight+=0.1; f.y=-5; f.x=Math.random()*width; } });
                ctx.fill(); requestAnimationFrame(draw);
            }
            window.addEventListener('resize',()=>{ width=window.innerWidth; height=window.innerHeight; canvas.width=width; canvas.height=height; }); draw();
        })();

        // ì¼ì •í‘œ ë° íŒì—… ë¡œì§ì€ PC ëª¨ë“œì—ì„œë§Œ ì‹¤í–‰
        if (!isMobile) {
            const MY_TITLE="1ì°¨ ì§€í•„í‰ê°€"; const D_DAY_DATE="2024-12-16"; 
            const MY_SCHEDULES=[{subject:'ìˆ˜í•™',content:'ì‚¼ê°í•¨ìˆ˜ ~ ìˆ˜ì—´',color:'c-red'},{subject:'ì˜ì–´',content:'ìˆ˜ëŠ¥íŠ¹ê°• 3ê°•, 4ê°•',color:'c-blue'},{subject:'êµ­ì–´',content:'ë¬¸í•™ ì‘í’ˆ ë¶„ì„',color:'c-green'},{subject:'ì •ë³´',content:'íŒŒì´ì¬ ìˆ˜í–‰í‰ê°€',color:'c-yellow'}];
            function calculateDDay(t){const d=new Date(t);const n=new Date();d.setHours(0,0,0,0);n.setHours(0,0,0,0);const x=Math.ceil((d-n)/864e5);return x===0?"D-Day":x>0?"D-"+x:"D+"+Math.abs(x);}
            function renderMyBoard(){
                const aside=document.querySelector('aside'); if(!aside)return;
                const ori=aside.querySelector('.notice'); if(ori)ori.style.display='none';
                if(!document.getElementById('my-dashboard-container')){
                    const c=document.createElement('div'); c.id='my-dashboard-container';
                    const u=document.createElement('ul'); u.id='my-custom-list'; u.className='notice-ul';
                    const s=aside.querySelector('div'); if(s){aside.appendChild(c);aside.appendChild(u);}
                }
                const c=document.getElementById('my-dashboard-container');
                const h=`<span class="my-title">${MY_TITLE}</span><span class="my-dday-badge">${calculateDDay(D_DAY_DATE)}</span>`;
                if(c.innerHTML!==h)c.innerHTML=h;
                const u=document.getElementById('my-custom-list');
                const l=MY_SCHEDULES.map(i=>`<li class="${i.color}"><span class="type-tag">${i.subject}</span><span>${i.content}</span></li>`).join('');
                if(u.innerHTML!==l)u.innerHTML=l;
            }
            setInterval(renderMyBoard,100);

            // íŒì—… ë¡œì§ (window.openEtcModal)ì€ ë„ˆë¬´ ê¸¸ì–´ì„œ ìƒëµí•˜ë‚˜, ì´ì „ì— ë“œë¦° ì½”ë“œê°€ ìˆë‹¤ë©´ ì—¬ê¸°ì— í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
            // (ì§€ë©´ìƒ ìƒëµí–ˆì§€ë§Œ, ê¸°ì¡´ íŒì—… ë¡œì§ë„ ê·¸ëŒ€ë¡œ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì‹œë©´ ë©ë‹ˆë‹¤.)
        }
    </script>
  </body>
</html>
