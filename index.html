<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>í•™ìŠµ ì¥ì†Œ í˜„í™©íŒ</title>
    
    <link rel="stylesheet" crossorigin href="./style.css">
    <script type="module" crossorigin src="./script.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
      /* [1. ê¸°ë³¸ ì„¤ì • ë° íš¨ê³¼] */
      #snow-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9998; pointer-events: none; }
      .form, .notice, .aside-announcement, ul.notice-ul { display: none !important; }

      /* [2. 'ë”ë³´ê¸°' ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼] */
      #advanced-features-container {
          margin-top: 15px; margin-bottom: 20px; padding: 12px;
          background: rgba(30, 32, 37, 0.8) !important; border-radius: 12px;
          border: 1px solid #444; animation: fadeIn 0.8s ease;
      }
      .feature-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 5px; color: #ffffff !important; font-weight: 700; user-select: none; }
      .feature-list { display: none; flex-direction: column; gap: 8px; margin-top: 12px; }
      .feature-list.active { display: flex; }
      
      .weather-box { background: rgba(255, 255, 255, 0.05); padding: 10px; border-radius: 8px; display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 5px; font-size: 0.85rem; color: #ddd; border: 1px solid #444; }
      .feature-btn { background: #2a2d35 !important; border: 1px solid #444 !important; color: #ffffff !important; padding: 10px; border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 8px; }
      .feature-btn:hover { background: #333 !important; border-color: #666 !important; }

      /* ëˆˆ ë‚´ë¦¬ê¸° ìŠ¤ìœ„ì¹˜ */
      .switch { position: relative; display: inline-block; width: 34px; height: 18px; margin-left: auto; }
      .switch input { opacity: 0; width: 0; height: 0; }
      .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; transition: .4s; border-radius: 20px; }
      .slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
      input:checked + .slider { background-color: #2563eb; }
      input:checked + .slider:before { transform: translateX(16px); }

      /* BGM ë¦¬ìŠ¤íŠ¸ */
      #inline-bgm-container { display: none; margin-top: 5px; background: #15171c !important; border-radius: 8px; border: 1px solid #444; overflow: hidden; max-height: 180px; overflow-y: auto; }
      #inline-bgm-container.active { display: block !important; }
      .inline-bgm-item { display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid #222; cursor: pointer; }
      .inline-bgm-item:hover { background: #252830; }
      .inline-bgm-cover { width: 30px; height: 30px; border-radius: 4px; object-fit: cover; }
      .inline-bgm-title { font-size: 0.8rem; font-weight: bold; color: #fff; }

      /* [3. ë¯¸ë‹ˆ í”Œë ˆì´ì–´ - í¬ê¸° í™•ëŒ€] */
      #mini-player {
          position: fixed; bottom: 30px; left: 30px; z-index: 10000;
          display: flex; align-items: center; gap: 15px;
          background: rgba(15, 17, 21, 0.95); padding: 12px 22px 12px 12px;
          border-radius: 60px; border: 1px solid #444;
          box-shadow: 0 10px 30px rgba(0,0,0,0.8); backdrop-filter: blur(10px);
          transition: all 0.4s; width: auto; min-width: 220px; cursor: pointer; transform: translateY(150%);
      }
      #mini-player.active { transform: translateY(0); }
      #mini-player.expanded { border-radius: 25px; padding: 25px; flex-direction: column; max-width: 220px; bottom: 40px; left: 40px; }
      .vinyl-record { width: 55px; height: 55px; border-radius: 50%; background-size: cover; background-position: center; border: 3px solid #222; animation: spin 4s linear infinite; animation-play-state: paused; transition: 0.4s; box-shadow: 0 0 15px rgba(0,0,0,0.5); }
      #mini-player.expanded .vinyl-record { width: 140px; height: 140px; margin-bottom: 15px; }
      .vinyl-record.playing { animation-play-state: running; }
      @keyframes spin { 100% { transform: rotate(360deg); } }
      .player-info { color: white; display: flex; flex-direction: column; gap: 5px; }
      #mini-player.expanded .player-info { text-align: center; align-items: center; }
      .player-title { font-size: 0.9rem; font-weight: bold; max-width: 140px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      .player-ctrl-box { display: flex; gap: 20px; align-items: center; }
      .ctrl-btn { background: none; border: none; color: #ccc; cursor: pointer; font-size: 1.3rem; transition: 0.2s; }
      .ctrl-btn:hover { color: #5ac4ff; }

      /* [4. ì‹œê°„í‘œ & ê¸‰ì‹ ëª¨ë‹¬ - ì •ë ¬ ìˆ˜ì •] */
      .modal-overlay { position: fixed !important; top: 0 !important; left: 0 !important; width: 100% !important; height: 100% !important; background: rgba(0, 0, 0, 0.85) !important; z-index: 20000 !important; display: none; align-items: center !important; justify-content: center !important; backdrop-filter: blur(5px) !important; }
      .modal-window { background: #1e2025 !important; border: 1px solid #333 !important; border-radius: 16px !important; padding: 30px !important; box-shadow: 0 20px 50px rgba(0,0,0,0.6) !important; display: flex !important; flex-direction: column !important; max-width: 650px; width: 90% !important; }
      
      /* ì‹œê°„í‘œ í…Œì´ë¸” ì •ë ¬ í•µì‹¬ CSS */
      .timetable-table { 
          width: 100% !important; border-collapse: collapse !important; margin-top: 20px !important; 
          color: #eee !important; text-align: center !important; table-layout: fixed !important; /* ëª¨ë“  ì¹¸ ë„ˆë¹„ ë™ì¼í•˜ê²Œ */
      }
      .timetable-table th { background: #2a2d35 !important; padding: 12px 5px !important; border: 1px solid #444 !important; color: #5ac4ff !important; font-size: 0.9rem; }
      .timetable-table td { padding: 12px 5px !important; border: 1px solid #333 !important; background: #15171c !important; font-size: 0.85rem; height: 45px; overflow: hidden; text-overflow: ellipsis; }

      /* [5. ê¸°íƒ€ ì‚¬ìœ  ë…ë¦½ ë ˆì´ì•„ì›ƒ ë³µêµ¬] */
      .etc-overlay { position: fixed !important; top: 0 !important; left: 0 !important; width: 100% !important; height: 100% !important; background: rgba(0, 0, 0, 0.8) !important; z-index: 15000 !important; display: none; align-items: center !important; justify-content: center !important; gap: 40px !important; backdrop-filter: blur(5px) !important; animation: fadeIn 0.2s ease; }
      .window-reason, .window-project { background: #1e2025 !important; border: 1px solid #333 !important; border-radius: 12px !important; padding: 25px !important; box-shadow: 0 20px 50px rgba(0,0,0,0.6) !important; display: flex !important; flex-direction: column !important; max-height: 85vh !important; }
      .window-reason { width: 420px !important; } .window-project { width: 380px !important; height: 520px !important; }
      .window-title { color: #fff !important; margin: 0 0 20px 0 !important; font-size: 1.3rem !important; font-weight: 700 !important; border-bottom: 1px solid #333 !important; padding-bottom: 15px !important; text-align: center !important; }
      .modal-input { width: 100% !important; padding: 14px !important; border-radius: 8px !important; border: 1px solid #444 !important; background: #2a2d35 !important; color: white !important; font-size: 1.1rem !important; outline: none !important; box-sizing: border-box !important; }
      .chip-container { display: flex !important; flex-wrap: wrap !important; gap: 10px !important; margin-top: 20px !important; }
      .recent-reason-btn { background: rgba(255, 255, 255, 0.08) !important; border: 1px solid rgba(255, 255, 255, 0.1) !important; color: #eee !important; padding: 8px 14px !important; border-radius: 10px !important; font-size: 0.85rem !important; cursor: pointer !important; transition: 0.2s !important; backdrop-filter: blur(5px) !important; }
      .recent-reason-btn:hover { background: #2563eb !important; color: white !important; }
      .table-container { flex-grow: 1 !important; overflow-y: auto !important; border: 1px solid #333 !important; border-radius: 8px !important; background: #15171c !important; }
      .project-table { width: 100% !important; border-collapse: collapse !important; text-align: center !important; font-size: 0.9rem !important; color: #aaa !important; }
      .project-table th { background: #252830 !important; color: #ccc !important; padding: 12px !important; border-bottom: 1px solid #444 !important; position: sticky !important; top: 0 !important; }
      .project-table td { padding: 10px !important; border-bottom: 1px solid #222 !important; }
      .table-select-btn { background: #2563eb !important; color: white !important; border: none !important; padding: 8px 0 !important; border-radius: 6px !important; cursor: pointer !important; width: 90% !important; font-weight: 600 !important; }

      /* [6. ì°¨ë‹¨ íŒì—…] */
      #restriction-popup { position: fixed !important; top: 20px !important; left: 50% !important; transform: translateX(-50%) !important; z-index: 30000 !important; background: #ef4444 !important; color: white !important; padding: 15px 25px !important; border-radius: 12px !important; display: none; box-shadow: 0 10px 40px rgba(239, 68, 68, 0.4) !important; align-items: center !important; gap: 15px !important; animation: slideDown 0.4s ease; }
      .admin-input { width: 55px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.3); color: white; font-size: 0.8rem; padding: 4px; border-radius: 4px; outline: none; text-align: center; }

      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      @keyframes slideDown { from { top: -100px; } to { top: 20px; } }
    </style>
  </head>
  <body>
    <canvas id="snow-canvas"></canvas>
    <div id="app"></div>

    <div id="custom-modal-overlay" class="etc-overlay">
        <div class="window-reason">
            <h3 class="window-title">ê¸°íƒ€ ì´ë™ ì‚¬ìœ  ì…ë ¥</h3>
            <p style="color:#fff; font-size:0.9rem; margin-bottom:10px; font-weight:600;">ğŸ“ ì‚¬ìœ  ì…ë ¥</p>
            <input type="text" id="custom-reason-input" class="modal-input" placeholder="ì‚¬ìœ  ì§ì ‘ ì…ë ¥" autocomplete="off">
            <div id="recent-reasons-container" style="display: none;">
                <p style="color:#888; font-size:0.75rem; margin:20px 0 8px;">ìµœê·¼ ì‚¬ìœ </p>
                <div id="recent-reasons-list" class="chip-container"></div>
            </div>
            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:auto; padding-top:20px;">
                <button id="modal-btn-cancel" style="background:#333; color:#ccc; border:none; padding:12px 25px; border-radius:10px; cursor:pointer; font-weight:700;">ì·¨ì†Œ</button>
                <button id="modal-btn-save" style="background:#2563eb; color:white; border:none; padding:12px 25px; border-radius:10px; cursor:pointer; font-weight:700;">í™•ì¸</button>
            </div>
        </div>
        <div class="window-project">
            <h3 class="window-title">í”„ë¡œì íŠ¸ì‹¤ ëª©ë¡</h3>
            <div class="table-container"><table class="project-table"><thead><tr><th width="35%">ìœ„ì¹˜</th><th width="65%">ëª…ì¹­</th></tr></thead><tbody id="project-table-body"></tbody></table></div>
        </div>
    </div>

    <div id="timetableModal" class="modal-overlay">
        <div class="modal-window">
            <h2 style="color:white; margin:0 0 15px 0;"><i class="fas fa-calendar-alt"></i> í•™ê¸‰ ì‹œê°„í‘œ</h2>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <select id="gradeSelector" style="background:#2a2d35; color:#fff; border:1px solid #444; padding:5px; border-radius:6px;"></select>
                <select id="classSelector" style="background:#2a2d35; color:#fff; border:1px solid #444; padding:5px; border-radius:6px;"></select>
            </div>
            <div id="timetableContainer" style="max-height: 450px; overflow-y: auto;"></div>
            <button onclick="closeModal('timetableModal')" style="margin-top:20px; background:#333; color:white; border:none; padding:10px; border-radius:8px; cursor:pointer; font-weight:700;">ë‹«ê¸°</button>
        </div>
    </div>

    <div id="mealModal" class="modal-overlay">
        <div class="modal-window">
            <h2 style="color:white; margin:0 0 15px 0;"><i class="fas fa-utensils"></i> ì˜¤ëŠ˜ì˜ ì ì‹¬ê¸‰ì‹</h2>
            <div id="mealContainer" style="line-height:2.0; color:#ddd; text-align:center; font-size:1.1rem; background:#15171c; padding:25px; border-radius:12px;">ë¡œë”© ì¤‘...</div>
            <button onclick="closeModal('mealModal')" style="margin-top:20px; background:#333; color:white; border:none; padding:10px; border-radius:8px; cursor:pointer; font-weight:700;">ë‹«ê¸°</button>
        </div>
    </div>

    <div id="restriction-popup">
        <input type="password" id="admin-pw" class="admin-input" placeholder="PASS" maxlength="4">
        <div style="flex:1"><b style="display:block">ğŸš« ì¬ìƒ ë¶ˆê°€ ì‹œê°„</b><small id="restriction-msg"></small></div>
    </div>

    <div id="mini-player" onclick="toggleExpand(event)">
        <div id="mini-cover" class="vinyl-record"></div>
        <div class="player-info">
            <span id="mini-title" class="player-title">ë…¸ë˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</span>
            <div class="player-ctrl-box">
                <button class="ctrl-btn" onclick="handlePlayBtn(event)"><i id="play-icon" class="fas fa-play"></i></button>
                <button class="ctrl-btn" onclick="stopMusic(event)"><i class="fas fa-stop"></i></button>
            </div>
        </div>
        <audio id="bgm-audio"></audio>
    </div>

    <script>
        // [ì„¤ì • ë°ì´í„°]
        const MEAL_KEY = '819b209aef6e4bc6921421155d08c60f';
        const TIME_KEY = 'fb54814355634dc9b29c7bb7b7bd028c';
        const BGM_LIST = [
            { title: "Jane Doe (christmas)", cover: "./asset/IMG_0319.jpg", src: "./asset/Jane Doe.mp3" },
            { title: "ë…¸ë˜ ì‹ ì²­ë°›ì•„ìš”", cover: "https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?w=100", src: "./assets/piano.mp3" }
        ];
        const PROJECT_DATA = [
            { loc: "ë³¸ê´€3ì¸µ", name: "301í˜¸" }, { loc: "ë³¸ê´€3ì¸µ", name: "302í˜¸" }, { loc: "ë³¸ê´€3ì¸µ", name: "303í˜¸" }, { loc: "ë³¸ê´€3ì¸µ", name: "304í˜¸" }, { loc: "ë³¸ê´€3ì¸µ", name: "305í˜¸" }, { loc: "ë³¸ê´€3ì¸µ", name: "306í˜¸" }, { loc: "ë³¸ê´€3ì¸µ", name: "307í˜¸" },
            { loc: "ë³¸ê´€2ì¸µ", name: "201í˜¸" }, { loc: "ë³¸ê´€2ì¸µ", name: "202í˜¸" }, { loc: "ë³¸ê´€2ì¸µ", name: "203í˜¸" }, { loc: "ë³¸ê´€2ì¸µ", name: "íšŒê³„ì‹¤ë¬´ì‹¤" }, { loc: "ë³¸ê´€2ì¸µ", name: "ê´‘ê³ ì½˜í…ì¸ ì‹¤" },
            { loc: "ë³¸ê´€1ì¸µ", name: "ë¹„ì¦ˆì¿¨ì‹¤" }, { loc: "ë³¸ê´€1ì¸µ", name: "ë³´ê±´ì‹¤" },
            { loc: "ì‹ ê´€1ì¸µ", name: "ì„¸ë¯¸ë‚˜ì‹¤" }, { loc: "ì‹ ê´€1ì¸µ", name: "IoTì‹¤" }, { loc: "ì‹ ê´€1ì¸µ", name: "ì‹œì²­ê°ì‹¤" }, { loc: "ì‹ ê´€1ì¸µ", name: "íœ´ë¨¸ë…¸ì´ë“œì‹¤" }, { loc: "ì‹ ê´€1ì¸µ", name: "ITí”„ë¡œì íŠ¸ì‹¤" },
            { loc: "ì‹ ê´€2ì¸µ", name: "ë©€í‹°ë¯¸ë””ì–´ì‹¤" }, { loc: "ì‹ ê´€2ì¸µ", name: "í¬ë¦¬ì—ì´í„°ì‹¤" }, { loc: "ì‹ ê´€2ì¸µ", name: "ìŒì•…ì‹¤" },
            { loc: "ì‹ ê´€3ì¸µ", name: "3Dì‹¤" }, { loc: "ì‹ ê´€3ì¸µ", name: "ë¹…ë°ì´í„°ì‹¤" },
            { loc: "ê¸°ìˆ™ì‚¬", name: "í•™ë´‰ê´€/ìš°ì •í•™ì‚¬" }, { loc: "ê¸°ìˆ™ì‚¬", name: "ë¯¸ìˆ ì‹¤" }
        ];
        const ADMIN_PW = "1224";
        let bypassUntil = 0;
        let isSnowActive = true;

        // -----------------------------------------------------------
        // 1. ì‹œê°„í‘œ & ê¸‰ì‹ API (ì •ë ¬ ìµœì í™”)
        // -----------------------------------------------------------
        async function fetchMeal() {
            const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            try {
                const res = await fetch(`https://open.neis.go.kr/hub/mealServiceDietInfo?KEY=${MEAL_KEY}&Type=json&ATPT_OFCDC_SC_CODE=J10&SD_SCHUL_CODE=7530560&MLSV_YMD=${date}`);
                const data = await res.json();
                document.getElementById('mealContainer').innerHTML = data.mealServiceDietInfo ? data.mealServiceDietInfo[1].row[0].DDISH_NM.replace(/<br\/>/g, '<br>') : "ì˜¤ëŠ˜ì€ ê¸‰ì‹ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.";
            } catch (e) { document.getElementById('mealContainer').innerHTML = "ë¡œë“œ ì‹¤íŒ¨"; }
        }

        async function fetchTimetable() {
            const container = document.getElementById('timetableContainer');
            const grade = document.getElementById('gradeSelector').value;
            const classNum = document.getElementById('classSelector').value;
            const monday = new Date(); monday.setDate(monday.getDate() - (monday.getDay() || 7) + 1);
            const daysArr = []; for(let i=0; i<5; i++) { let d = new Date(monday); d.setDate(monday.getDate()+i); daysArr.push(d.getFullYear() + ('0'+(d.getMonth()+1)).slice(-2) + ('0'+d.getDate()).slice(-2)); }
            try {
                const requests = daysArr.map(d => fetch(`https://open.neis.go.kr/hub/hisTimetable?KEY=${TIME_KEY}&Type=json&ATPT_OFCDC_SC_CODE=J10&SD_SCHUL_CODE=7530560&GRADE=${grade}&CLASS_NM=${classNum}&ALL_TI_YMD=${d}`).then(r => r.json()));
                const results = await Promise.all(requests);
                const tableData = results.map(r => r.hisTimetable ? r.hisTimetable[1].row : []);
                
                let html = '<table class="timetable-table"><thead><tr><th style="width:15%">êµì‹œ</th><th>ì›”</th><th>í™”</th><th>ìˆ˜</th><th>ëª©</th><th>ê¸ˆ</th></tr></thead><tbody>';
                for(let p=1; p<=7; p++) {
                    html += `<tr><td style="font-weight:bold; color:#5ac4ff;">${p}</td>`;
                    for(let i=0; i<5; i++) { 
                        const subject = tableData[i].find(x=>x.PERIO==p)?.ITRT_CNTNT || '-';
                        html += `<td>${subject}</td>`; 
                    }
                    html += '</tr>';
                }
                container.innerHTML = html + '</tbody></table>';
            } catch(e) { container.innerHTML = "ì‹œê°„í‘œ ë¡œë“œ ì‹¤íŒ¨"; }
        }

        function openModal(id) {
            document.getElementById(id).style.display = 'flex';
            if (id === 'timetableModal') {
                const gs = document.getElementById('gradeSelector'); const cs = document.getElementById('classSelector');
                if(gs.options.length === 0) {
                    for(let i=1; i<=3; i++) gs.add(new Option(i+'í•™ë…„', i));
                    for(let i=1; i<=6; i++) cs.add(new Option(i+'ë°˜', i));
                    gs.value = localStorage.getItem('last_grade') || '1'; cs.value = localStorage.getItem('last_class') || '2';
                    gs.onchange = fetchTimetable; cs.onchange = fetchTimetable;
                }
                fetchTimetable();
            } else if (id === 'mealModal') fetchMeal();
        }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        // -----------------------------------------------------------
        // 2. BGM ë° ì¬ìƒ ë¡œì§ (ë²„ê·¸ ìˆ˜ì • ë²„ì „)
        // -----------------------------------------------------------
        const audio = document.getElementById('bgm-audio');
        let currentBgmData = null, isPlaying = false;

        function checkTime() {
            if (Date.now() < bypassUntil) return { restricted: false };
            const now = new Date(); const t = now.getHours() * 100 + now.getMinutes();
            const ranges = [{ s: 845, e: 1240, m: "ì˜¤ì „ ìˆ˜ì—…" }, { s: 1346, e: 1630, m: "ì˜¤í›„ ìˆ˜ì—…" }, { s: 1709, e: 1830, m: "ììŠµ ì‹œê°„" }, { s: 1946, e: 2110, m: "ì•¼ì 1íƒ€ì„" }, { s: 2129, e: 2300, m: "ì•¼ì 2íƒ€ì„" }];
            for (const r of ranges) if (t >= r.s && t <= r.e) return { restricted: true, msg: r.m };
            return { restricted: false };
        }

        function tryPlayMusic(bgm) {
            const check = checkTime(); if (check.restricted) return showRestriction(check.msg);
            currentBgmData = bgm; audio.src = bgm.src; audio.play(); isPlaying = true; updatePlayerUI();
        }

        function handlePlayBtn(e) {
            e.stopPropagation(); if (!currentBgmData) return alert("ë…¸ë˜ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”!");
            const check = checkTime(); if (!isPlaying && check.restricted) return showRestriction(check.msg);
            if(isPlaying) { audio.pause(); document.getElementById('mini-cover').classList.remove('playing'); document.getElementById('play-icon').className='fas fa-play'; }
            else { audio.play(); document.getElementById('mini-cover').classList.add('playing'); document.getElementById('play-icon').className='fas fa-pause'; }
            isPlaying = !isPlaying;
        }

        function updatePlayerUI() {
            document.getElementById('mini-player').classList.add('active');
            document.getElementById('mini-cover').style.backgroundImage = `url('${currentBgmData.cover}')`;
            document.getElementById('mini-cover').classList.add('playing');
            document.getElementById('mini-title').innerText = currentBgmData.title;
            document.getElementById('play-icon').className = 'fas fa-pause';
        }

        function stopMusic(e) { e.stopPropagation(); audio.pause(); document.getElementById('mini-player').classList.remove('active', 'expanded'); isPlaying = false; }
        function toggleExpand(e) { if (!e.target.closest('.ctrl-btn')) document.getElementById('mini-player').classList.toggle('expanded'); }
        function showRestriction(msg) { const p = document.getElementById('restriction-popup'); document.getElementById('restriction-msg').innerText = `${msg} ì‹œê°„ì…ë‹ˆë‹¤.`; p.style.display = 'flex'; setTimeout(() => { p.style.display = 'none'; }, 5000); }
        document.getElementById('admin-pw').oninput = function() { if (this.value === ADMIN_PW) { bypassUntil = Date.now() + 300000; this.value = ""; document.getElementById('restriction-popup').style.background = "#22c55e"; setTimeout(() => { document.getElementById('restriction-popup').style.display = 'none'; document.getElementById('restriction-popup').style.background = "#ef4444"; }, 1000); } };

        // -----------------------------------------------------------
        // 3. ë”ë³´ê¸° ì‚¬ì´ë“œë°”
        // -----------------------------------------------------------
        function toggleSnow(checked) { isSnowActive = checked; if(!checked) { const c=document.getElementById('snow-canvas'); const ctx=c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height); } }
        function renderFeatures() {
            const aside = document.querySelector('aside'); if(!aside) return;
            aside.querySelector('.notice') && (aside.querySelector('.notice').style.display = 'none');
            if(!document.getElementById('advanced-features-container')) {
                const div = document.createElement('div'); div.id = 'advanced-features-container';
                div.innerHTML = `<div class="feature-header" onclick="this.nextElementSibling.classList.toggle('active'); this.querySelector('i').classList.toggle('fa-chevron-right'); this.querySelector('i').classList.toggle('fa-chevron-down');"><span>âœ¨ ë”ë³´ê¸°</span><i class="fas fa-chevron-right"></i></div>
                    <div class="feature-list"><div class="weather-box"><i class="fas fa-cloud-sun" style="color:#5ac4ff"></i> ì•ˆì‚° <span style="font-weight:800;color:#fff">2.5Â°C</span> ë§‘ìŒ</div>
                        <div class="feature-btn" style="justify-content:space-between; cursor:default"><span>â„ï¸ ëˆˆ ë‚´ë¦¬ê¸°</span><label class="switch"><input type="checkbox" checked onchange="toggleSnow(this.checked)"><span class="slider"></span></label></div>
                        <button class="feature-btn" onclick="openModal('timetableModal')"><i class="fas fa-calendar-alt" style="color:#4ade80"></i> ì‹œê°„í‘œ</button>
                        <button class="feature-btn" onclick="openModal('mealModal')"><i class="fas fa-utensils" style="color:#fb923c"></i> ê¸‰ì‹</button>
                        <button class="feature-btn" onclick="document.getElementById('inline-bgm-container').classList.toggle('active')"><i class="fas fa-music"></i> BGM</button>
                        <div id="inline-bgm-container"></div></div>`;
                const stats = aside.querySelector('div'); stats ? aside.insertBefore(div, stats.nextSibling) : aside.appendChild(div);
                const bgmBox = document.getElementById('inline-bgm-container');
                BGM_LIST.forEach(bgm => {
                    const item = document.createElement('div'); item.className = 'inline-bgm-item';
                    item.innerHTML = `<img src="${bgm.cover}" class="inline-bgm-cover"><span class="inline-bgm-title">${bgm.title}</span>`;
                    item.onclick = (e) => { e.stopPropagation(); tryPlayMusic(bgm); }; bgmBox.appendChild(item);
                });
            }
        }
        setInterval(renderFeatures, 500);

        // -----------------------------------------------------------
        // 4. ê¸°íƒ€ ì‚¬ìœ  íŒì—… (ë…ë¦½ ë ˆì´ì•„ì›ƒ ë° ì‚¬ìœ  ë²„íŠ¼ ë””ìì¸)
        // -----------------------------------------------------------
        window.openEtcModal = function(name, lane, callback) {
            const overlay = document.getElementById('custom-modal-overlay');
            const input = document.getElementById('custom-reason-input');
            const tableBody = document.getElementById('project-table-body');
            const recentList = document.getElementById('recent-reasons-list');
            const recentContainer = document.getElementById('recent-reasons-container');

            overlay.style.display = 'flex'; input.value = ''; input.focus();
            tableBody.innerHTML = '';
            PROJECT_DATA.forEach(d => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td style="font-weight:bold; color:#aaa; padding:10px; border-bottom:1px solid #333;">${d.loc}</td><td style="border-bottom:1px solid #333;"><button class="table-select-btn">${d.name}</button></td>`;
                tr.querySelector('button').onclick = () => { input.value = `${d.loc} ${d.name}`; input.focus(); };
                tableBody.appendChild(tr);
            });

            const saved = JSON.parse(localStorage.getItem('my_recent_reasons') || '[]');
            const all = [...saved, 'ì¡°ê¸°ì…ì‹¤', 'ì™¸ì¶œ'];
            recentList.innerHTML = '';
            if(all.length > 0) {
                recentContainer.style.display = 'block';
                all.forEach(txt => {
                    const btn = document.createElement('button'); btn.className = 'recent-reason-btn'; btn.innerText = txt;
                    btn.onclick = () => { input.value = txt; input.focus(); }; recentList.appendChild(btn);
                });
            }

            document.getElementById('modal-btn-save').onclick = () => { 
                const val = input.value.trim();
                if(val) {
                    let list = JSON.parse(localStorage.getItem('my_recent_reasons') || '[]');
                    if(!list.includes(val) && !['ì¡°ê¸°ì…ì‹¤','ì™¸ì¶œ'].includes(val)) { list.unshift(val); if(list.length > 5) list.pop(); localStorage.setItem('my_recent_reasons', JSON.stringify(list)); }
                }
                overlay.style.display='none'; callback(val); 
            };
            document.getElementById('modal-btn-cancel').onclick = () => overlay.style.display='none';
        };

        // -----------------------------------------------------------
        // 5. ëˆˆ íš¨ê³¼
        // -----------------------------------------------------------
        (function() {
            const canvas = document.getElementById('snow-canvas'); const ctx = canvas.getContext('2d');
            let w = window.innerWidth, h = window.innerHeight; canvas.width = w; canvas.height = h;
            const flakes = []; let acc = 0;
            for(let i=0; i<100; i++) flakes.push({x:Math.random()*w, y:Math.random()*-h, r:Math.random()*2+1, s:Math.random()+0.5, o:Math.random()*0.5+0.3});
            function draw() {
                if(!isSnowActive) { requestAnimationFrame(draw); return; }
                ctx.clearRect(0,0,w,h);
                if(acc>0){ const g=ctx.createLinearGradient(0,h,0,h-acc); g.addColorStop(0,'rgba(255,255,255,0.4)'); g.addColorStop(1,'rgba(0,0,0,0)'); ctx.fillStyle=g; ctx.fillRect(0,h-acc,w,acc); }
                ctx.fillStyle='rgba(255,255,255,0.8)'; ctx.beginPath();
                flakes.forEach(f=>{ ctx.globalAlpha=f.o; ctx.moveTo(f.x,f.y); ctx.arc(f.x,f.y,f.r,0,Math.PI*2); f.y+=f.s; if(f.y>h){ if(acc<30 && Math.random()>0.99) acc+=0.05; f.y=-5; f.x=Math.random()*w; } });
                ctx.fill(); requestAnimationFrame(draw);
            }
            window.onresize = () => { w=window.innerWidth; h=window.innerHeight; canvas.width=w; canvas.height=h; }; draw();
        })();
    </script>
  </body>
</html>
